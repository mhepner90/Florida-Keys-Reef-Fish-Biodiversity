---
title: "hepner_et_al_2018"
author: "Megan Hepner"
date: "November 5, 2017"
output: html_document
---

Library's used to compute diversity indices, statistical test, and to produce plots 

```{r librarys}

library(AICcmodavg) #AIC
library(ade4) #mantel.rtest
library(ape) #read.tree, as.phylo 
library(clue) #cl_consensus, cl_ultrametric, cl_dissimilarity,cl_ultrametric
library(cowplot) #get_legend 
library(car) #recode
library(d3treeR) #d3treeR interactive traitmap
library(data.table) #setnames
library(dendextend)
library(devtools) #install_github
library(FD) #gowdis
library(fpc) #pamk
library(FSA) #dunnTest
library(ggplot2) #ggplot
library(grid)
library(gridExtra) #grid.arrange
library(htmlwidgets) #save interactive treemap and pie chart 
library(lattice)
library(magrittr) # %$%
library(MASS)# contains boxcox function
library(mgcv) #gam
library(moments) # contains skewness function
library(nortest) #checks for normality 
library(parallel) #clusterEvalQ,clusterExport,detectCores,makeCluster,parLapply
library(plotrix) #std.error
library(plotly) #plot_ly
library(psych) #pairs.panels 
library(purrr) #map
library(rcompanion) #cldList
library(readr) #saveRDS, read_rds, readRDS 
library(reshape2) #melt
#devtools::install_github('jeremiaheb/rvc')
library(rpsychi) #statistical tests using summary data
library(rvc) #getPSUAbundance, getStrataAbundance, getDomainAbundance 
library(tidyverse) #select, filter, mutate, group_by, summarize 
library(treemap) #treemap
library(vegan) #spec, diversity 
library(webshot) #screenshot of interactive treemap and pie chart

map = purrr::map # override maps::map
select = dplyr::select #override MASS::select 
group_by =  dplyr::group_by #override plotly::group_by
summarise = dplyr::summarise #override plotly::summarise
```

# Fetch abundance data 

Reef fish community data used in this study were collected as part of the multi-agency Reef Visual Census (RVC) [Brandt et al., 2009](https://www.coris.noaa.gov/activities/fish_monitoring_protocol/). Fish communities were visually surveyed underwater annually in the mainland FKNMS (Lower Keys, Middle Keys and Upper Keys) from 1999 to 2012, and biennially from 2012 to 2016.

The RVC uses a stationary point count method within a randomly selected 7.5 m radius circular plot with a 200m X 200m mapgrid from 1999 to 2012 and 100m x 100m map grid from 2014 to 2016 to optimize the observation of conspicuous and diurnally active reef fish, specifically economically and ecologically important reef fish species [Bohnsack and Bannerot, 1986](https://docs.lib.noaa.gov/noaa_documents/NMFS/TR_NMFS/TR_NMFS_41.pdf). 

Data was obtained using Jeremiah Blondeau's [RVC statistical package](https://github.com/jeremiaheb/rvc)

## Sample Data Variables
- PRIMARY_SAMPLE_UNIT: A code indicating the primary sample unit in which a sample was collected.
- YEAR: A number indicating the calendar year.
- MONTH: A number indicating the month of the year.
- DAY: A number indicating the day of the month (EST).
- STATION_NR: A number indicating the secondary sampling unit within a given primary sample unit.
- LAT_DEGREES: Latitude of secondary sampling unit in decimal degrees).
- LON_DEGREES: Longitude of secondary sampling unit in decimal degrees).
- DEPTH: Average depth, in meters, of secondary sampling unit).
- UNDERWATER_VISIBILITY: visibility, in meters, at secondary sampling unit.
- MAPGRID_NR: A number indicating the primary sample unit.  
- HABITAT_CD: A code indicating the habitat type. 
- ZONE_NR: A code indicating the distance offshore: 
+ 1 - Inshore
+ 2 - Midchannel
+ 3 - Offshore
+ 4 - Fore-reef
- SUBREGION_NR: A number indicating the subregion.
- MPA_NR: A number identifying the marine protected area in which the sample was collected. Zero indicates unprotected status)
- SPECIES_NR: A number indicating the species for a sample 
- SPECIES_CD: A code indicating the species for a sample. Consists of the first three letters of the generic name and the first four of the specific name   
- LEN: The length, in cm, of a sample.      
- NUM: The number of individuals of a given species and length observed in a secondary sampling unit
- TIME_SEEN: A number indicating when, during sampling, an individual was observed. 1: In the first five minutes, 2: From 5-10 minutes, 3: After 10 minutes. 
- PROT: A boolean value indicating whether a sample was in a protected area or not 
+ 1 - protected area
+ 0 - not protected 
- STRAT_GROUPED: A code indicating the stratum in which a sample was taken.   
+ FMLR
+ FSLR
+ HRRF
+ INPR
+ MCPR 
+ OFPR
- REGION: A code indicating the region in which a sample was taken.
+ FLA KEYS (florida keys)

```{r fetch abundance data}

if(!file.exists("psu_fk_abun.csv")){
  
  fk_data <- getRvcData(1999:2016, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/')
  
  spp_list<- fk_data$taxonomic_data$COMNAME #399 species 
  write_csv(spp_list, 'spp_list.csv')
  
  fk1999<- getRvcData(1999, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/')
  psu_abunfk1999 <- getPSUAbundance(fk1999, spp_list, merge_protected = F)
  write_csv(psu_abunfk1999, 'psu_abunfk1999.csv') #1999
  
  fk2000<- getRvcData(2000, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/')
  psu_abunfk2000 <- getPSUAbundance(fk2000, spp_list, merge_protected = F)  
  write_csv(psu_abunfk2000, 'psu_abunfk2000.csv') #2000
  
  fk2001<- getRvcData(2001, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/')
  psu_abunfk2001 <- getPSUAbundance(fk2001, spp_list, merge_protected = F) 
  write_csv(psu_abunfk2001, 'psu_abunfk2001.csv') #2001
  
  fk2002<- getRvcData(2002, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/')
  psu_abunfk2002 <- getPSUAbundance(fk2002, spp_list, merge_protected = F) 
  write_csv(psu_abunfk2002, 'psu_abunfk2002.csv') #2002
  
  fk2003<- getRvcData(2003, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/')
  psu_abunfk2003 <- getPSUAbundance(fk2003, spp_list, merge_protected = F) 
  write_csv(psu_abunfk2003, 'psu_abunfk2003.csv') #2003
  
  fk2004<- getRvcData(2004, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/')
  psu_abunfk2004 <- getPSUAbundance(fk2004, spp_list, merge_protected = F)
  write_csv(psu_abunfk2004, 'psu_abunfk2004.csv') #2004
  
  fk2005<- getRvcData(2005, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/') 
  psu_abunfk2005 <- getPSUAbundance(fk2005, spp_list, merge_protected = F) 
  write_csv(psu_abunfk2005, 'psu_abunfk2005.csv') #2005
  
  fk2006<- getRvcData(2006, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/') 
  psu_abunfk2006 <- getPSUAbundance(fk2006, spp_list, merge_protected = F) 
  write_csv(psu_abunfk2006, 'psu_abunfk2006.csv') #2006
  
  fk2007<- getRvcData(2007, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/') psu_abunfk2007 <- getPSUAbundance(fk2007, spp_list, merge_protected = F) 
  write_csv(psu_abunfk2007, 'psu_abunfk2007.csv') #2007
  
  fk2008<- getRvcData(2008, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/') psu_abunfk2008 <- getPSUAbundance(fk2008, spp_list, merge_protected = F) 
  write_csv(psu_abunfk2008, 'psu_abunfk2008.csv') #2008
  
  fk2009<- getRvcData(2009, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/')
  psu_abunfk2009 <- getPSUAbundance(fk2009, spp_list, merge_protected = F) 
  write_csv(psu_abunfk2009, 'abundance_psu/FK/psu_abunfk2009.csv') #2009 
  
  fk2010<- getRvcData(2010, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/')
  psu_abunfk2010 <- getPSUAbundance(fk2010, spp_list, merge_protected = F) 
  write_csv(psu_abunfk2010, 'abundance_psu/FK/psu_abunfk2010.csv') #2010
  
  fk2011<- getRvcData(2011, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/')
  psu_abunfk2011 <- getPSUAbundance(fk2011, spp_list, merge_protected = F) 
  write_csv(psu_abunfk2011, 'big_csv/abundance_psu/FK/psu_abunfk2011.csv') #2011
  
  fk2012<- getRvcData(2012, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/')
  psu_abunfk2012 <- getPSUAbundance(fk2012, spp_list, merge_protected = F)
  write_csv(psu_abunfk2012, 'abundance_psu/FK/psu_abunfk2012.csv') #2012
  
  fk2014<- getRvcData(2014, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/') 
  psu_abunfk2014 <- getPSUAbundance(fk2014, spp_list, merge_protected = F) 
  write_csv(psu_abunfk2014, 'abundance_psu/FK/psu_abunfk2014.csv') #2014
  
  fk2016<- getRvcData(2016, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/')
  psu_abunfk2016 <- getPSUAbundance(fk2016, spp_list, merge_protected = F) 
  write_csv(psu_abunfk2016, 'psu_abunfk2016.csv') #2016
  
  #Bind PSU abundance data from 1999 - 2016 in the Florida Keys into one csv file
  
  ##FK abundance psu 
  cat("bind all csv's\n") #concatenate and print - character string naming the file to print to
  d = data_frame()
  for (f in list.files('big_csv/abundance_psu/FK', pattern="*.csv", full.names=T)){
    cat(' ', f,'\n')
    d_f = read_csv(
      f, #path to a file 
      progress=F, #progress: Display a progress bar
      trim_ws=T, #trim_ws: leading and trailing whitespace are trimmed 
      col_types = cols(
        protected_status = col_character()))  #column specification - must contain one column specification for each column
    d = bind_rows(d, d_f)
    write_csv(d, 'psu_fk_abun.csv') 
  } else{
    psu_abundance = read_csv("psu_fk_abun.csv",
                             col_types = cols(protected_status = col_character()))
  }
}

```

# Fetch biomass data 

```{r fetch biomass data}

if(!file.exists("psu_bio_sum_rds")){
  
  fk1999<- getRvcData(1999, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/')
  psu_biofk1999 <- getPSUBiomass(fk1999, species = fk1999$taxonomic_data$SPECIES_CD, growth_parameters = fk1999$taxonomic_data, merge_protected = F)
  write_csv(psu_biofk1999, 'big_csv/biomass_psu/FK/psu_biofk1999.csv') #1999
  
  fk2000<- getRvcData(2000, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/')
  psu_biofk2000 <- getPSUBiomass(fk2000, species = fk2000$taxonomic_data$SPECIES_CD, growth_parameters = fk2000$taxonomic_data, merge_protected = F)
  write_csv(psu_biofk2000, 'big_csv/biomass_psu/FK/psu_biofk2000.csv') #2000
  
  fk2001<- getRvcData(2001, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/')
  psu_biofk2001 <- getPSUBiomass(fk2001, species = fk2001$taxonomic_data$SPECIES_CD, growth_parameters = fk2001$taxonomic_data, merge_protected = F)
  write_csv(psu_biofk2001, 'big_csv/biomass_psu/FK/psu_biofk2001.csv') #2001
  
  fk2002<- getRvcData(2002, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/')
  psu_biofk2002 <- getPSUBiomass(fk2002, species = fk2002$taxonomic_data$SPECIES_CD, growth_parameters = fk2002$taxonomic_data, merge_protected = F)
  write_csv(psu_biofk2002, 'big_csv/biomass_psu/FK/psu_biofk2002.csv') #2002
  
  fk2003<- getRvcData(2003, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/')
  psu_biofk2003 <- getPSUBiomass(fk2003, species = fk2003$taxonomic_data$SPECIES_CD, growth_parameters = fk2003$taxonomic_data, merge_protected = F)
  write_csv(psu_biofk2003, 'big_csv/biomass_psu/FK/psu_biofk2003.csv') #2003
  
  fk2004<- getRvcData(2004, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/')
  psu_biofk2004 <- getPSUBiomass(fk2004, species = fk2004$taxonomic_data$SPECIES_CD, growth_parameters = fk2004$taxonomic_data, merge_protected = F)
  write_csv(psu_biofk2004, 'big_csv/biomass_psu/FK/psu_biofk2004.csv') #2004
  
  fk2005<- getRvcData(2005, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/')
  psu_biofk2005 <- getPSUBiomass(fk2005, species = fk2005$taxonomic_data$SPECIES_CD, growth_parameters = fk2005$taxonomic_data, merge_protected = F)
  write_csv(psu_biofk2005, 'big_csv/biomass_psu/FK/psu_biofk2005.csv') #2005
  
  fk2006<- getRvcData(2006, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/')
  psu_biofk2006 <- getPSUBiomass(fk2006, species = fk2006$taxonomic_data$SPECIES_CD, growth_parameters = fk2006$taxonomic_data, merge_protected = F)
  write_csv(psu_biofk2006, 'big_csv/biomass_psu/FK/psu_biofk2006.csv') #2006
  
  fk2007<- getRvcData(2007, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/')
  psu_biofk2007 <- getPSUBiomass(fk2007, species = fk2007$taxonomic_data$SPECIES_CD, growth_parameters = fk2007$taxonomic_data, merge_protected = F)
  write_csv(psu_biofk2007, 'big_csv/biomass_psu/FK/psu_biofk2007.csv') #2007
  
  fk2008<- getRvcData(2008, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/')
  psu_biofk2008 <- getPSUBiomass(fk2008, species = fk2008$taxonomic_data$SPECIES_CD, growth_parameters = fk2008$taxonomic_data, merge_protected = F)
  write_csv(psu_biofk2008, 'big_csv/biomass_psu/FK/psu_biofk2008.csv') #2008
  
  fk2009<- getRvcData(2009, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/')
  psu_biofk2009 <- getPSUBiomass(fk2009, species = fk2009$taxonomic_data$SPECIES_CD, growth_parameters = fk2009$taxonomic_data, merge_protected = F)
  write_csv(psu_biofk2009, 'big_csv/biomass_psu/FK/psu_biofk2009.csv') #2009
  
  fk2010<- getRvcData(2010, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/')
  psu_biofk2010 <- getPSUBiomass(fk2010, species = fk2010$taxonomic_data$SPECIES_CD, growth_parameters = fk2010$taxonomic_data, merge_protected = F)
  write_csv(psu_biofk2010, 'big_csv/biomass_psu/FK/psu_biofk2010.csv') #2010
  
  fk2011<- getRvcData(2011, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/')
  psu_biofk2011 <- getPSUBiomass(fk2011, species = fk2011$taxonomic_data$SPECIES_CD, growth_parameters = fk2011$taxonomic_data, merge_protected = F)
  write_csv(psu_biofk2011, 'big_csv/biomass_psu/FK/psu_biofk2011.csv') #2011
  
  fk2012<- getRvcData(2012, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/')
  psu_biofk2012 <- getPSUBiomass(fk2012, species = fk2012$taxonomic_data$SPECIES_CD, growth_parameters = fk2012$taxonomic_data, merge_protected = F)
  write_csv(psu_biofk2012, 'big_csv/biomass_psu/FK/psu_biofk2012.csv') #2012
  
  fk2014<- getRvcData(2014, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/')
  psu_biofk2014 <- getPSUBiomass(fk2014, species = fk2014$taxonomic_data$SPECIES_CD, growth_parameters = fk2014$taxonomic_data, merge_protected = F)
  write_csv(psu_biofk2014, 'big_csv/biomass_psu/FK/psu_biofk2014.csv') #2014
  
  fk2016<- getRvcData(2016, "FLA KEYS", server = 'https://www.sefsc.noaa.gov/rvc_analysis20/')
  psu_biofk2016 <- getPSUBiomass(fk2016, species = fk2016$taxonomic_data$SPECIES_CD, growth_parameters = fk2016$taxonomic_data, merge_protected = F)
  write_csv(psu_biofk2016, 'big_csv/biomass_psu/FK/psu_biofk2016.csv') #2016
  
  ## FK biomass by psu
  cat("bind all csv's\n") #concatenate and print - character string naming the file to print to
  d_fk = data_frame()
  
  for (f in list.files('big_csv/biomass_psu/FK', pattern="\\.csv", full.names=T)){
    cat(' ', f,'\n')
    d_f = read_csv(
      f, #path to a file 
      progress=F, #progress: Display a progress bar
      trim_ws=T, #trim_ws: leading and trailing whitespace are trimmed 
      col_types = cols(
        protected_status = col_character()))  #column specification - must contain one column specification for each column
    d_fk = bind_rows(d_fk, d_f)
    
    write_csv(d_fk, 'big_csv/biomass_psu/psu_fk_biomass.csv')
  }else{ 
   #read in data 
    psu_fk_bio <- read_csv('psu_fk_biomass.csv',
                           col_types = cols( protected_status = col_character())) 
    #dim(psu_fk_bio) 3,429,476*10
  }
}

```

#Clean data 

Cleaned data by:
- removed sampling events with no individuals
- removed species not identified to species level 
- removed sampling events with uncharactertistically large abundance values 
- removed species that did not occur in at least 5% of the entire dateset

Left with 108 species of reef fish and 5,235 sampling events between 1999 and 2016 

```{r clean up data }

if(!file.exists("clean_data.csv", "clean_bio_data.csv")){
  #read in data 
  psu_abundance <- read_csv("psu_fk_abun.csv",
                            col_types = cols(protected_status = col_character()))
  #dim(psu_fk_abun) #3,643,306 x 10
  
  #remove species not identified in species level 
  clean_data = psu_abundance %>% 
    filter(stringr::str_detect(protected_status, 'all'))%>% #dim 1,821,653 x 10
    filter(!stringr::str_detect(SPECIES_CD, 'SPE\\.$'))%>% #348 species
    #dim(psu_abundance) 1,689,982x10
    filter(!abundance == "0")
  #dim(clean_data) 203,466     10
  
  #remove species that occured in less than 5% of PSU's (total of 5,234 sampling events between 1999-2016). Species must have occured at least 262 sampling events.
  remove_rare_sp = clean_data %>%
    mutate(presence_absence = 
             ifelse(abundance == 0, "0",
                    ifelse(abundance >0, "1", "IDK")))%>%
    group_by(SPECIES_CD)%>%
    summarise(
      occurance = sum(as.numeric(presence_absence)))%>%
    arrange(occurance)%>%
    filter(occurance > 261) #108 species 
  
  if(!file.exists('RVCdata_FK.rds')){
    RVCdata_FK = getRvcData(1999:2016, "FLA KEYS", server = "https://www.sefsc.noaa.gov/rvc_analysis20/")
  }else{
    RVCdata_FK = read_rds("RVCdata_FK.rds")
  }
  
  taxonimic_data = RVCdata_FK$taxonomic_data
  
  species_occured_5_percent_data = left_join(remove_rare_sp,taxonimic_data, by="SPECIES_CD")%>%
    select(SPECIES_CD,FAMILY,SCINAME,COMNAME)#108 x 4
  
  #remove species from abundance data didn't occur 5% of the sampling events 
  clean_data = inner_join(clean_data, species_occured_5_percent_data, by="SPECIES_CD") 
  #dim(clean_data) 192,916x13 (108 species)
  
  #remove PSU with only 1 species [2006,602U INPR] [2016,  1010U, INPR] and remove 2001 PSU 222U HRRF with abundance 5X greater than normal 
  clean_data = clean_data[!(clean_data$YEAR == "2006" & 
                              clean_data$PRIMARY_SAMPLE_UNIT == "602U" | #only 1 species
                              clean_data$YEAR == "2016" & 
                              clean_data$PRIMARY_SAMPLE_UNIT == "1010U"| #only 1 species 
                              clean_data$YEAR == "2002" &
                              clean_data$PRIMARY_SAMPLE_UNIT =="472U"  | #one large school sp.
                              clean_data$YEAR == "2003" &
                              clean_data$PRIMARY_SAMPLE_UNIT =="119U"  | #one large school sp. 
                              clean_data$YEAR == "2004" &
                              clean_data$PRIMARY_SAMPLE_UNIT =="403U"  | #one large school sp.
                              clean_data$YEAR == "2001" & 
                              clean_data$PRIMARY_SAMPLE_UNIT =="222U"),]
  #INPR_2002_472U - HYP HARR abundance 9999.5 
  #OFPR_2003_119U - DEC PUNC abundance 5000.0
  #MCPR_2004_403U - HYP HARR abundance 5000.0
  #FMLR_2001_222U - ATH STIP abundance 10,000.0 
  #dim(clean_data) 192,780 x 10
  
  write_csv(clean_data, "clean_data.csv")
  
  psu_abundance = clean_data %>% 
    group_by(YEAR, PRIMARY_SAMPLE_UNIT, STRAT_GROUPED) %>%
    summarize(abundance_sum = sum(abundance)) 
  #dim 5235*4 
  write_csv(psu_abundance, "psu_abundance.csv")

  clean_data = read_csv("clean_data.csv", 
                        col_types = cols(protected_status = col_character()))
  
  abundance_pie_chart = clean_data %>%
    dplyr::select(SPECIES_CD, COMNAME,abundance)%>%
    dplyr::group_by(COMNAME) %>% #SPECIES_CD
    dplyr::summarize(abundance_sum = sum(abundance)) %>%
    mutate(com_percent = (abundance_sum/sum(abundance_sum))*100) %>%
    mutate(com_percent=round(com_percent,2)) %>%
    arrange(desc(com_percent))
    
  abun_pie_chart = plot_ly(abundance_pie_chart, labels=~COMNAME, values =~com_percent, type="pie")
  pie = './htmlwidget_abunpie.html'
  saveWidget(abun_pie_chart, pie)
  
  species_abundance = clean_data %>% 
    group_by(FAMILY, SCINAME,COMNAME) %>%
    summarize(abundance_sum = sum(abundance)) %>%
    mutate(com_percent = (abundance_sum/1933987)*100) %>%
    arrange(desc(com_percent))
  
  #sum(species_abundance$abundance_sum) #1933987
  
  write_csv(species_abundance, "percent_species_abundance.csv")

#read in data 
    psu_fk_bio <- read_csv('psu_fk_biomass.csv',
                           col_types = cols( protected_status = col_character())) 
    #dim(psu_fk_bio) 3,429,476*10
    
    #remove species not identified in species level and protected status all   
    clean_bio = psu_fk_bio %>%
      filter(stringr::str_detect(protected_status, 'all')) %>% #1,714,738 
      filter(!stringr::str_detect(SPECIES_CD, 'SPE\\.$')) %>% #1609672 #326 species %>%
      #filter(!biomass ==0) #200,138 
      mutate(presence_absence = 
             ifelse(biomass == 0, "0",
                    ifelse(biomass >0, "1", "IDK")))%>%
      group_by(SPECIES_CD)%>%
      summarise(occurance = sum(as.numeric(presence_absence)))%>%
      arrange(occurance)%>%
      filter(occurance > 261) #107 species 
    
  species_occured_5_percent_data = left_join(clean_bio,taxonimic_data, by="SPECIES_CD")%>%
    select(SPECIES_CD,FAMILY,SCINAME,COMNAME)#107 x 4
  
  #remove species from abundance data didn't occur 5% of the sampling events 
  clean_bio_data = inner_join(psu_fk_bio, species_occured_5_percent_data, by="SPECIES_CD") 
  #dim(clean_data) 1121546 (107 species)
  
  #remove PSU with only 1 species [2006,602U INPR] [2016,  1010U, INPR] and remove 2001 PSU 222U HRRF with abundance 5X greater than normal 
  clean_bio_data = clean_bio_data[!(clean_bio_data$YEAR == "2006" & 
                              clean_bio_data$PRIMARY_SAMPLE_UNIT == "602U" | #only 1 species
                              clean_bio_data$YEAR == "2016" & 
                              clean_bio_data$PRIMARY_SAMPLE_UNIT == "1010U"| #only 1 species 
                              clean_bio_data$YEAR == "2002" &
                              clean_bio_data$PRIMARY_SAMPLE_UNIT =="472U"  | #one large school sp.
                              clean_bio_data$YEAR == "2003" &
                              clean_bio_data$PRIMARY_SAMPLE_UNIT =="119U"  | #one large school sp. 
                              clean_bio_data$YEAR == "2004" &
                              clean_bio_data$PRIMARY_SAMPLE_UNIT =="403U"  | #one large school sp.
                              clean_bio_data$YEAR == "2001" & 
                              clean_bio_data$PRIMARY_SAMPLE_UNIT =="222U"),]
  #INPR_2002_472U - HYP HARR abundance 9999.5 
  #OFPR_2003_119U - DEC PUNC abundance 5000.0
  #MCPR_2004_403U - HYP HARR abundance 5000.0
  #FMLR_2001_222U - ATH STIP abundance 10,000.0 
  #dim(clean_data) 192,780 x 10
  write_csv(clean_bio_data, "clean_bio_data.csv")
      
      psu_biomass = clean_bio_data %>% 
      group_by(YEAR, PRIMARY_SAMPLE_UNIT) %>% # 1120262      13
      summarize(biomass_sum = sum(biomass)) #5235    3
    #dim(psu_bio_sum) #5235    3
    
    write_csv(psu_biomass, "psu_bio.csv")

  species_biomass = clean_bio_data %>% 
    group_by(FAMILY, SCINAME,COMNAME) %>%
    summarize(biomass_sum = sum(biomass)) %>%
    mutate(com_percent = (biomass_sum/142633.9)*100) %>%
    arrange(desc(com_percent))
  
  #sum(species_biomass$biomass_sum) #142633.9
  write_csv(species_biomass, "percent_species_biomass.csv")
}

```

#Species-trait matrix

Functional distances were computed following [Lefhceck et al., 2014](http://onlinelibrary.wiley.com/doi/10.1890/ES13-00284.1/abstract). Code below modified from [ChessMap.Rmd](https://figshare.com/collections/Dimensions_of_biodiversity_in_Chesapeake_Bay_demersal_fishes_patterns_and_drivers_through_space_and_time/3308337)

```{r species-trait matrix}

if (!file.exists("functional_distance_rds")){
  
  trait_matrix = read_csv('species_trait_matrix.csv')
  
  trait_matrix = trait_matrix %>%
    as.tibble() %>%
    mutate(
      SPECIES_CD = toupper(as.character(SPECIES_CD))) 
  
  species_108 = read_csv("species_5_percent_data.csv") #species that occured in >5% of the sample data 
  
  species_trait_matrix = dplyr::semi_join(trait_matrix, species_108, by="SPECIES_CD") #108*12
  
  write_csv(species_trait_matrix, "species_trait_matrix.csv")
  
  trait_matrix = trait_matrix %>%
    as.tibble() %>%
    mutate(
      SPECIES_CD = toupper(as.character(SPECIES_CD))) %>% 
    arrange(SPECIES_CD)%>% 
    select(SPECIES_CD, Maxlength, Trophic_level, Trophic_group, Water_column, Diel_activity, Substrate_type, Complexity, Gregariousness) %>% #348*9
    group_by(
      SPECIES_CD, Maxlength, Trophic_level, Trophic_group, Water_column, Diel_activity, Substrate_type, Complexity, Gregariousness) %>%
    #summarize(n = n()) %>%
    #select(-n) %>%
    ungroup() %>%
    mutate(
      # ordinal traits
      Complexity = ordered(Complexity, levels=c("Low","Medium","High")),
      Gregariousness = ordered(Gregariousness, levels=c("1","2","3"))) %>%
    as.data.frame()
  
  #Set species names as row.names and remove extra columns
  rownames(trait_matrix)=trait_matrix$SPECIES_CD 
  
  #Calculate Gower distances. Variables have equal weight. 
  traits.dist = gowdis(trait_matrix, ord="podani")
  
  #to account for sensitivity in clustering use multiple algorithms  (Mouchet et al., 2008) 
  tree_methods = c("single","complete","average","mcquitty","ward.D") #average is best clustering method 
  trees=lapply(tree_methods,  function(i) hclust(traits.dist, method=i))
  par(mfrow=c(3,2))
  for(i in 1:length(trees)) {plot(trees[[i]])} #plots the 5 different kinds of trees 
  trees.ultra= lapply(trees,function(i) cl_ultrametric(as.hclust(i)))
  
  #Plot each tree
  par(mfrow=c(3,2))
  for (i in 1:length(trees.ultra)) {plot(trees.ultra[[i]])}  #plots the 5 different kinds of trees 
  
  #Build the consensus tree (Mouchet et al 2008 Oikos)  
  ensemble.trees=cl_ensemble(list=trees) #list of clusterings 
  class(ensemble.trees)
  consensus.tree=cl_consensus(ensemble.trees) #synthesizes the information in the elements of a cluster ensemble into a single clustering 
  par(mar=c(1,1,1,1))
  plot(consensus.tree, horiz=T)
  
  #Calculate dissimilarity values for each tree using 2-norm (Merigot et al 2010 Ecology) to determine which tree best preserves orignial distances 
  #spectral norm (2-norm) of the differences of the ultrametrics
  all.trees=c(trees.ultra,consensus.tree[1])
  names(all.trees)=c(tree_methods,"consensus")
  (trees.dissim=lapply(all.trees,function(i) cl_dissimilarity(i,traits.dist,method="spectral"))) 
  #Identify best tree and isolate
  trees.dissim2=do.call(rbind,trees.dissim)
  min.tree=which.min(trees.dissim2) #average 
  names(all.trees)[min.tree]
  func.dist=all.trees[names(all.trees)==names(all.trees)[min.tree]][[1]]
  #Confirm lowest 2-norm value,  spectral norm (2-norm) of the differences if the ultrametrics 
  cl_dissimilarity(func.dist,traits.dist,method="spectral") #Cross-dissimilarities using spectral ultrametric distance:   4.760895
  
  #Scale by the max value so that all values are between 0-1
  func.dist=func.dist/max(func.dist)
  saveRDS(func.dist, "functional_distance_rds")
}else{ #read data 
  func.dist = read_rds("functional_distance_rds")
} 

if(!file.exists("functional_distance_common_rds")){
  
  trait_matrix_common = trait_matrix %>%
    as.tibble() %>%
    mutate(
      COMNAME = toupper(as.character(COMNAME))) %>% 
    arrange(COMNAME)%>% 
    select(COMNAME, Maxlength, Trophic_level, Trophic_group, Water_column, Diel_activity, Substrate_type, Complexity, Gregariousness) %>% #348*9
    group_by(
      COMNAME, Maxlength, Trophic_level, Trophic_group, Water_column, Diel_activity, Substrate_type, Complexity, Gregariousness) %>%
    #summarize(n = n()) %>%
    #select(-n) %>%
    ungroup() %>%
    mutate(
      # ordinal traits
      Complexity = ordered(Complexity, levels=c("Low","Medium","High")),
      Gregariousness = ordered(Gregariousness, levels=c("1","2","3"))) %>%
    as.data.frame()
  
  #Set species names as row.names and remove extra columns
  rownames(trait_matrix_common)=trait_matrix_common$COMNAME 
  
  #Calculate Gower distances. Variables have equal weight. 
  traits.dist.common = gowdis(trait_matrix_common, ord="podani")
  
  trees_common=lapply(tree_methods,  function(i) hclust(traits.dist.common, method=i))
  par(mfrow=c(3,2))
  for(i in 1:length(trees)) {plot(trees[[i]])}
  
  trees_ultra_common= lapply(trees_common,function(i) cl_ultrametric(as.hclust(i)))
  
  ensemble.trees=cl_ensemble(list=trees_common) #list of clusterings 
  class(ensemble.trees)
  consensus.tree=cl_consensus(ensemble.trees) #synthesizes the information in the elements of a cluster ensemble into a single clustering 

  all.trees=c(trees_ultra_common,consensus.tree[1])
  names(all.trees)=c(tree_methods,"consensus")
  (trees.dissim=lapply(all.trees,function(i)
    cl_dissimilarity(i,traits.dist.common,method="spectral"))) 
  
  #Identify best tree and isolate
  trees.dissim2=do.call(rbind,trees.dissim)
  min.tree=which.min(trees.dissim2) #average 
  names(all.trees)[min.tree]
  func.dist.common=all.trees[names(all.trees)==names(all.trees)[min.tree]][[1]]
  cl_dissimilarity(func.dist.common,traits.dist.common,method="spectral")
  #Cross-dissimilarities using spectral ultrametric distance:
  
  #Scale by the max value so that all values are between 0-1
  func.dist.common=func.dist.common/max(func.dist.common)
  saveRDS(func.dist.common, "functional_distance_common_rds")
}else{
  func.dist.common = readRDS("functional_distance_common_rds")
}

dend = as.dendrogram(func.dist.common)

dendrogram = dend %>%
color_branches(dend, k=10) %>% #color the branches based on the clusters 
  set("labels_cex", 0.5) %>% #size of the labels #0.8
  set("nodes_pch", 19) %>% #type of nodes
  set("nodes_cex", 0.4) %>% #size of nodes 
  set("nodes_col", 1) %>% #color of nodes
  set("branches_lwd", 1.5) #%>% #thickness of branch 

#plot functional dendrogram 
pdf("functional_dendrogram2.pdf", width = 8, height = 11) 
par(pin=c(5.5,9))
#par(mai = c(1,1,1,1))
plot(dendrogram,
     main= "Florida Keys Reef Fish\nFunctional dendrogram", 
     xlab = "Dissimilarity",
     cex.lab = 1,
     cex.axis =0.8,
     ylab = "",
     sub = NULL,
     horiz = T,
     ps=60, 
     #hang = -1,
     nodePar = list(cex = .007))
dev.off()

#plot functional dendrogram 
pdf("functional_dendrogram3.pdf", width = 8.5, height = 12) 
par(pin=c(5.5,9))
#par(mai = c(1,1,1,1))
plot(dendrogram,
     main= "", 
     xlab = "Dissimilarity",
     cex.lab = 1,
     cex.axis =0.8,
     ylab = "",
     sub = NULL,
     horiz = T,
     ps=60, 
     #hang = -1,
     nodePar = list(cex = .007))
dev.off()

dendrogram = dend %>%
color_branches(dend, k=10) %>% #color the branches based on the clusters 
  set("labels_cex", 1) %>% #size of the labels #0.8
  set("nodes_pch", 19) %>% #type of nodes
  set("nodes_cex", 0.5) %>% #size of nodes 
  set("nodes_col", 1) %>% #color of nodes
  set("branches_lwd", 1.5) #%>% #thickness of branch 

#plot functional dendrogram 
pdf("functional_dendrogram4.pdf", width = 8, height = 12) 
par(pin=c(5.5,9))
#par(mai = c(1,1,1,1))
plot(dendrogram,
     main= "", 
     xlab = "Figure 2. Functional Dissimilarity",
     cex.lab = 1,
     cex.axis =0.8,
     ylab = "",
     sub = NULL,
     horiz = T,
     ps=60, 
     #hang = -1,
     nodePar = list(cex = .007))
dev.off()

#trait visualization 

trait_matrix_treemap = trait_matrix %>%
  select(SPECIES_CD, Maxlength, Trophic_level, Trophic_group, Water_column,Diel_activity,Substrate_type,Complexity, Gregariousness) %>% 
  group_by(Maxlength,
           Trophic_level,
           Trophic_group,
           Water_column,
           Diel_activity,
           Substrate_type,
           Complexity,
           Gregariousness) %>%
  summarise(n = n())%>% 
  ungroup() %>%
  as.data.frame()

treemap = 
   d3treeR::d3tree2(
    treemap(
      dtf = trait_matrix_treemap,
      index = c("Trophic_group", "Diel_activity", "Substrate_type", "Trophic_level", "Water_column","Maxlength","Complexity","Gregariousness"),
      vSize = "n", 
      vColor = "Trophic_group",
      type = "index"),
    #title = "Reef Fish Traits",
    #fontsize.title = 14, 
    #algorithm = "squarified"
    rootname = "Species Traits")

htm = "./htmlwidget_treemap2.html"
saveWidget(treemap, htm)

```

#Compute reef fish biodiversity 

All indices were computed as effective number of species. Effective number of species is the number of equally abundance species needed to produce the observed value of a diversity index ( [Jost, 2006](http://onlinelibrary.wiley.com/doi/10.1111/j.2006.0030-1299.14714.x/abstract); [Jost,2010](https://www.researchgate.net/publication/41667724_The_Relation_between_Evenness_and_Diversity); [MacArthur, 1965](http://onlinelibrary.wiley.com/doi/10.1111/j.1469-185X.1965.tb00815.x/abstract?systemMessage=Wiley+Online+Library+will+be+disrupted+6+Aug+from+10-12+BST+for+monthly+maintenance) ). Jost, 2006 refers to these as true measures of diversity, where prior to the conversion the diversity indices are simply measures of entropy. 

- Species Richness is the number of species in a habitat sampled  

$Richness = \sum_{i=1}^S p_i^0$  

- Simpson diversity measures the probability that two individuals randomly selected from a sample will belong to different species.   

$Simpson = 1 - \sum_{i=1}^S p_i^2$  

- Shannon diveristy is a measure of entropy, it is the uncertainty in the species identity of a sample  

$Shannon = - \sum_{i=1}^S p_i \log_b p_i$  

- Functional diversity (Rao's Q) is a measure of pairwise functional differences between species weighted by their relative abundances   

$Rao Q = \sum_{i=1}^S-1 \sum_{j=i+1}^S d_i p_i p_j$

```{r biodiversity}

if(!file.exists('diversity_data.csv')){
  
  clean_data = read_csv("clean_data.csv")
  psu_bio = read_csv("psu_bio.csv")
  
  species_trait_matrix = read_csv("species_trait_matrix.csv") %>%
    as.data.frame()
  
  diversity_indices = clean_data %>% 
    mutate(
      STRAT_GROUPED = 
        ifelse(grepl("FMLR|FSLR|FDLR", STRAT), 'LINEAR_REEF', 
               ifelse(grepl("OFPR|MCPR|INPR", STRAT), 'PATCH_REEF',
                      ifelse(grepl('HRRF', STRAT), 'HIGH_RELIEF', "IDK")))) %>%
    select(YEAR, PRIMARY_SAMPLE_UNIT,STRAT_GROUPED,PROT,SPECIES_CD,abundance) %>% #tibble: 192,780 x 6
    group_by(YEAR, PRIMARY_SAMPLE_UNIT, STRAT_GROUPED, PROT) %>% #5,235 groups 
    nest(-YEAR) %>%
    mutate(
      data_wide = map(data, function(x) 
        full_join(x, species_trait_matrix %>% select(SPECIES_CD), by='SPECIES_CD') %>%
          mutate(abundance = ifelse(is.na(abundance), 0, abundance)) %>%
          spread(SPECIES_CD, abundance, fill =0)),
      data_wide = map(data, ~ spread(data=.x, SPECIES_CD, abundance, fill =0)), 
      richness = map( #species richness
        data_wide, 
        function(x) specnumber(x)),
      simpson = map( #simpson diversity as effective number of species 
        data_wide,
        function(x) 1/(1 - diversity(x, index = 'simpson'))),
      shannon = map( #shannon diversity as effective number of species 
        data_wide, 
        function(x) exp(diversity(x,  index = 'shannon')))) %>% 
    unnest(richness, simpson, shannon)
  
  diversity_indices = diversity_indices %>%
    select(YEAR,PRIMARY_SAMPLE_UNIT,STRAT_GROUPED,PROT,richness,simpson,shannon) %>%
    mutate(simpson = round(simpson,8),
           shannon = round(shannon,8))
  #dim(diversity_indices) 5235x7
  
  func.dist = read_rds("functional_distance_rds")
  
  #Set rownames on traits and remove other info
  rownames(species_trait_matrix) <- species_trait_matrix$SPECIES_CD
  species_trait_matrix <- species_trait_matrix[, -c(1:4)]
  #Convert rownames to all caps
  rownames(species_trait_matrix) <- toupper(rownames(species_trait_matrix))
  
  abundance = clean_data %>%
    mutate(
      STRAT_GROUPED = 
        ifelse(grepl("FMLR|FSLR|FDLR", STRAT), 'LINEAR_REEF', 
               ifelse(grepl("OFPR|MCPR|INPR", STRAT), 'PATCH_REEF',
                      ifelse(grepl('HRRF', STRAT), 'HIGH_RELIEF', "IDK"))))%>%
    select(YEAR, PRIMARY_SAMPLE_UNIT,STRAT_GROUPED,PROT, SPECIES_CD, abundance) %>% 
    group_by(YEAR, PRIMARY_SAMPLE_UNIT,STRAT_GROUPED,PROT)
  #dim(abundance) 192780x6 : 5235 groups 
  
  #Cast abundance longways (species as columns)
  abundmat <- spread(abundance, SPECIES_CD, abundance, fill = 0) 
  #dim(abundmat)5,235*112
  
  # Drop communities with no species (roughly 500 sites)
  #abundmat <- abundmat[!rowSums(abundmat) == 0,] 
  #dim(abundmat) #5,241     316
  #abundmat <- abundmat[!rowSums(abundmat) == 1,]
  
  #Subset species whose names only appear in traits
  abundmat <- abundmat[colnames(abundmat) %in% rownames(species_trait_matrix)] 
  #dim(abundmat) #5,235 x 108
  
  #Calculate relative values for community matrix
  rel.mat=abundmat/apply(abundmat,1,sum)
  
  #Compute species diversity
  species.dist=matrix(1,ncol(abundmat),ncol(abundmat))-diag(rep(1,ncol(abundmat))) 
  simpson=1/(1-apply(rel.mat,1,function(x) t(x) %*% species.dist %*% x))
  
  #Compute evenness (as in Jost 2010 Diversity)
  evenness=log(simpson)/log(rowSums(abundmat>0))
  
  #functional diversity 
  func.div=1/(1-apply(rel.mat,1, function(x) t(x) %*% as.matrix(func.dist) %*% x))
  
  #Bind all to the original dataframe 
  list = cbind(simpson,func.div,evenness) %>%
    as_tibble()%>%
    mutate(simpson = round(simpson,8),
           func.div = round(func.div, 8),
           evenness = round(evenness, 8))
  #dim(list) 5235x3
  
  diversity = left_join(diversity_indices, list, by="simpson") %>%
    group_by(YEAR, PRIMARY_SAMPLE_UNIT) %>% #5,235 groups
    summarise(
      richness = first(richness),
      simpson = first(simpson),
      shannon = first(shannon),
      func.div = first(func.div),
      evenness = first(evenness))
  
  RVC_data = read_rds("RVCdata_FK.rds")
  
  sample_data = RVCdata_FK$sample_data %>%
    as.tibble() %>%
    mutate(
      STRAT_GROUPED = 
        ifelse(grepl("FMLR|FSLR|FDLR", STRAT), 'LINEAR_REEF', 
               ifelse(grepl("OFPR|MCPR|INPR", STRAT), 'PATCH_REEF',
                      ifelse(grepl('HRRF', STRAT), 'HIGH_RELIEF', "IDK"))))%>%
    select(-SPECIES_CD, -SPECIES_NR, -REGION, -TIME_SEEN, -LEN, -NUM)%>%
    group_by(YEAR,PRIMARY_SAMPLE_UNIT, STRAT_GROUPED, PROT, MPA_NR)%>% 
    summarize(
      LAT_DEGREES = mean(LAT_DEGREES),
      LON_DEGREES = mean(LON_DEGREES),
      DEPTH = mean(DEPTH),
      MONTH = mean(MONTH))
  #dim 5,241X8
  
  sample_data = sample_data[!(sample_data$YEAR == "2006" & 
                                sample_data$PRIMARY_SAMPLE_UNIT == "602U" | #only 1 species
                                sample_data$YEAR == "2016" & 
                                sample_data$PRIMARY_SAMPLE_UNIT == "1010U"| #only 1 species 
                                sample_data$YEAR == "2002" &
                                sample_data$PRIMARY_SAMPLE_UNIT =="472U"  | #one large school sp.
                                sample_data$YEAR == "2003" &
                                sample_data$PRIMARY_SAMPLE_UNIT =="119U"  | #one large school sp. 
                                sample_data$YEAR == "2004" &
                                sample_data$PRIMARY_SAMPLE_UNIT =="403U"  | #one large school sp.
                                sample_data$YEAR == "2001" & 
                                sample_data$PRIMARY_SAMPLE_UNIT =="222U"),]
  #dim(sample_data) 5235x8
  
  all_data = inner_join(diversity,sample_data)
  
  mpa_data = all_data %>%
    mutate(MPA_NR= as.numeric(MPA_NR))%>%
    mutate(MPA_NAME = 
             ifelse(MPA_NR == 0| MPA_NR == 27| MPA_NR ==28, 
                    "Not Protected",
                    ifelse(MPA_NR == 1|MPA_NR ==2|MPA_NR ==3|MPA_NR ==4|MPA_NR ==5|MPA_NR ==6|MPA_NR ==7|MPA_NR ==9|MPA_NR ==10|MPA_NR ==11|MPA_NR ==12|MPA_NR ==14|MPA_NR ==15|MPA_NR ==16|MPA_NR ==18|MPA_NR ==21|MPA_NR ==22|MPA_NR ==23, 
                           "Sanctuary Preservation Area",
                           ifelse(MPA_NR ==8|MPA_NR ==13|MPA_NR ==17|MPA_NR ==19, 
                                  "Special Use",
                                  ifelse(MPA_NR == 20, 
                                         "Ecological Reserve", "NA")))))
  
  data = inner_join(mpa_data, psu_abundance, by="PRIMARY_SAMPLE_UNIT") 
  data = inner_join(mpa_data, psu_bio,   by="PRIMARY_SAMPLE_UNIT")  
  
  write_csv(data, "diversity_data.csv")
}
  
```

#Species Accumulation Curve

Computed mean species accumulation curve and its standard deviation from random permutations of the data to estimate the amound of surveys needed to accuratly calculate diversity. 

Computed species-based rarefraction which is the expected number of species *s* when *m samples* are drawn at random (without replacement) from a set of samples that are representative of the assemblage (Gotelli and Colwell, 2001; Colewell et al. 2004). The sample-based rarefraction preserves the spatial structure of the data.

```{r SAC and Rarefraction}

clean_data = read_csv("clean_data.csv")
species_trait_matrix = read_csv("species_trait_matrix.csv") %>%
    as.data.frame()

#Set rownames on traits and remove other info
  rownames(species_trait_matrix) <- species_trait_matrix$SPECIES_CD
  species_trait_matrix <- species_trait_matrix[, -c(1:4)]
  #Convert rownames to all caps
  rownames(species_trait_matrix) <- toupper(rownames(species_trait_matrix))
  
  abundance = clean_data %>%
    select(YEAR, PRIMARY_SAMPLE_UNIT, SPECIES_CD, abundance) %>% 
    group_by(YEAR, PRIMARY_SAMPLE_UNIT)%>%
    mutate(abun = ifelse(
      abundance>0&abundance<1, 1, abundance))%>%
    mutate(abun = round(abun, 0))%>%
    select(-abundance)
  #dim(abundance) 192780x4 : 5235 groups 
  
  #Cast abundance longways (species as columns)
  abundmat <- spread(abundance, SPECIES_CD, abun, fill = 0) 
  #dim(abundmat)5,235*112
  
  #Subset species whose names only appear in traits
  abundmat <- abundmat[colnames(abundmat) %in% rownames(species_trait_matrix)] #5,238 sites *108species
  
  #Drop communities with no species (roughly 500 sites)
  abundmat <- abundmat[!rowSums(abundmat) == 0,] #5,235 x 108
  #dim(abundmat) #5,241     316
  abundmat <- abundmat[!rowSums(abundmat) == 1,]#5,235 x 108
  
  abundmat = as.data.frame(abundmat)
  
  #Species accumulation “Species accumulation models and species poolmodels study collections of sites, and their species richness, or try to estimate the number of unseen species.” (Oksanen 2016)
  
  #finds the mean SAC and its standard deviation from random permutations of the data
  Species_Accumulation_Curve = vegan::specaccum(abundmat, "random") #abundmat[1:500,]
  
  #plots the species accumulation curve and the confidence intervals for sites.
  plot(Species_Accumulation_Curve, ci.type="poly", col="lightpink", lwd=2, ci.lty=0, ci.col="hotpink", xlim=range(1:100),xlab="Number of samples", ylab= "Number of species", main="Species Accumulation Curve", ylim=c(0,120))
  boxplot(Species_Accumulation_Curve, col="yellow", border="blue",add=TRUE, pch="+", xlim=range(1:100))
  
  plot(Species_Accumulation_Curve, ci.type="poly", col="lightpink", lwd=2, ci.lty=0, ci.col="hotpink",xlab="Number of samples", ylab= "Number of species", main="Species Accumulation Curve", ylim=c(0,120))
  boxplot(Species_Accumulation_Curve, col="yellow", border="blue",add=TRUE, pch="+")
  
  #Fit nonlinear Arrhenius models to species random accumulation
  mods = fitspecaccum(Species_Accumulation_Curve, "arrh")
  plot(mods, col="hotpink",xlim=range(1:100))
  boxplot(Species_Accumulation_Curve, col = "yellow", border = "blue", lty=1, cex=0.3, add= TRUE, xlim=range(1:100))
  
  #Fit Lomolino model to the exact accumulation
  #finds the expected (mean) species richness
  SAC_exact = specaccum(abundmat, "exact")
  plot(SAC_exact, ci.type="poly", col="blue", lwd=2, ci.lty=0, ci.col="lightblue", xlim=range(1:100))
  mod1=fitspecaccum(SAC_exact, "lomolino")
  coef(mod1)
  fitted(mod1)
  plot(SAC_exact, col="hotpink",lwd=2)
  ## Add Lomolino model using argument 'add'
  plot(mod1, add = TRUE, col="blue", lwd=2)
  
#Rarefaction “Species richness increases with sample size, and differences in richness actually may be caused by differences in sample size. To solve this problem, we may try to rarefy species richness to the same number of individuals… Rarefaction is sometimes presented as an ecologically meaningful alternative to dubious diversity indices (Hurlbert, 1971), but the differences really seem to be small.” (Oksanen 2016)

#observed number of species
S <- specnumber(abundmat) 
#Number of INDIVIDULS per site
(raremax = min(rowSums(abundmat))) #2
#rarefy, w/ raremax as input
Srare <- rarefy(abundmat, raremax) #se=T
#Srare2 <- rarefy(abundmat, 100)
#Plot rarefaction results
par(mfrow = c(1,2))
plot(S, Srare, xlab = "Observed No. of Species", ylab = "Rarefied No. of Species", main="Rarefaction")

#rarecurve(): draws a rarefaction curve for each row of the input dat
rarecurve(abundmat, step = 20, sample = raremax, col = "blue", cex = 0.6, main="Rarecurve")

plot(specaccum(abundmat, method="rarefaction"),main="Rarefaction")

```

#Plots

```{r plot all diversity by year}

#plot species richness, Simpson, Shannon, and Functional diversity through time 

all_matrices_data = read_csv("diversity_data.csv") #5235 x 18 
  
#Melt dataframe so diversity indices are in a single column
  x = reshape2::melt(all_matrices_data, id.vars = c("YEAR"),
                     measure.vars=c("richness","shannon","simpson","func.div")) 
#Summarize means and SEs by year and variable
  x=plyr::ddply(x, c("YEAR", "variable"), summarize, value.mean=mean(value), value.se=plotrix::std.error(value))
#Rename levels for figure plotting
  levels(x$variable)=c("Richness", "Shannon", "Simpson", "Functional")
  diversity_plot = x %>%
    as.tibble()
  
  diveristy_year_plot = diversity_plot %>% 
    ggplot(.,aes(x=YEAR, y=value.mean, color=variable))+
    geom_errorbar(aes(ymax=value.mean+value.se,ymin=value.mean-value.se),width=0.2)+
    geom_point(size=2.5)+
    geom_line(aes(group=variable),lwd=2)+
    labs(title= "Florida Keys Reef Fish Biodiversity", x="Year", y="Mean effective \nnumber of species (± SE)", colour = "Diversity index")+
    scale_y_continuous(limits= c(0,45),
                       breaks=c(0,5,10,15,20,25,30,35,40,45), 
                       labels=c("0","","10","","20","","30","","40",""))+
    scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  scale_color_manual(
    labels= c("Richness","Shannon","Simpson","Functional"),
    values=c("Richness"="red",
             "Shannon"="orange",
             "Simpson"="forestgreen",
             "Functional"="blue"))+
  theme_bw()+
  theme(
      legend.position="right",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      #panel.background=element_rect(fill="grey45"),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12, face = "bold"),
      plot.title =element_text(hjust = 0.5),
      legend.text = element_text(size=12),
      legend.title =element_blank())
ggsave(file="diversity_by_year_leg_right.pdf", width=10, height=7, path="plots")

```

```{r plot all indices by year and no take marine zones}

all_matrices_data = read_csv("diversity_data.csv")

matrices_ntmr = all_matrices_data %>% 
    group_by(YEAR, PROT) %>% #add subregion later 
    summarize(
      abundance_mean = mean(abundance_sum),
      abundance_n = length(abundance_sum),
      abundance_sd = sd(abundance_sum),
      abundance_se = abundance_sd / sqrt(abundance_n),
      abundance_min = min(abundance_sum),
      abundance_max = max(abundance_sum),
      biomass_mean = mean(biomass_sum),
      biomass_n = length(biomass_sum),
      biomass_sd = sd(biomass_sum),
      biomass_se = biomass_sd / sqrt(biomass_n),
      biomass_min = min(biomass_sum),
      biomass_max = max(biomass_sum),
      evenness_mean = mean(evenness),
      evenness_n = length(evenness),
      evenness_sd = sd(evenness),
      evenness_se = evenness_sd / sqrt(evenness_n),
      evenness_min = min(evenness),
      evenness_max = max(evenness),
      richness_mean = mean(richness),
      richness_n = length(richness),
      richness_sd = sd(richness),
      richness_se = richness_sd / sqrt(richness_n),
      richness_min = min(richness),
      richness_max = max(richness),
      shannon_n = length(shannon),
      shannon_sd = sd(shannon),
      shannon_se = shannon_sd / sqrt(shannon_n),
      shannon_min = min(shannon),
      shannon_max = max(shannon),
      simpson_mean = mean(simpson),
      simpson_n = length(simpson),
      simpson_sd = sd(simpson),
      simpson_se = simpson_sd / sqrt(simpson_n),
      simpson_min = min(simpson),
      simpson_max = max(simpson),
      shannon_mean = mean(shannon),
      func.div_mean = mean(func.div),
      func.div_n = length(func.div),
      func.div_sd = sd(func.div),
      func.div_se = func.div_sd / sqrt(func.div_n),
      func.div_min = min(func.div),
      func.div_max = max(func.div))

#abundance 
abun_prot = ggplot(matrices_ntmr,aes(x=YEAR,y=abundance_mean, colour=factor(PROT), group=factor(PROT)))+ 
  geom_line(aes(group=PROT),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymax=abundance_mean+abundance_se,ymin=abundance_mean-abundance_se),width=0.1)+
  labs(title= "A) Abundance", x="Year", y="Mean abundance (± SE)", color = NULL)+
  scale_color_manual(
    values =  c("blue","red"),
    breaks = c("1", "0"), 
    labels=c("Protected","Not Protected"))+
  scale_x_continuous(
    limits = c(1999, 2016), 
    breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016),
    labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
    legend.position="none",
    panel.grid.major=element_blank(),
    panel.grid.minor=element_blank(),
    axis.title.x=element_text(size=12),
    axis.title.y=element_text(size=12),
    title=element_text(size=12))
#ggsave(file="abundance_by_year_protection.pdf", path="plots")

#biomass 
bio_prot = ggplot(matrices_ntmr,aes(x=YEAR,y=biomass_mean, colour=factor(PROT), group=factor(PROT)))+ 
  geom_line(aes(group=PROT),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymax=biomass_mean+biomass_se,ymin=biomass_mean-biomass_se),width=0.1)+
  labs(title= "B) Biomass", x="Year", y="Mean biomass (± SE)", color = NULL)+
  scale_color_manual(
    values =  c("blue","red"),
    breaks = c("1", "0"), 
    labels=c("Protected","Not Protected"))+
  scale_x_continuous(
    limits = c(1999, 2016), 
    breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016),
    labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
    legend.position="none",
    panel.grid.major=element_blank(),
    panel.grid.minor=element_blank(),
    axis.title.x=element_text(size=12),
    axis.title.y=element_text(size=12),
    title=element_text(size=12))
#ggsave(file="biomass_by_year_protection.pdf", path="plots")

#evennness 
eve_prot = ggplot(matrices_ntmr,aes(x=YEAR,y=evenness_mean, colour=factor(PROT), group=factor(PROT)))+ 
  geom_line(aes(group=PROT),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymax=evenness_mean+evenness_se,ymin=evenness_mean-evenness_se),width=0.1)+
  labs(title= "C) Evenness", x="Year", y="Mean evennness (± SE)", color = NULL)+
  scale_color_manual(
    values =  c("blue","red"),
    breaks = c("1", "0"), 
    labels=c("Protected","Not Protected"))+
  scale_x_continuous(
    limits = c(1999, 2016), 
    breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016),
    labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
    legend.position="none",
    panel.grid.major=element_blank(),
    panel.grid.minor=element_blank(),
    axis.title.x=element_text(size=12),
    axis.title.y=element_text(size=12),
    title=element_text(size=12))
#ggsave(file="evenness_by_year_protection.pdf", path="plots")

#richness
rich_prot = ggplot(matrices_ntmr,aes(x=YEAR,y=richness_mean, colour=factor(PROT), group=factor(PROT)))+ 
  geom_line(aes(group=PROT),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymax=richness_mean+richness_se,ymin=richness_mean-richness_se),width=0.1)+
  labs(title= "D) Richness", x="Year", y="Mean effective \nnumber of species (± SE)", color = NULL)+
  scale_color_manual(
    values =  c("blue","red"),
    breaks = c("1", "0"), 
    labels=c("Protected","Not Protected"))+
  scale_x_continuous(
    limits = c(1999, 2016), 
    breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016),
    labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
    legend.position="none",
    panel.grid.major=element_blank(),
    panel.grid.minor=element_blank(),
    axis.title.x=element_text(size=12),
    axis.title.y=element_text(size=12),
    title=element_text(size=12))
ggsave(file="richness_by_year_protection.pdf", path="plots")

# shannon
shan_prot = ggplot(matrices_ntmr,aes(x=YEAR,y=shannon_mean, colour=factor(PROT), group=factor(PROT)))+ 
  geom_line(aes(group=PROT),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymax=shannon_mean+shannon_se,ymin=shannon_mean-shannon_se),width=0.1)+
  labs(title= "E) Shannon", x="Year", y="Mean effective \nnumber of species (± SE)", color = NULL)+
  scale_color_manual(
    values =  c("blue","red"),
    breaks = c("1", "0"), 
    labels=c("Protected","Not Protected"))+
  scale_x_continuous(
    limits = c(1999, 2016), 
    breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016),
    labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
    legend.position="none",
    panel.grid.major=element_blank(),
    panel.grid.minor=element_blank(),
    axis.title.x=element_text(size=12),
    axis.title.y=element_text(size=12),
    title=element_text(size=12))
#ggsave(file="shannon_diversity_by_year_protection.pdf", path="plots")

#simpson
simp_prot = ggplot(matrices_ntmr,aes(x=YEAR,y=simpson_mean, colour=factor(PROT), group=factor(PROT)))+ 
  geom_line(aes(group=PROT),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymax=simpson_mean+simpson_se,ymin=simpson_mean-simpson_se),width=0.1)+
  labs(title= "F) Simpson", x="Year", y="Mean effective \nnumber of species (± SE)", color = NULL)+
  scale_color_manual(
    values =  c("blue","red"),
    breaks = c("1", "0"), 
    labels=c("Protected","Not Protected"))+
  scale_x_continuous(
    limits = c(1999, 2016), 
    breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016),
    labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
    legend.position="none",
    panel.grid.major=element_blank(),
    panel.grid.minor=element_blank(),
    axis.title.x=element_text(size=12),
    axis.title.y=element_text(size=12),
    title=element_text(size=12))
#ggsave(file="simpson_diversity_by_year_protection.pdf", path="plots")

# functional
func_prot = ggplot(matrices_ntmr,aes(x=YEAR,y=func.div_mean, colour=factor(PROT), group=factor(PROT)))+ 
  geom_line(aes(group=PROT),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymax=func.div_mean+func.div_se,ymin=func.div_mean-func.div_se),width=0.1)+
  labs(title= "G) Functional", x="Year", y="Mean effective \nnumber of species (± SE)", color = NULL)+
  scale_color_manual(
    values =  c("blue","red"),
    breaks = c("1", "0"), 
    labels=c("Protected","Not Protected"))+
  scale_x_continuous(
    limits = c(1999, 2016), 
    breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016),
    labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
    legend.position="none",
    panel.grid.major=element_blank(),
    panel.grid.minor=element_blank(),
    axis.title.x=element_text(size=12),
    axis.title.y=element_text(size=12),
    title=element_text(size=12))
#ggsave(file="functional_diversity_by_year_protection.pdf", path="plots")

#save legend
for_legend_prot_horiz = ggplot(matrices_ntmr,aes(x=YEAR,y=richness_mean, colour=factor(PROT), group=factor(PROT)))+ 
  geom_line(aes(group=factor(PROT)),lwd=1) +
  geom_point(size=3) +
  labs(colour = "")+
  scale_colour_manual(labels=c("Protected", "Not Protected"), values= c("red", "blue"))+
    theme(
      legend.position="right", #"none", "right",c(0.8,0.68),
      legend.text=element_text(size=12),
      legend.key.size=unit(5,"mm"))
legend_prot_horiz <- get_legend(for_legend_prot_horiz)
#ggsave(file="legend_year_protection.pdf", path="plots", legend_prot_horiz, width=3, height=2)
for_legend_prot_vert = ggplot(matrices_ntmr,aes(x=YEAR,y=abundance_mean, colour=factor(PROT), group=factor(PROT)))+ 
  geom_line(aes(group=factor(PROT)),lwd=1) +
  geom_point(size=3) +
  labs(colour = "")+
  scale_colour_manual(labels=c("Protected", "Not Protected"), values= c("red", "blue"))+
    theme(
      legend.position="right", #"none", "right",c(0.8,0.68),
      legend.text=element_text(size=11),
      legend.key.size=unit(5,"mm"))

legend_prot_vert <- get_legend(for_legend_prot_vert)

#all plots on one page
group_prot <- grid.arrange(abun_prot,bio_prot,eve_prot,rich_prot,shan_prot,simp_prot,func_prot,legend_prot_vert, ncol=2)
ggsave(file="all_by_year_and_protection.pdf", group_prot, width=7.5, height=10, path="plots")

group_prot <- grid.arrange(abun_prot,bio_prot,eve_prot,rich_prot,simp_prot,func_prot, ncol=3)
ggsave(file="all6_by_year_and_protection.pdf", group_prot, width=10, height=7.5, path="plots")
group_prot <- grid.arrange(abun_prot,bio_prot,eve_prot,rich_prot,simp_prot,func_prot, ncol=2)
ggsave(file="all6_by_year_and_protection_long.pdf", group_prot, width=7.5, height=10, path="plots")

#all diversity plots on one page
g_prot <- grid.arrange(rich_prot,shan_prot,simp_prot,func_prot)
ggsave(file="diversity_by_year_and_protection.pdf", g_prot, width=10, height=7, path="plots")

```

Plot diversity indices by grouped strata 

```{r plot all indices by year and grouped strata}

all_matrices_data = read_csv("diversity_data.csv")

matrices_strat_grouped = all_matrices_data %>% 
    group_by(YEAR, STRAT_GROUPED) %>% 
    summarize(
      abundance_mean = mean(abundance_sum),
      abundance_n = length(abundance_sum),
      abundance_sd = sd(abundance_sum),
      abundance_se = abundance_sd / sqrt(abundance_n),
      abundance_min = min(abundance_sum),
      abundance_max = max(abundance_sum),
      biomass_mean = mean(biomass_sum),
      biomass_n = length(biomass_sum),
      biomass_sd = sd(biomass_sum),
      biomass_se = biomass_sd / sqrt(biomass_n),
      biomass_min = min(biomass_sum),
      biomass_max = max(biomass_sum),
      evenness_mean = mean(evenness),
      evenness_n = length(evenness),
      evenness_sd = sd(evenness),
      evenness_se = evenness_sd / sqrt(evenness_n),
      evenness_min = min(evenness),
      evenness_max = max(evenness),
      richness_mean = mean(richness),
      richness_n = length(richness),
      richness_sd = sd(richness),
      richness_se = richness_sd / sqrt(richness_n),
      richness_min = min(richness),
      richness_max = max(richness),
      shannon_mean = mean(shannon),
      shannon_n = length(shannon),
      shannon_sd = sd(shannon),
      shannon_se = shannon_sd / sqrt(shannon_n),
      shannon_min = min(shannon),
      shannon_max = max(shannon),
      simpson_mean = mean(simpson),
      simpson_n = length(simpson),
      simpson_sd = sd(simpson),
      simpson_se = simpson_sd / sqrt(simpson_n),
      simpson_min = min(simpson),
      simpson_max = max(simpson),
      func.div_mean = mean(func.div),
      func.div_n = length(func.div),
      func.div_sd = sd(func.div),
      func.div_se = func.div_sd / sqrt(func.div_n),
      func.div_min = min(func.div),
      func.div_max = max(func.div))

#abundance
abun_gs= ggplot(matrices_strat_grouped,aes(x=YEAR,y=abundance_mean, colour=STRAT_GROUPED, group=STRAT_GROUPED))+ #shape=STRAT_GROUPED
  geom_line(aes(group=STRAT_GROUPED),lwd=1) +
  geom_point(size=3) +
 geom_errorbar(aes(ymin=abundance_mean-abundance_se, ymax=abundance_mean+abundance_se), width=.1)+
  labs(title= "A) Abundance", x="Year", y="Mean abundance \nnumber of individuals (± SE)", colour = "Strata")+
  scale_colour_manual(labels=c("High reef", "Linear reef", "Patch reef"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
#ggsave(file="abundance_by_year_and_strata_grouped.pdf", path="plots")

#biomass
bio_gs= ggplot(matrices_strat_grouped,aes(x=YEAR,y=biomass_mean, colour=STRAT_GROUPED, group=STRAT_GROUPED))+ #shape=STRAT_GROUPED
  geom_line(aes(group=STRAT_GROUPED),lwd=1) +
  geom_point(size=3) +
 geom_errorbar(aes(ymin=biomass_mean-biomass_se, ymax=biomass_mean+biomass_se), width=.1)+
  labs(title= "B) Biomass", x="Year", y="Mean biomass \nkilograms (± SE)", colour = "Strata")+
  scale_colour_manual(labels=c("High reef", "Linear reef", "Patch reef"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
#ggsave(file="biomass_by_year_and_strata_grouped.pdf", path="plots")

#evenness
even_gs= ggplot(matrices_strat_grouped,aes(x=YEAR,y=evenness_mean, colour=STRAT_GROUPED, group=STRAT_GROUPED))+ #shape=STRAT_GROUPED
  geom_line(aes(group=STRAT_GROUPED),lwd=1) +
  geom_point(size=3) +
 geom_errorbar(aes(ymin=evenness_mean-evenness_se, ymax=evenness_mean+evenness_se), width=.1)+
  labs(title= "C) Evenness", x="Year", y="Mean evennness (± SE)", colour = "Strata")+
  scale_colour_manual(labels=c("High reef", "Linear reef", "Patch reef"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
#ggsave(file="evenness_by_year_and_strata_grouped.pdf", path="plots")

#richness
rich_gs= ggplot(matrices_strat_grouped,aes(x=YEAR,y=richness_mean, colour=STRAT_GROUPED, group=STRAT_GROUPED))+ #shape=STRAT_GROUPED
  geom_line(aes(group=STRAT_GROUPED),lwd=1) +
  geom_point(size=3) +
 geom_errorbar(aes(ymin=richness_mean-richness_se, ymax=richness_mean+richness_se), width=.1)+
  labs(title= "D) Richness", x="Year", y="Mean effective \nnumber of species (± SE)", colour = "Strata")+
  scale_colour_manual(labels=c("High reef", "Linear reef", "Patch reef"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
ggsave(file="richness_by_year_and_strata_grouped.pdf", path="plots")

#shannon
shan_gs= ggplot(matrices_strat_grouped,aes(x=YEAR,y=shannon_mean, colour=STRAT_GROUPED, group=STRAT_GROUPED))+ #shape=STRAT_GROUPED
  geom_line(aes(group=STRAT_GROUPED),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymin=shannon_mean-shannon_se, ymax=shannon_mean+shannon_se), width=.1)+
  labs(title= "E) Shannon", x="Year", y="Mean effective \nnumber of species (± SE)", colour = "Strata")+
  scale_colour_manual(labels=c("High reef", "Linear reef", "Patch reef"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
ggsave(file="shannon_by_year_and_strata_grouped.pdf", path="plots")

#simpson
sim_gs= ggplot(matrices_strat_grouped,aes(x=YEAR,y=simpson_mean, colour=STRAT_GROUPED, group=STRAT_GROUPED))+ #shape=STRAT_GROUPED
  geom_line(aes(group=STRAT_GROUPED),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymin=simpson_mean-simpson_se, ymax=simpson_mean+simpson_se), width=.1)+
  labs(title= "F) Simpson", x="Year", y="Mean effective \nnumber of species (± SE)", colour = "Strata")+
  scale_colour_manual(labels=c("High reef", "Linear reef", "Patch reef"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
ggsave(file="simpson_by_year_and_strata_grouped.pdf", path="plots")

#functional
func_gs= ggplot(matrices_strat_grouped,aes(x=YEAR,y=func.div_mean, colour=STRAT_GROUPED, group=STRAT_GROUPED))+ #shape=STRAT_GROUPED
  geom_line(aes(group=STRAT_GROUPED),lwd=1) +
  geom_point(size=3) +
  geom_errorbar(aes(ymax=func.div_mean+func.div_se,ymin=func.div_mean-func.div_se),width=0.1)+
  labs(title= "G) Functional", x="Year", y="Mean effective \nnumber of species (± SE)", colour = "Strata")+
  scale_colour_manual(labels=c("High reef", "Linear reef", "Patch reef"), values= c("red", "green", "blue"))+
  scale_x_continuous(limits = c(1999, 2016), breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016), labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
      legend.position="none",
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      axis.title.x=element_text(size=12),
      axis.title.y=element_text(size=12),
      title=element_text(size=12))
ggsave(file="functional_by_year_and_strata_grouped.pdf", path="plots")

for_legend_gs_horiz = ggplot(matrices_strat_grouped,aes(x=YEAR,y=richness_mean, colour=STRAT_GROUPED, group=STRAT_GROUPED))+ 
  geom_line(aes(group=STRAT_GROUPED),lwd=1) +
  geom_point(size=3) +
  labs(colour = "Strata")+
  scale_colour_manual(labels=c("High reef", "Linear reef", "Patch reef"), values= c("red", "green", "blue"))+
    theme(
      legend.position="right", #"none", "right",c(0.8,0.68),
      legend.text=element_text(size=12),
      legend.key.size=unit(5,"mm"))
legend_gs_horiz <- get_legend(for_legend_gs_horiz)
ggsave(file="legend_year_and_strata_grouped.pdf", legend_gs_horiz, width=10, height=1, path="plots")

#all plots on one page
g_gs <- grid.arrange(abun_gs, bio_gs, even_gs, rich_gs, shan_gs, sim_gs, func_gs, legend_gs_horiz, ncol=2)
ggsave(file="all_by_year_and_strata_grouped.pdf", g_gs, width=7, height=10, path="plots")

```

```{r facet wrap}

all_matrices_data = read_csv("diversity_data.csv")

#Melt dataframe so diversity indices are in a single column
x = reshape2::melt(all_matrices_data, id.vars = c("YEAR", "PROT", "STRAT_GROUPED"), measure.vars=c("abundance_sum", "biomass_sum", "evenness","richness","shannon","simpson","func.div")) 

#Summarize means and SEs by year, subregion, and variable
x=plyr::ddply(x, c("YEAR", "PROT", "STRAT_GROUPED", "variable"), summarize, value.mean=mean(value), value.se=plotrix::std.error(value))

#Rename levels for figure plotting
levels(x$variable)=c("A) Abundance", "B) Biomass", "C) Evenness", "D) Richness", "E) Shannon", "F) Simpson", "G) Functional")#\neffective number of species

x$STRAT_GROUPED=factor(x$STRAT_GROUPED)
levels(x$STRAT_GROUPED)=c("High Relief", "Linear Reef","Patch Reef")

test = ggplot(x, aes(x=YEAR, y=value.mean, color=factor(PROT), group=factor(PROT))) +
  geom_point(aes(group=PROT, color=factor(PROT)))+
  geom_line(aes(group=factor(PROT)))+ #lwd=0.5
  geom_errorbar(aes(ymax=value.mean+value.se,ymin=value.mean-value.se))+ #width=0.1
  labs(title= "", x="Year", y="", color = NULL)+
  facet_grid(variable~STRAT_GROUPED, scales="free_y")+ #switch="y", strata is top label #scales="free"
  scale_color_manual(
    values =  c("blue","red"),
    breaks = c("1", "0"), 
    labels=c("Protected","Not Protected"))+
  scale_x_continuous(
    limits = c(1999, 2016), 
    breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016),
    labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
    legend.position="bottom",
    panel.grid.major=element_blank(),
    panel.grid.minor=element_blank(),
    axis.title.x=element_text(size=12),
    axis.title.y=element_text(size=12),
    title=element_text(size=12))
ggsave(file="all_indices_by_year_grouped_strata_prot.pdf", test, width=7, height=10, path="plots")

test2 = ggplot(x, aes(x=YEAR, y=value.mean, color=factor(PROT), group=factor(PROT))) +
  geom_point(aes(group=PROT, color=factor(PROT)))+
  geom_line(aes(group=factor(PROT)))+ #lwd=0.5
  #geom_errorbar(aes(ymax=value.mean+value.se,ymin=value.mean-value.se))+ #width=0.1
  labs(title= "Grouped strata", x="Year", y="Indices", color = NULL)+
  facet_grid(variable~STRAT_GROUPED, scales="free")+ #strata is top label #scales="free", switch="y"
  scale_color_manual(
    values =  c("blue","red"),
    breaks = c("1", "0"), 
    labels=c("Protected","Not Protected"))+
  scale_x_continuous(
    limits = c(1999, 2016), 
    breaks = c(2000,2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016),
    labels=c("2000","","2004","","2008","","2012","","2016"))+
  theme_bw()+
  theme(
    strip.background = element_blank(),
    legend.position="bottom",
    panel.grid.major=element_blank(),
    panel.grid.minor=element_blank(),
    axis.title.x=element_text(size=12),
    axis.title.y=element_text(size=12),
    plot.title =element_text(hjust = 0.5),
    title=element_text(size=12))
ggsave(file="all_indices_by_year_grouped_strata_prot2.pdf", test2, width=7, height=10, path="plots")

```

Diversity between SPA, SU, ER 

"mapNumber" =  
    0	Unprotected                 [unprotected]
    1	Carysfort                   [Carysfort Sanctuary Preservation Area]
    2	Elbow                       [Elbow Sanctuary Preservation Area]
    3	Key_Largo_Dry_Rocks         [Key Largo Dry Rocks Sanctuary Preservation Area]
    4	Grecian_Rocks               [Grecian Rocks Sanctuary Preservation Area]
    5	French                      [French Reef Sanctuary Preservation Area]
    6	Molasses                    [Molasses Reef Sanctuary Preservation Area]
    7	Conch_Reef                  [Conch Reef Sanctuary Preservation Area]
    8	Conch_RO                    [Conch Reef Research Only Area]
    9	Davis                       [Davis Reef Sanctuary Preservation Area]
    10 Hen_Chickens               [Hen and Chickens Sanctuary Preservation Area]
    11 Cheeca_Rocks               [Cheeca Rocks Sanctuary Preservation Area]
    12 Alligator                  [Alligator Reef Sanctuary Preservation Area]
    13 Tennessee                  [Tennesse Reef Research Only Area]
    14 Coffins_Patch              [Coffins Patch Sanctuary Preservation Area]
    15 Sombrero                   [Sombrero Key Sanctuary Preservation Area]
    16 Looe_Key                   [Looe Key Sanctuary Preservation Area]
    17 Looe_RO                    [Looe Key Research Only Area]
    18 Newfound_Harbor            [Newfound Harbor Key Sanctuary Preservation Area]
    19 East_Sambo                 [Eastern Sambo Research Only Area]
    20 West_Sambo                 [Western Sambo Ecological Reserve]
    21 East_Dry_Rocks             [Eastern Dry Rocks Sanctuary Preservation Area]
    22 Rock_Key                   [Rock Key Sanctuary Preservation Area]
    23 Sand_Key                   [Sand Key Sanctuary Preservation Area]
    24 North Ecological Reserve   [Tortugas North Ecological Reserve]
    25 South Ecological Reserve   [Tortugas South Ecological Reserve]
    26 Research Natural Area      [unprotected]
    27 Not Protected              [unprotected]
    28 Not Protected              [unprotected]

```{r bargraph of diversity among different NTMR}

all_matrices_data = read_csv("diversity_data.csv")

diversity_ntmr = reshape2::melt(all_matrices_data, id.vars = c("MPA_NAME"),measure.vars=c( "richness","shannon","simpson","func.div"))

diversity_ntmr=plyr::ddply(diversity_ntmr, c("MPA_NAME", "variable"), summarize, 
                           value.mean=mean(value),
                           value.se=plotrix::std.error(value))
levels(diversity_ntmr$variable)=c("Richness", "Shannon", "Simpson", "Functional")

as.tibble(diversity_ntmr)

diversity_ntmr_plot = diversity_ntmr %>%
  ggplot(.,aes(x=MPA_NAME, y=value.mean,color=variable, group=variable, fill=variable))+ # 
  geom_errorbar(aes(ymax=value.mean+value.se, ymin=value.mean-value.se), size=.6,width=0.3,position=position_dodge(.9))+
  geom_bar(position="dodge",stat="identity", color="black",size=.3)+
  labs(title="Biodiversity by Different Marine Zones", x="", y="",color="",fill="")+
  scale_fill_manual(
    labels= c("Richness","Shannon","Simpson","Functional"),
    values=c(
             "Richness"="red",
             "Shannon"="orange",
             "Simpson"="forestgreen",
             "Functional"="blue"))+
  theme(
    legend.position = "right",
    legend.title=element_blank(),
    axis.title.x=element_text(size=12),
    axis.title.y=element_text(size=12),
    legend.text=element_text(size=12),
    plot.title=element_text(hjust=0.5))

ggsave(file="diversity_by_level_of_protection_bargraph.pdf",diversity_ntmr_plot, width=10,height=4, path="plots")

```

```{r bargraph of diversity among different strata}

all_matrices_data = read_csv("diversity_data.csv")

diversity_strata = reshape2::melt(all_matrices_data, id.vars = c("STRAT_GROUPED"),
                                measure.vars=c("richness","shannon","simpson","func.div"))

diversity_strata=plyr::ddply(diversity_strata, c("STRAT_GROUPED", "variable"), summarize, 
                           value.mean=mean(value),
                           value.se=plotrix::std.error(value))
levels(diversity_strata$variable)=c("Richness", "Shannon", "Simpson", "Functional")

as.tibble(diversity_strata) 

diversity_strata_bargraph = diversity_strata %>%
  ggplot(.,aes(x=STRAT_GROUPED, y=value.mean,color=variable, group=variable, fill=variable))+ # 
  geom_errorbar(aes(ymax=value.mean+value.se, ymin=value.mean-value.se), size=.6,width=0.3,position=position_dodge(.9))+
  geom_bar(position="dodge",stat="identity", color="black",size=.3)+
  labs(title="Biodiversity by Strata", x="", y="Mean effective \nnumber of species (± SE)",color="",fill="")+
  scale_fill_manual(
    labels= c("Richness","Shannon","Simpson","Functional"),
    values=c("Richness"="red",
             "Shannon"="orange",
             "Simpson"="forestgreen",
             "Functional"="blue"))+
  theme(
    legend.position = "right",
    legend.title=element_blank(),
    axis.title.x=element_text(size=12),
    axis.title.y=element_text(size=12),
    legend.text=element_text(size=12),
    plot.title=element_text(hjust=0.5))

ggsave(file="diversity_by_strata_bargraph.pdf",diversity_strata_bargraph, width=10,height=4, path="plots")
  
```

```{r bargraph of diversity among grouped strata}

all_matrices_data = read_csv("diversity_data.csv")

diversity_strata_grouped = reshape2::melt(all_matrices_data, id.vars = c("STRAT_GROUPED"),
                                measure.vars=c("richness","shannon","simpson","func.div"))

diversity_strata_grouped=plyr::ddply(diversity_strata_grouped, c("STRAT_GROUPED", "variable"), summarize, 
                           value.mean=mean(value),
                           value.se=plotrix::std.error(value))
levels(diversity_strata_grouped$variable)=c("Richness", "Shannon", "Simpson", "Functional")

as.tibble(diversity_strata_grouped) 

# diversity_strata = diversity_strata %>%
#   mutate(STRAT_GROUPED=
#            ifelse(grepl("FDLR", STRAT_GROUPED),'Forereef Deep Linear Reef',
#                   ifelse(grepl('FMLR', STRAT_GROUPED),'Foreef Medium Linear Reef',
#                          ifelse(grepl('FSLR', STRAT_GROUPED),'Foreef Shallow Linear Reef',
#                                 ifelse(grepl('HRRF', STRAT_GROUPED),'High Relief Reef',
#                                        ifelse(grepl('INPR', STRAT_GROUPED),'Inshore Patch Reef',
#                                               ifelse(grepl('MCPR', STRAT_GROUPED),'Midchannel Patch Reef',
#                                                      ifelse(grepl('OFPR', STRAT_GROUPED),'Offshore Patch Reef',"IDK"))))))))
                                       

diversity_strata_grouped_bargraph = diversity_strata_grouped %>%
  ggplot(.,aes(x=STRAT_GROUPED, y=value.mean,color=variable, group=variable, fill=variable))+ # 
  geom_errorbar(aes(ymax=value.mean+value.se, ymin=value.mean-value.se), size=.6,width=0.3,position=position_dodge(.9))+
  geom_bar(position="dodge",stat="identity", color="black",size=.3)+
  labs(title="Biodiversity by Strata", x="", y="Mean effective \nnumber of species (± SE)",color="",fill="")+
  scale_fill_manual(
    labels= c("Richness","Shannon","Simpson","Functional"),
    values=c("Richness"="red",
             "Shannon"="orange",
             "Simpson"="forestgreen",
             "Functional"="blue"))+
  theme(
    legend.position = "right",
    legend.title=element_blank(),
    axis.title.x=element_text(size=12),
    axis.title.y=element_text(size=12),
    legend.text=element_text(size=12),
    plot.title=element_text(hjust=0.5))

ggsave(file="diversity_by_strata_grouped_bargraph.pdf",diversity_strata_grouped_bargraph, width=10,height=4, path="plots")
  
```

```{r SD vs FD}

all_matrices_data = read_csv("diversity_data.csv")

sd_fd_plot_lm = ggplot(all_matrices_data,aes(x=simpson,y=func.div))+ 
  #geom_line(aes(),lwd=1) +
  geom_point(aes(color=STRAT_GROUPED),size=2)+
  geom_smooth(method = "lm", color='#2C3E50')+
  #stat_smooth(method="lm",fill=NA,colour="black",linetype=2,geom="ribbon") 
  labs(title= "", x="Simpson Diversity", y="Functional Diversity", color = NULL)+
  scale_color_manual(labels=c("High Relief", "Linear Relief", "Patch Reef"),values=c("red","blue","green"))+
  theme_bw()+
  theme(
    legend.position="right",
    legend.text = element_text(size=12),
    panel.grid.major=element_blank(),
    panel.grid.minor=element_blank(),
    axis.title.x=element_text(size=12),
    axis.title.y=element_text(size=12),
    title=element_text(size=12))
ggsave(file="simpson_vs_functional_lm.pdf", width=5, height=3.5, path="plots")
#grey area is 95% confidence level interval for predictions from a linear model 

linear_simp_func = lm(simpson~func.div, data = all_matrices_data)
summary(linear_simp_func)
#Adjusted R-squared: 0.2746
#p value:< 2.2e-16 0.000001
#5233 DF
#Residual standard error: 2.792
#F-statistic:  1982

sd_fd_plot_poly = ggplot(all_matrices_data,aes(x=simpson,y=func.div))+ 
  #geom_line(aes(),lwd=1) +
  geom_point(aes(color=STRAT_GROUPED),size=2)+
  geom_smooth(method = "loess", color='#2C3E50')+
  #stat_smooth(method="lm",fill=NA,colour="black",linetype=2,geom="ribbon") 
  labs(title= "", x="Simpson Diversity", y="Functional Diversity", color = NULL)+
  scale_color_manual(labels=c("High Relief", "Linear Relief", "Patch Reef"),values=c("red","blue","green"))+
  theme_bw()+
  theme(
    legend.position="right",
    legend.text = element_text(size=12),
    panel.grid.major=element_blank(),
    panel.grid.minor=element_blank(),
    axis.title.x=element_text(size=12),
    axis.title.y=element_text(size=12),
    title=element_text(size=12))
ggsave(file="simpson_vs_functional_poly.pdf", width=5, height=3.5, path="plots")

sd_fd_year = all_matrices_data %>%
  select(YEAR, PRIMARY_SAMPLE_UNIT, STRAT_GROUPED, PROT, simpson, func.div) %>%
  group_by(YEAR)%>% 
  summarize(
    mean_simpson = mean(simpson),
    mean_func = mean(func.div))

mean_sd_fd_year_lm = ggplot(sd_fd_year,aes(x=mean_simpson,y=mean_func))+ 
  geom_point(aes(),size=2)+ #
  geom_smooth(method="lm", color='#2C3E50')+
  #stat_smooth(method="lm",fill=NA,colour="black",linetype=2,geom="ribbon")
  labs(title= "", x="Simpson Diversity", y="Functional Diversity", color ="")+
  #scale_color_manual(labels=c("High Relief", "Linear Relief", "Patch Reef"),values=c("red","blue","green"))+
  theme_bw()+
  theme(
    legend.position="right",
    legend.text = element_text(size = 12),
    panel.grid.major=element_blank(),
    panel.grid.minor=element_blank(),
    axis.title.x=element_text(size=12),
    axis.title.y=element_text(size=12),
    title=element_text(size=12))
ggsave(file="mean_simpson_vs_functional_year_lm.pdf", width=5, height=3.5, path="plots")

linear_mean_simp_func_year = lm(mean_simpson~mean_func, data = sd_fd_year)
summary(linear_mean_simp_func_year)
#Adjusted R-squared: 0.4063 
#p value: 0.004704
#DF: 14
#Residual standard error: 0.3536

sd_fd_strat = all_matrices_data %>%
  select(YEAR, PRIMARY_SAMPLE_UNIT, STRAT_GROUPED, PROT, simpson, func.div) %>%
  group_by(YEAR, STRAT_GROUPED)%>% #PROT, STRAT_GROUPED
  summarize(
    mean_simpson = mean(simpson),
    mean_func = mean(func.div))

mean_sd_fd_strat_plot_lm = ggplot(sd_fd_strat,aes(x=mean_simpson,y=mean_func))+ 
  geom_point(aes(color=STRAT_GROUPED),size=2)+ #
  geom_smooth(method="lm", color='#2C3E50')+
  #stat_smooth(method="lm",fill=NA,colour="black",linetype=2,geom="ribbon")
  labs(title= "", x="Simpson Diversity", y="Functional Diversity", color ="")+
  scale_color_manual(labels=c("High Relief", "Linear Relief", "Patch Reef"),values=c("red","blue","green"))+
  theme_bw()+
  theme(
    legend.position="right",
    legend.text = element_text(size = 12),
    panel.grid.major=element_blank(),
    panel.grid.minor=element_blank(),
    axis.title.x=element_text(size=12),
    axis.title.y=element_text(size=12),
    title=element_text(size=12))
ggsave(file="mean_simpson_vs_functional_strat_lm.pdf", width=5, height=3.5, path="plots")

linear_mean_simp_func = lm(mean_simpson~mean_func, data = sd_fd_strat)
summary(linear_mean_simp_func)
#Adjusted R-squared: 0.7162
#p value: 2.196e-14
#DF: 46
#Residual standard error: 0.4972

mean_sd_fd_strat_plot_poly = ggplot(sd_fd_strat,aes(x=mean_simpson,y=mean_func))+ 
  geom_point(aes(color=STRAT_GROUPED),size=2)+ #
  geom_smooth(method="loess", color='#2C3E50')+
  #stat_smooth(method="lm",fill=NA,colour="black",linetype=2,geom="ribbon")
  labs(title= "", x="Simpson Diversity", y="Functional Diversity", color ="")+
  scale_color_manual(labels=c("High Relief", "Linear Relief", "Patch Reef"),values=c("red","blue","green"))+
  theme_bw()+
  theme(
    legend.position="right",
    legend.text = element_text(size = 12),
    panel.grid.major=element_blank(),
    panel.grid.minor=element_blank(),
    axis.title.x=element_text(size=12),
    axis.title.y=element_text(size=12),
    title=element_text(size=12))
ggsave(file="mean_simpson_vs_functional_strat_poly.pdf", width=5, height=3.5, path="plots")

sd_fd_strat_prot = all_matrices_data %>%
  select(YEAR, PRIMARY_SAMPLE_UNIT, STRAT_GROUPED, PROT, simpson, func.div) %>%
  group_by(YEAR, STRAT_GROUPED, PROT)%>% 
  summarize(
    mean_simpson = mean(simpson),
    mean_func = mean(func.div))

mean_sd_fd_strat_prot_plot_lm = ggplot(sd_fd_strat_prot,aes(x=mean_simpson,y=mean_func))+ 
  geom_point(aes(color=STRAT_GROUPED),size=2)+ #
  geom_smooth(method="lm", color='#2C3E50')+
  #stat_smooth(method="lm",fill=NA,colour="black",linetype=2,geom="ribbon")
  labs(title= "", x="Simpson Diversity", y="Functional Diversity", color ="")+
  scale_color_manual(labels=c("High Relief", "Linear Relief", "Patch Reef"),values=c("red","blue","green"))+
  theme_bw()+
  theme(
    legend.position="right",
    legend.text = element_text(size = 12),
    panel.grid.major=element_blank(),
    panel.grid.minor=element_blank(),
    axis.title.x=element_text(size=12),
    axis.title.y=element_text(size=12),
    title=element_text(size=12))
ggsave(file="mean_simpson_vs_functional_strat_prot_lm.pdf", width=5, height=3.5, path="plots")

linear_mean_simp_func = lm(mean_simpson~mean_func, data = sd_fd_strat_prot)
summary(linear_mean_simp_func)
#Adjusted R-squared: 0.6473
#p value: < 2.2e-16
#DF: 94
#Residual standard error: 0.6606

mean_sd_fd_plot_strat_prot_poly = ggplot(sd_fd_strat_prot,aes(x=mean_simpson,y=mean_func))+ 
  geom_point(aes(color=STRAT_GROUPED),size=2)+ #
  geom_smooth(method="loess", color='#2C3E50')+
  #stat_smooth(method="lm",fill=NA,colour="black",linetype=2,geom="ribbon")
  labs(title= "", x="Simpson Diversity", y="Functional Diversity", color ="")+
  scale_color_manual(labels=c("High Relief", "Linear Relief", "Patch Reef"),values=c("red","blue","green"))+
  theme_bw()+
  theme(
    legend.position="right",
    legend.text = element_text(size = 12),
    panel.grid.major=element_blank(),
    panel.grid.minor=element_blank(),
    axis.title.x=element_text(size=12),
    axis.title.y=element_text(size=12),
    title=element_text(size=12))
ggsave(file="mean_simpson_vs_functional_strat_prot_poly.pdf", width=5, height=3.5, path="plots")

```

```{r richness vs SD}

all_matrices_data = read_csv("diversity_data.csv")

rich_sd_plot_lm = ggplot(all_matrices_data,aes(x=richness,y=simpson))+ 
  #geom_line(aes(),lwd=1) +
  geom_point(aes(color=STRAT_GROUPED),size=2)+
  geom_smooth(method = "lm", color='#2C3E50')+
  #stat_smooth(method="lm",fill=NA,colour="black",linetype=2,geom="ribbon") 
  labs(title= "", x="Richness", y="Simpson Diversity", color = NULL)+
  scale_color_manual(labels=c("High Relief", "Linear Relief", "Patch Reef"),values=c("red","blue","green"))+
  theme_bw()+
  theme(
    legend.position="right",
    legend.text = element_text(size=12),
    panel.grid.major=element_blank(),
    panel.grid.minor=element_blank(),
    axis.title.x=element_text(size=12),
    axis.title.y=element_text(size=12),
    title=element_text(size=12))
ggsave(file="richness_vs_simpson_lm.pdf", width=5, height=3.5, path="plots")
#grey area is 95% confidence level interval for predictions from a linear model 

linear_rich_simp = lm(simpson~richness, data = all_matrices_data)
summary(linear_rich_simp)
#Adjusted R-squared: 0.08512
#p value:< 2.2e-16
#5233 DF
#Residual standard error: 3.135

rich_sd_plot_poly = ggplot(all_matrices_data,aes(x=richness,y=simpson))+ 
  #geom_line(aes(),lwd=1) +
  geom_point(aes(color=STRAT_GROUPED),size=2)+
  geom_smooth(method = "loess", color='#2C3E50')+
  #stat_smooth(method="lm",fill=NA,colour="black",linetype=2,geom="ribbon") 
  labs(title= "", x="Richness", y="Simpson Diversityy", color = NULL)+
  scale_color_manual(labels=c("High Relief", "Linear Relief", "Patch Reef"),values=c("red","blue","green"))+
  theme_bw()+
  theme(
    legend.position="right",
    legend.text = element_text(size=12),
    panel.grid.major=element_blank(),
    panel.grid.minor=element_blank(),
    axis.title.x=element_text(size=12),
    axis.title.y=element_text(size=12),
    title=element_text(size=12))
ggsave(file="richness_vs_simpson_poly.pdf", width=5, height=3.5, path="plots")

rich_sd_strat = all_matrices_data %>%
  select(YEAR, PRIMARY_SAMPLE_UNIT, STRAT_GROUPED, PROT, simpson, richness) %>%
  group_by(YEAR, STRAT_GROUPED)%>% #PROT, STRAT_GROUPED
  summarize(
    mean_simpson = mean(simpson),
    mean_rich = mean(richness))

mean_rich_sd_strat_plot_lm = ggplot(rich_sd_strat,aes(x=mean_rich,y=mean_simpson))+ 
  geom_point(aes(color=STRAT_GROUPED),size=2)+ #
  geom_smooth(method="lm", color='#2C3E50')+
  #stat_smooth(method="lm",fill=NA,colour="black",linetype=2,geom="ribbon")
  labs(title= "", x="Richness", y="Simpson Diversity", color ="")+
  scale_color_manual(labels=c("High Relief", "Linear Relief", "Patch Reef"),values=c("red","blue","green"))+
  theme_bw()+
  theme(
    legend.position="right",
    legend.text = element_text(size = 12),
    panel.grid.major=element_blank(),
    panel.grid.minor=element_blank(),
    axis.title.x=element_text(size=12),
    axis.title.y=element_text(size=12),
    title=element_text(size=12))
ggsave(file="mean_richness_vs_simpson_strat_lm.pdf", width=5, height=3.5, path="plots")

linear_mean_rich_simp = lm(mean_rich~mean_simpson, data = rich_sd_strat)
summary(linear_mean_rich_simp)
#Adjusted R-squared: 0.4362
#p value: 1.964e-07
#DF: 46
#Residual standard error: 4.364

mean_sd_fd_strat_plot_poly = ggplot(rich_sd_strat,aes(x=mean_rich,y=mean_simpson))+ 
  geom_point(aes(color=STRAT_GROUPED),size=2)+ #
  geom_smooth(method="loess", color='#2C3E50')+
  #stat_smooth(method="lm",fill=NA,colour="black",linetype=2,geom="ribbon")
  labs(title= "Richness", x="", y="Simpson Diversity", color ="")+
  scale_color_manual(labels=c("High Relief", "Linear Relief", "Patch Reef"),values=c("red","blue","green"))+
  theme_bw()+
  theme(
    legend.position="right",
    legend.text = element_text(size = 12),
    panel.grid.major=element_blank(),
    panel.grid.minor=element_blank(),
    axis.title.x=element_text(size=12),
    axis.title.y=element_text(size=12),
    title=element_text(size=12))
#ggsave(file="mean_simpson_vs_functional_strat_poly.pdf", width=5, height=3.5, path="plots")

rich_sd_strat_prot = all_matrices_data %>%
  select(YEAR, PRIMARY_SAMPLE_UNIT, STRAT_GROUPED, PROT, simpson, richness) %>%
  group_by(YEAR, STRAT_GROUPED, PROT)%>% 
  summarize(
    mean_simpson = mean(simpson),
    mean_rich = mean(richness))

mean_rich_sd_strat_prot_plot_lm = ggplot(rich_sd_strat_prot,aes(x=mean_rich,y=mean_simpson))+ 
  geom_point(aes(color=STRAT_GROUPED),size=2)+ #
  geom_smooth(method="lm", color='#2C3E50')+
  #stat_smooth(method="lm",fill=NA,colour="black",linetype=2,geom="ribbon")
  labs(title= "", x="Richness", y="Simpson Diversity", color ="")+
  scale_color_manual(labels=c("High Relief", "Linear Relief", "Patch Reef"),values=c("red","blue","green"))+
  theme_bw()+
  theme(
    legend.position="right",
    legend.text = element_text(size = 12),
    panel.grid.major=element_blank(),
    panel.grid.minor=element_blank(),
    axis.title.x=element_text(size=12),
    axis.title.y=element_text(size=12),
    title=element_text(size=12))
#ggsave(file="mean_simpson_vs_functional_strat_prot_lm.pdf", width=5, height=3.5, path="plots")

linear_mean_rich_simp = lm(mean_rich~mean_simpson, data = rich_sd_strat_prot)
summary(linear_mean_rich_simp)

mean_rich_sd_plot_strat_prot_poly = ggplot(rich_sd_strat_prot,aes(x=mean_rich,y=mean_simpson))+ 
  geom_point(aes(color=STRAT_GROUPED),size=2)+ #
  geom_smooth(method="loess", color='#2C3E50')+
  #stat_smooth(method="lm",fill=NA,colour="black",linetype=2,geom="ribbon")
  labs(title= "", x="Richness", y="Simpson Diversity", color ="")+
  scale_color_manual(labels=c("High Relief", "Linear Relief", "Patch Reef"),values=c("red","blue","green"))+
  theme_bw()+
  theme(
    legend.position="right",
    legend.text = element_text(size = 12),
    panel.grid.major=element_blank(),
    panel.grid.minor=element_blank(),
    axis.title.x=element_text(size=12),
    axis.title.y=element_text(size=12),
    title=element_text(size=12))
#ggsave(file="mean_simpson_vs_functional_strat_prot_poly.pdf", width=5, height=3.5, path="plots")

```

#Statistical tests

```{r test for assumptions of normality }

all_matrices_data = read_csv("diversity_data.csv")

# Manipulate data frame to get total number of PSUs sampled per YEAR and STRATA and also get total PSUs sampled for each YEAR
diversity_data = all_matrices_data

diversity_data$dum1 <- 1
diversity_data_sum1 <- diversity_data %>% group_by(YEAR,STRAT_GROUPED,PRIMARY_SAMPLE_UNIT) %>% summarise(sum1=sum(dum1))
diversity_data_sum1$dum2 <- 1
diversity_data_sum2 <- diversity_data_sum1 %>% group_by(YEAR,STRAT_GROUPED) %>% summarise(sum2=sum(dum2))
diversity_data_sum3 <- dcast(d_fk_sum2, YEAR ~ STRAT_GROUPED, value.var="sum2")
diversity_data_sum3$total <- rowSums(diversity_data_sum3[,-1], na.rm=TRUE)
write.csv(diversity_data_sum3, 'fk_sample_summary.csv',row.names=FALSE) 

diversity_data$dum1 <- 1
diversity_data_sum1 <- diversity_data %>% group_by(YEAR,PRIMARY_SAMPLE_UNIT,STRAT_GROUPED) %>% summarise(sum1=sum(dum1))
diversity_data_sum1$dum2 <- 1
diversity_data_sum2 <- diversity_data_sum1 %>% group_by(YEAR,STRAT_GROUPED) %>% summarise(sum2=sum(dum2))
diversity_data_sum3 <- dcast(diversity_data_sum2, YEAR ~ STRAT_GROUPED, value.var="sum2")
diversity_data_sum3$total <- rowSums(diversity_data_sum3[,-1], na.rm=TRUE)
write.csv(diversity_data_sum3, 'fk_sample_grouped_strata_summary.csv',row.names=FALSE) 

diversity_data$dum1 <- 1
diversity_data_sum1 <- diversity_data %>% group_by(YEAR,PRIMARY_SAMPLE_UNIT,MPA_NAME) %>% summarise(sum1=sum(dum1))
diversity_data_sum1$dum2 <- 1
diversity_data_sum2 <- diversity_data_sum1 %>% group_by(YEAR,MPA_NAME) %>% summarise(sum2=sum(dum2))
diversity_data_sum3 <- dcast(diversity_data_sum2, YEAR ~ MPA_NAME, value.var="sum2")
diversity_data_sum3$total <- rowSums(diversity_data_sum3[,-1], na.rm=TRUE)
write.csv(diversity_data_sum3, 'fk_sample_level_protection_summary.csv',row.names=FALSE)

diversity_data = diversity_data %>%
  group_by(YEAR,PRIMARY_SAMPLE_UNIT, STRAT_GROUPED)

# 1. Run ANOVA to get residuals so we can use them to test assumptions of normality and equal variances
diversity_data$fYEAR <- as.factor(diversity_data$YEAR) # categorical variables are factors
diversity_data$fSTRAT <- as.factor(diversity_data$STRAT_GROUPED) # categorical variables are factors

#Richness

# since there might be an interaction between YEAR and STRAT_GROUPED (i.e., diversity may not change through time consistently across strata or vice versa) use "*" in your model to include an interaction term
richness_aov <- aov(richness~fYEAR*fSTRAT, data=diversity_data) 
diversity_data$resids_rich <- residuals(richness_aov) # get residuals
diversity_data$pred_val_rich <- predict(richness_aov) # get predicted values

#Shannon 
shannon_aov <- aov(shannon~fYEAR*fSTRAT, data=diversity_data)
diversity_data$resids_shan <- residuals(shannon_aov) # get residuals
diversity_data$pred_val_shan <- predict(shannon_aov) # get predicted values

#Simpson
simpson_aov <- aov(simpson~fYEAR*fSTRAT, data=diversity_data)
diversity_data$resids_simp <- residuals(simpson_aov) # get residuals
diversity_data$pred_val_simp <- predict(simpson_aov) # get predicted values

#Functional
func_aov <- aov(func.div~fYEAR*fSTRAT, data=diversity_data)
diversity_data$resids_func <- residuals(func_aov) # get residuals
diversity_data$pred_val_func <- predict(func_aov) # get predicted values

# 2. Examine plots of residuals to qualitatively check for normality and equal variances
ggplot() + geom_density(aes(x=diversity_data$resids_rich)) # look at distribution of residuals
#distribution looks good
plot(richness_aov)
# plot 1: Residuals vs Fitted values - data points should be distibuted evenly above and below the line and across the plot...if they are not, this indicates a violation of assumptions
  # plot 2: Q-Q plot - data points\ should fall more or less along dashed line...if they do not, this indicates a violation of assumptions
#looks good

ggplot() + geom_density(aes(x=diversity_data$resids_shan))
#distribution looks good
plot(shannon_aov)
#residual verse fitted more in the middle than left or right
#Q-Q plot looks alright

ggplot() + geom_density(aes(x=diversity_data$resids_simp))
#distribution looks good
plot(simpson_aov)
#residual verse fitted more in the middle and right than left
#Q-Q plot looks alright

ggplot() + geom_density(aes(x=diversity_data$resids_func))
#distribution looks good
plot(func_aov)
#residual verse fitted looks pretty good
#Q-Q plot looks alright 

# 3 Shapiro-Wilk test - p-value < 0.05 means the data are NOT normally distributed

#richness
diversity_data %$% shapiro.test(resids_rich[1:5000]) 
#W = 0.99298, p-value = 5.484e-15
#Not normally distributed 

#shannon
diversity_data %$% shapiro.test(resids_shan[1:5000]) 
#W = 0.99963, p-value = 0.5044


#simpson
diversity_data %$% shapiro.test(resids_simp[1:5000]) 
#W = 0.99474, p-value = 1.587e-12
#Not normally distributed

#functional
diversity_data %$% shapiro.test(resids_func[1:5000]) 
#W = 0.99699, p-value = 1.816e-08
#Not normally distributed

# 4 Test for skew - greater than zero is evidence for having skew; 
#test with t-test - p-value < 0.05 means data are skewed

# richness
skewness(diversity_data$resids_rich) #-0.3158723
t<- skewness(diversity_data$resids_rich) %>%
  divide_by(sqrt(6/length(diversity_data$resids_rich))) # t-value -9.330271
# probability of the t-value by chance alone when skew is zero; pt=cummulative density function of t-dist, first number=calculated t-value; second=df
1-pt(t,length(diversity_data$resids_rich)) 
#p=1
#distribution of residuals is NOT significantly skewed

# shannon
skewness(diversity_data$resids_shan) #0.02177687 (greater than zero so skewed)
t<- skewness(diversity_data$resids_shan) %>%
  divide_by(sqrt(6/length(diversity_data$resids_shan))) # t-value 0.6432476
1-pt(t,length(diversity_data$resids_shan)) #p-value=0.2600458, greater than 0.05
# distribution of residuals is NOT significantly skewed
  
#Simpson
skewness(diversity_data$resids_simp) #0.27978 (greater than zero so skewed)
t<- skewness(diversity_data$resids_simp) %>% 
  divide_by(sqrt(6/length(diversity_data$resids_simp))) # t-value 8.264173
1-pt(t,length(diversity_data$resids_simp)) #p=1.110223e-16, not greater than 0.05
# distribution of residuals ARE significantly skewed
  
#Functional
skewness(diversity_data$resids_func) #-0.2158813 (not skewed)
t<- skewness(diversity_data$resids_func) %>%
  divide_by(sqrt(6/length(diversity_data$resids_func))) # t-value -6.376726
1-pt(t,length(diversity_data$resids_func)) #1, 
# distribution of residuals is NOT significantly skewed

#4 Bartlett test - p-value < 0.05 means data do not have equal variances across groups
#Richness
bartlett.test(diversity_data$resids_rich~diversity_data$fYEAR)
#Bartlett's K-squared = 80.132, df = 15, p-value = 6.608e-11
bartlett.test(diversity_data$resids_rich~diversity_data$fSTRAT)
#Bartlett's K-squared = 110.04, df = 6, p-value < 2.2e-16
# variances of residuals are significantly different among groups for both YEAR and STRAT_GROUPED

#Shannon
bartlett.test(diversity_data$resids_shan~diversity_data$fYEAR)
#Bartlett's K-squared = 40.706, df = 15, p-value = 0.0003545
bartlett.test(diversity_data$resids_shan~diversity_data$fSTRAT)
#Bartlett's K-squared = 37.594, df = 6, p-value = 1.348e-06
# variances of residuals are significantly different among groups for both YEAR and STRAT_GROUPED

#Simpson
bartlett.test(diversity_data$resids_simp~diversity_data$fYEAR)
#Bartlett's K-squared = 28.603, df = 15, p-value = 0.01809
bartlett.test(diversity_data$resids_simp~diversity_data$fSTRAT)
#Bartlett's K-squared = 62.452, df = 6, p-value = 1.427e-11
# variances of residuals are significantly different among groups for both YEAR and STRAT_GROUPED

#Functional
bartlett.test(diversity_data$resids_func~diversity_data$fYEAR)
#Bartlett's K-squared = 43.096, df = 15, p-value = 0.0001521
bartlett.test(diversity_data$resids_func~diversity_data$fSTRAT)
#Bartlett's K-squared = 43.44, df = 6, p-value = 9.542e-08
# variances of residuals are significantly different among groups for both YEAR and STRAT_GROUPED

#Data are not normally distributed (except shannon),skewed, and have unequal variances  

```

Transform data to better meet the assumptions of normality using Boxcox method 

```{r transform data}

# richness
diversity_data %>%
  boxcox(richness~fYEAR, data = .) %$%
  x[which.max(y)] #x is lambda and y is values of likelihood
# x = 1.353535; this output is the lambda value that you should use to transform data
diversity_data %>%
  boxcox(richness~fSTRAT, data = .) %$%
  x[which.max(y)] #x is lambda and y is values of likelihood
# x = 1.434343
diversity_data <- diversity_data %>% mutate(richness_bc = (richness %>%
  raise_to_power(1.39) %>% subtract(1) %>% divide_by(1.39))) # since x for YEAR and STRAT_GROUPED were so similar, I used something in between; use x/lambda in raise_to_power() and divide_by()

# shannon
diversity_data %>%
  boxcox(shannon~fYEAR, data = .) %$%
  x[which.max(y)] #x is lambda and y is values of likelihood
# x = 0.9090909; this output is the lambda value that you should use to transform data
diversity_data %>%
  boxcox(shannon~fSTRAT, data = .) %$%
  x[which.max(y)] #x is lambda and y is values of likelihood
# x = 0.9090909
diversity_data <- diversity_data %>% mutate(shannon_bc = (shannon %>%
  raise_to_power(.9) %>% subtract(1) %>% divide_by(.9))) # use x/lambda in raise_to_power() and divide_by()

# simpson
diversity_data %>%
  boxcox(simpson~fYEAR, data = .) %$%
  x[which.max(y)] #x is lambda and y is values of likelihood
# x = 0.6666667; this output is the lambda value that you should use to transform data
diversity_data %>%
  boxcox(simpson~fSTRAT, data = .) %$%
  x[which.max(y)] #x is lambda and y is values of likelihood
# x = 0.6666667
diversity_data <- diversity_data %>% mutate(simpson_bc = (simpson %>%
  raise_to_power(.67) %>% subtract(1) %>% divide_by(.67))) # use x/lambda in raise_to_power() and divide_by()

#Functional
diversity_data %>%
  boxcox(func.div~fYEAR, data = .) %$%
  x[which.max(y)] #x is lambda and y is values of likelihood
# x =  1.555556; this output is the lambda value that you should use to transform data
diversity_data %>%
  boxcox(func.div~fSTRAT, data = .) %$%
  x[which.max(y)] #x is lambda and y is values of likelihood
# x = 1.555556
diversity_data <- diversity_data %>% mutate(func.div_bc = (func.div %>%
  raise_to_power(1.56) %>% subtract(1) %>% divide_by(1.56))) # use x/lambda in raise_to_power() and divide_by()

# Retest assumptions with boxcox transformed data 

# 1. Run ANOVA to get residuals so we can use them to test assumptions of normality and equal variances


#Richness
# since there might be an interaction between YEAR and STRAT_GROUPED (i.e., diversity may not change through time consistently across strata or vice versa) use "*" in your model to include an interaction term
richness_aov <- aov(richness_bc~fYEAR*fSTRAT, data=diversity_data) 
diversity_data$resids_rich_bc <- residuals(richness_aov) # get residuals
diversity_data$pred_val_rich_bc <- predict(richness_aov) # get predicted values

#Shannon 
shannon_aov <- aov(shannon_bc~fYEAR*fSTRAT, data=diversity_data)
diversity_data$resids_shan_bc <- residuals(shannon_aov) # get residuals
diversity_data$pred_val_shan_bc <- predict(shannon_aov) # get predicted values

#Simpson
simpson_aov <- aov(simpson_bc~fYEAR*fSTRAT, data=diversity_data)
diversity_data$resids_simp_bc <- residuals(simpson_aov) # get residuals
diversity_data$pred_val_simp_bc <- predict(simpson_aov) # get predicted values

#Functional
func_aov <- aov(func.div_bc~fYEAR*fSTRAT, data=diversity_data)
diversity_data$resids_func_bc <- residuals(func_aov) # get residuals
diversity_data$pred_val_func_bc <- predict(func_aov) # get predicted values

# 2. Examine plots of residuals to qualitatively check for normality and equal variances
ggplot() + geom_density(aes(x=diversity_data$resids_rich_bc)) # look at distribution of residuals
#distribution looks good
plot(richness_aov)
# plot 1: Residuals vs Fitted values - data points should be distibuted evenly above and below the line and across the plot...if they are not, this indicates a violation of assumptions
  # plot 2: Q-Q plot - data points\ should fall more or less along dashed line...if they do not, this indicates a violation of assumptions
#looks good
ggplot(data = diversity_data) + geom_boxplot(mapping = aes(x = STRAT_GROUPED, y = richness_bc)) + facet_wrap(~YEAR, scales="free_y")

ggplot() + geom_density(aes(x=diversity_data$resids_shan_bc))
#distribution looks good
plot(shannon_aov)
#residual verse fitted more in the middle than left or right
#Q-Q plot looks alright

ggplot() + geom_density(aes(x=diversity_data$resids_simp_bc))
#distribution looks good
plot(simpson_aov)
#residual verse fitted more to the right than left
#Q-Q plot looks alright

ggplot() + geom_density(aes(x=diversity_data$resids_func_bc))
#distribution looks good
plot(func_aov)
#residual verse fitted looks pretty good
#Q-Q plot looks alright 

# 3 Shapiro-Wilk test - p-value < 0.05 means the data are NOT normally distributed

#richness
diversity_data %$% shapiro.test(resids_rich_bc[1:5000]) 
#W = 0.99931, p-value = 0.05026
#Normally distributed 

#shannon
diversity_data %$% shapiro.test(resids_shan_bc[1:5000]) 
#W = 0.9994, p-value = 0.1046
#Normally distributed

#simpson
diversity_data %$% shapiro.test(resids_simp_bc[1:5000]) 
#W = 0.99921, p-value = 0.02236
#Not normally distributed

#functional
diversity_data %$% shapiro.test(resids_func_bc[100:5000]) 
#W = 0.99921, p-value = 0.02295
#Not normally distributed

# 4 Test for skew - greater than zero is evidence for having skew; 
#test with t-test - p-value < 0.05 means data are skewed

# richness
skewness(diversity_data$resids_rich_bc) #-0.01965892 - not skewed 
t<- skewness(diversity_data$resids_rich_bc) %>%
  divide_by(sqrt(6/length(diversity_data$resids_rich_bc))) # t-value --0.58068731
# probability of the t-value by chance alone when skew is zero; pt=cummulative density function of t-dist, first number=calculated t-value; second=df
1-pt(t,length(diversity_data$resids_rich_bc)) 
#p=0.7192619
#distribution of residuals are NOT significantly skewed

# shannon
skewness(diversity_data$resids_shan_bc) #-0.06922674 (less than zero so skewed)
t<- skewness(diversity_data$resids_shan_bc) %>%
  divide_by(sqrt(6/length(diversity_data$resids_shan_bc))) # t-value 0.6432476
1-pt(t,length(diversity_data$resids_shan_bc)) #p-value=0.9795391, greater than 0.05
# distribution of residuals are NOT significantly skewed
  
#Simpson
skewness(diversity_data$resids_simp_bc) #-0.04830602 (less than zero so skewed)
t<- skewness(diversity_data$resids_simp_bc) %>% 
  divide_by(sqrt(6/length(diversity_data$resids_simp_bc))) # t-value 
1-pt(t,length(diversity_data$resids_simp)) #p=0.9231613
# distribution of residuals are NOT significantly skewed
  
#Functional
skewness(diversity_data$resids_func_bc) #-0.0475052 (less than zero so skewed)
t<- skewness(diversity_data$resids_func_bc) %>%
  divide_by(sqrt(6/length(diversity_data$resids_func_bc))) # t-value 
1-pt(t,length(diversity_data$resids_func_bc)) #0.9196938
# distribution of residuals are NOT significantly skewed

#4 Bartlett test - p-value < 0.05 means data do not have equal variances across groups
#Richness
bartlett.test(diversity_data$resids_rich_bc~diversity_data$fYEAR)
#Bartlett's K-squared = 58.753, df = 15, p-value = 4.127e-07
bartlett.test(diversity_data$resids_rich_bc~diversity_data$fSTRAT)
#Bartlett's K-squared = 68.924, df = 6, p-value = 6.794e-13
# variances of residuals are significantly different among groups for both YEAR and STRAT_GROUPED

#Shannon
bartlett.test(diversity_data$resids_shan_bc~diversity_data$fYEAR)
#Bartlett's K-squared = 43.224, df = 15, p-value = 0.0001453
bartlett.test(diversity_data$resids_shan_bc~diversity_data$fSTRAT)
#Bartlett's K-squared = 34.477, df = 6, p-value = 5.441e-06
# variances of residuals are significantly different among groups for both YEAR and STRAT_GROUPED

#Simpson
bartlett.test(diversity_data$resids_simp_bc~diversity_data$fYEAR)
#Bartlett's K-squared = 30.61, df = 15, p-value = 0.009901
bartlett.test(diversity_data$resids_simp_bc~diversity_data$fSTRAT)
#Bartlett's K-squared = 42.733, df = 6, p-value = 1.317e-07
# variances of residuals are significantly different among groups for both YEAR and STRAT_GROUPED

#Functional
bartlett.test(diversity_data$resids_func_bc~diversity_data$fYEAR)
#Bartlett's K-squared = 37.139, df = 15, p-value = 0.001208
bartlett.test(diversity_data$resids_func_bc~diversity_data$fSTRAT)
#Bartlett's K-squared = 39.931, df = 6, p-value = 4.7e-07
# variances of residuals are significantly different among groups for both YEAR and STRAT_GROUPED

#Data are not normally distributed (except shannon),skewed, and have unequal variances  proceed with non-parametric tests 

```

nonparametric Kruskal-Wallis test for significance by level of protection 

```{r Kruskal-Wallis test for indices by protection}

all_matrices_data = read_csv("diversity_data.csv")

all_matrices_data$PROT = factor(all_matrices_data$PROT, levels=c("0","1"))
levels(all_matrices_data$PROT)

#abundance  
kruskal.test(all_matrices_data$abundance_sum~all_matrices_data$PROT)
#Kruskal-Wallis chi-squared = 84.392, df = 1, p-value < 2.2e-16
#p=0.001

#biomass 
kruskal.test(all_matrices_data$biomass_sum~all_matrices_data$PROT)
#Kruskal-Wallis chi-squared = 171.92, df = 1, p-value < 2.2e-16
#p=0.001

#evenness - NOT SIGNIFICANT 
kruskal.test(all_matrices_data$evenness~all_matrices_data$PROT)
#Kruskal-Wallis chi-squared = 2.5923, df = 1, p-value = 0.1074

#richness 
kruskal.test(all_matrices_data$richness~all_matrices_data$PROT)
#Kruskal-Wallis chi-squared = 111.72, df = 1, p-value < 2.2e-16

#Shannon 
kruskal.test(all_matrices_data$shannon~all_matrices_data$PROT)
#Kruskal-Wallis chi-squared = 33.185, df = 1, p-value = 8.377e-09

#Simpson 
kruskal.test(all_matrices_data$simpson~all_matrices_data$PROT)
#Kruskal-Wallis chi-squared = 26.378, df = 1, p-value = 2.808e-07

#Functional
kruskal.test(all_matrices_data$func.div~all_matrices_data$PROT)
#Kruskal-Wallis chi-squared = 26.496, df = 1, p-value = 2.641e-07

## All indices are significantly different by level of protection

```

Dunn's test between type of no take zones 
```{r Dunn's test for indices by differnt types of zones}

all_matrices_data = read_csv("diversity_data.csv")

all_matrices_data$MPA_NAME = factor(all_matrices_data$MPA_NAME, levels=c("Not Protected",               "Sanctuary Preservation Area","Ecological Reserve","Special Use"))
levels(all_matrices_data$MPA_NAME)

#richness 
kruskal.test(all_matrices_data$richness~all_matrices_data$MPA_NAME)
#Kruskal-Wallis chi-squared = 164.29, df = 3, p-value < 2.2e-16
dt_rich_mpa = dunnTest(richness~MPA_NAME, data=all_matrices_data)
dt_richnnes_mpa = dt_rich_mpa$res

cldList(P.adj~Comparison,
        data = dt_richnnes_mpa,
        threshold = 0.05)
#ER = Not Protected
#SPA = SU

#Shannon 
kruskal.test(all_matrices_data$shannon~all_matrices_data$MPA_NAME)
#Kruskal-Wallis chi-squared = 37.113, df = 3, p-value = 4.355e-08
dt_shan_mpa = dunnTest(shannon~MPA_NAME, data=all_matrices_data)
dt_shannon_mpa = dt_shan_mpa$res

cldList(P.adj~Comparison,
        data = dt_shannon_mpa,
        threshold = 0.05)
#ER=Not Protected
#ER=SU
#SPA=SU 

#Simpson 
kruskal.test(all_matrices_data$simpson~all_matrices_data$MPA_NAME)
#Kruskal-Wallis chi-squared = 27.878, df = 3, p-value = 3.852e-06
dt_simp_mpa = dunnTest(simpson~MPA_NAME, data=all_matrices_data)
dt_simpson_mpa = dt_simp_mpa$res

cldList(P.adj~Comparison,
        data = dt_simpson_mpa,
        threshold = 0.05)
#ER=Not Protected
#ER=SU
#ER=SPA 
#SPA=SU 

#Functional
kruskal.test(all_matrices_data$func.div~all_matrices_data$MPA_NAME)
#Kruskal-Wallis chi-squared = 32.542, df = 3, p-value = 4.022e-07
dt_fd_mpa = dunnTest(func.div~MPA_NAME, data=all_matrices_data)
dt_functional_mpa = dt_fd_mpa$res

cldList(P.adj~Comparison,
        data = dt_functional_mpa,
        threshold = 0.05)
#ER=SPA
#ER=SU
#SU=SPA
#Not protected not significanyly similar to anything 

## All indices are significantly different by level of protection

```

Dunn's test by grouped strata 

```{r Dunn's test by grouped strata}

all_matrices_data = read_csv("diversity_data.csv") 

matrices_strat_grouped = all_matrices_data %>% 
    group_by(YEAR, STRAT_GROUPED)

matrices_strat_grouped$STRAT_GROUPED = factor(matrices_strat_grouped$STRAT_GROUPED, levels=c('LINEAR_REEF','PATCH_REEF','HIGH_RELIEF'))
levels(matrices_strat_grouped$STRAT_GROUPED)

#abundance
kruskal.test(matrices_strat_grouped$abundance_sum~matrices_strat_grouped$STRAT_GROUPED)
#Kruskal-Wallis chi-squared = 421.77, df = 2, p-value < 2.2e-16
dt_abun_strat = dunnTest(abundance_sum~STRAT_GROUPED, data=matrices_strat_grouped)
dt_abundance_strat = dt_abun_strat$res
cldList(P.adj~Comparison,
        data = dt_abundance_strat,
        threshold = 0.05)
#All sign different

#biomass
kruskal.test(matrices_strat_grouped$biomass_sum~matrices_strat_grouped$STRAT_GROUPED)
#Kruskal-Wallis chi-squared = 438.76, df = 2, p-value < 2.2e-16
dt_bio_strat = dunnTest(biomass_sum~STRAT_GROUPED, data=matrices_strat_grouped)
dt_biomass_strat = dt_bio_strat$res
cldList(P.adj~Comparison,
        data = dt_biomass_strat,
        threshold = 0.05)
#All sign different

#evenness
kruskal.test(matrices_strat_grouped$evenness~matrices_strat_grouped$STRAT_GROUPED)
#Kruskal-Wallis chi-squared = 106.12, df = 2, p-value < 2.2e-16
dt_even_strat = dunnTest(evenness~STRAT_GROUPED, data=matrices_strat_grouped)
dt_evenness_strat = dt_even_strat$res
cldList(P.adj~Comparison,
        data = dt_evenness_strat,
        threshold = 0.05)
#All sign different

#richness
kruskal.test(matrices_strat_grouped$richness~matrices_strat_grouped$STRAT_GROUPED)
#Kruskal-Wallis chi-squared = 721.91, df = 2, p-value < 2.2e-16
dt_rich_strat = dunnTest(richness~STRAT_GROUPED, data=matrices_strat_grouped)
dt_richnnes_strat = dt_rich_strat$res
cldList(P.adj~Comparison,
        data = dt_richnnes_strat,
        threshold = 0.05)
#All significantly different 

#Shannon strata
kruskal.test(matrices_strat_grouped$shannon~matrices_strat_grouped$STRAT_GROUPED)
#Kruskal-Wallis chi-squared = 283.78, df = 2, p-value < 2.2e-16
dt_shan_strat = dunnTest(shannon~STRAT_GROUPED, data=matrices_strat_grouped)
dt_shannon_strat = dt_shan_strat$res
cldList(P.adj~Comparison,
        data = dt_shannon_strat,
        threshold = 0.05)
#All significantly different

#Simpson 
kruskal.test(matrices_strat_grouped$simpson~matrices_strat_grouped$STRAT_GROUPED)
dt_simp_strat = dunnTest(simpson~STRAT_GROUPED, data=matrices_strat_grouped)
dt_simpson_strat = dt_simp_strat$res
#Kruskal-Wallis chi-squared = 191.17, df = 2, p-value < 2.2e-16
cldList(P.adj~Comparison,
        data = dt_simpson_strat,
        threshold = 0.05)
#All significantly different

#Functional  
kruskal.test(matrices_strat_grouped$func.div~matrices_strat_grouped$STRAT_GROUPED)
#Kruskal-Wallis chi-squared = 406.26, df = 2, p-value < 2.2e-16
dt_fd_strat = dunnTest(func.div~STRAT_GROUPED, data=matrices_strat_grouped)
dt_functional_strat = dt_fd_strat$res
cldList(P.adj~Comparison,
        data = dt_functional_strat,
        threshold = 0.05)
#All significantly different

DunnTest_grouped_strata = cbind(dt_abundance_strat, dt_biomass_strat,dt_evenness_strat, dt_richnnes_strat, dt_shannon_strat, dt_simpson_strat, dt_functional_strat)
write_csv(DunnTest_grouped_strata, "DunnTest_grouped_strata.csv") 

```

Dunn's test by grouped strata and protection 

```{r Dunn's test by grouped strata and protection}

all_matrices_data = read_csv("diversity_data.csv")

dt_group_prot = all_matrices_data %>%
  select(YEAR, PRIMARY_SAMPLE_UNIT, PROT, STRAT_GROUPED, abundance_sum, biomass_sum, evenness, richness,shannon,simpson,func.div) %>%
  group_by(PROT, STRAT_GROUPED) %>%
  unite("STRAT_PROT", c("PROT", "STRAT_GROUPED"))

dt_group_prot$STRAT_PROT = factor(dt_group_prot$STRAT_PROT, levels=c('0_LINEAR_REEF','1_LINEAR_REEF','0_PATCH_REEF','1_PATCH_REEF','0_HIGH_RELIEF','1_HIGH_RELIEF'))
levels(dt_group_prot$STRAT_PROT)

#abundance
kruskal.test(dt_group_prot$abundance_sum~dt_group_prot$STRAT_PROT)
#Kruskal-Wallis chi-squared = 453.93, df = 5, p-value < 2.2e-16
dt_abun_strat = dunnTest(abundance_sum~STRAT_PROT, data=dt_group_prot)
dt_abundance_strat = dt_abun_strat$res
cldList(P.adj~Comparison,
        data = dt_abundance_strat,
        threshold = 0.05)
#LR0 = LR1 = PR1

#biomass
kruskal.test(dt_group_prot$biomass_sum~dt_group_prot$STRAT_PROT)
#Kruskal-Wallis chi-squared = 536.26, df = 5, p-value < 2.2e-16
dt_bio_strat = dunnTest(biomass_sum~STRAT_PROT, data=dt_group_prot)
dt_biomass_strat = dt_bio_strat$res
cldList(P.adj~Comparison,
        data = dt_biomass_strat,
        threshold = 0.05)
#HR0=PR1
#LR0=PR0=LR1

#evenness
kruskal.test(dt_group_prot$evenness~dt_group_prot$STRAT_PROT)
#Kruskal-Wallis chi-squared = 113.76, df = 5, p-value < 2.2e-16
dt_even_strat = dunnTest(evenness~STRAT_PROT, data=dt_group_prot)
dt_evenness_strat = dt_even_strat$res
cldList(P.adj~Comparison,
        data = dt_evenness_strat,
        threshold = 0.05)
#HR0=LR0=LR1
#HR0=PR0
#HR0=HR1=LR1

#richness
kruskal.test(dt_group_prot$richness~dt_group_prot$STRAT_PROT)
#Kruskal-Wallis chi-squared = 763.55, df = 5, p-value < 2.2e-16
dt_rich_strat = dunnTest(richness~STRAT_PROT, data=dt_group_prot)
dt_richnnes_strat = dt_rich_strat$res
cldList(P.adj~Comparison,
        data = dt_richnnes_strat,
        threshold = 0.05)
#LR0=LR1=PR1

#Shannon strata
kruskal.test(dt_group_prot$shannon~dt_group_prot$STRAT_PROT)
dt_shan_strat = dunnTest(shannon~STRAT_PROT, data=dt_group_prot)
dt_shannon_strat = dt_shan_strat$res
cldList(P.adj~Comparison,
        data = dt_shannon_strat,
        threshold = 0.05)
#HR0=PR1
#LR0=LR1

#Simpson 
kruskal.test(dt_group_prot$simpson~dt_group_prot$STRAT_PROT)
dt_simp_strat = dunnTest(simpson~STRAT_PROT, data=dt_group_prot)
dt_simpson_strat = dt_simp_strat$res
cldList(P.adj~Comparison,
        data = dt_simpson_strat,
        threshold = 0.05)
#HR0=HR1=PR1
#LR0=LR1

#Functional  
kruskal.test(dt_group_prot$func.div~dt_group_prot$STRAT_PROT)
#Kruskal-Wallis chi-squared = 447.68, df = 5, p-value < 2.2e-16
dt_fd_strat = dunnTest(func.div~STRAT_PROT, data=dt_group_prot)
dt_functional_strat = dt_fd_strat$res
cldList(P.adj~Comparison,
        data = dt_functional_strat,
        threshold = 0.05)
#HR0=HR1=PR1
#LR1=LR0

DunnTest_grouped_strata = cbind(dt_abundance_strat, dt_biomass_strat,dt_evenness_strat, dt_richnnes_strat, dt_shannon_strat, dt_simpson_strat, dt_functional_strat)
write_csv(DunnTest_grouped_strata, "DunnTest_grouped_strata_prot.csv") 


```

Dunn's test by strata 

```{r Dunn's test by strata}

all_matrices_data = read_csv("diversity_data.csv") 

all_matrices_data$STRAT_GROUPED = factor(all_matrices_data$STRAT_GROUPED, levels=c("FMLR", "FSLR", "HRRF", "OFPR", "MCPR", "INPR", "FDLR"))
levels(all_matrices_data$STRAT_GROUPED)

#richness
kruskal.test(all_matrices_data$richness~all_matrices_data$STRAT_GROUPED)
#Kruskal-Wallis chi-squared = 1172.2, df = 6, p-value < 2.2e-16
dt_rich_strat = dunnTest(richness~STRAT_GROUPED, data=all_matrices_data)
dt_richnnes_strat = dt_rich_strat$res

cldList(P.adj~Comparison,
        data = dt_richnnes_strat,
        threshold = 0.05)
#FMLR = OFPR 

#Shannon strata
kruskal.test(all_matrices_data$shannon~all_matrices_data$STRAT_GROUPED)
#Kruskal-Wallis chi-squared = 457.3, df = 6, p-value < 2.2e-16
dt_shan_strat = dunnTest(shannon~STRAT_GROUPED, data=all_matrices_data)
dt_shannon_strat = dt_shan_strat$res

cldList(P.adj~Comparison,
        data = dt_shannon_strat,
        threshold = 0.05)
#FDLR=FSLR
#FDLR=INPR
#FMLR=MCPR

#Simpson 
kruskal.test(all_matrices_data$simpson~all_matrices_data$STRAT_GROUPED)

dt_simp_strat = dunnTest(simpson~STRAT_GROUPED, data=all_matrices_data)
dt_simpson_strat = dt_simp_strat$res
#Kruskal-Wallis chi-squared = 363.58, df = 6, p-value < 2.2e-16
cldList(P.adj~Comparison,
        data = dt_simpson_strat,
        threshold = 0.05)
#FDLR=INPR 
#FMLR=FSLR 
#HRRF=OFPR

#Functional  
kruskal.test(all_matrices_data$func.div~all_matrices_data$STRAT_GROUPED)
#Kruskal-Wallis chi-squared = 706.22, df = 6, p-value < 2.2e-16
dt_fd_strat = dunnTest(func.div~STRAT_GROUPED, data=all_matrices_data)
dt_functional_strat = dt_fd_strat$res

cldList(P.adj~Comparison,
        data = dt_functional_strat,
        threshold = 0.05)
#FDLR=HRRF
#FDLR=MCPR 
#INPR=OFPR 

DunnTest_strata = cbind(dt_richnnes_strat, dt_simpson_strat, dt_shannon_strat, dt_functional_strat)

write_csv(DunnTest_strata, "DunnTest_strata.csv") 

```

```{r mean diff between ntmr}

if(!file.exists('Statistical_analysis/prot_offset.csv')){
  
  all_matrices_data = read_csv("diversity_data.csv")
  
  offsets = all_matrices_data %>%
    select(YEAR, PRIMARY_SAMPLE_UNIT, PROT, abundance_sum, biomass_sum, evenness, richness, shannon, simpson, func.div) %>% 
    group_by(YEAR, PROT) %>%
    summarize(
      abundance_mean = mean(abundance_sum),
      biomass_mean = mean(biomass_sum),
      evenness_mean = mean(evenness),
      richness_mean = mean(richness),
      shannon_mean = mean(shannon),
      simpson_mean = mean(simpson),
      functional_mean = mean(func.div)) %>%
    gather("INDICES", "MEAN", 3:9) %>%
    spread(PROT, MEAN) %>%
    mutate(offset = `1`-`0`) 
  
  prot_offset = offsets %>%
    select(-`1`,-`0`) %>%
    spread(INDICES,offset) %>% 
    ungroup() %>% 
    summarize(
      abun_mean_offset = mean(abundance_mean),
      abun_n_offset = length(abundance_mean),
      abun_sd_offset = sd(abundance_mean),
      abun_se_offset = abun_sd_offset / sqrt(abun_n_offset), 
      bio_mean_offset = mean(biomass_mean),
      bio_n_offset = length(biomass_mean),
      bio_sd_offset = sd(biomass_mean),
      bio_se_offset = bio_sd_offset / sqrt(bio_n_offset),
      even_mean_offset = mean(evenness_mean),
      even_n_offset = length(evenness_mean),
      even_sd_offset = sd(evenness_mean),
      even_se_offset = even_sd_offset / sqrt(even_n_offset),
      rich_mean_offset = mean(richness_mean),
      rich_n_offset = length(richness_mean),
      rich_sd_offset = sd(richness_mean),
      rich_se_offset = rich_sd_offset / sqrt(rich_n_offset),
      shan_mean_offset = mean(shannon_mean),
      shan_n_offset = length(shannon_mean),
      shan_sd_offset = sd(shannon_mean),
      shan_se_offset = shan_sd_offset / sqrt(shan_n_offset),
      simp_mean_offset = mean(simpson_mean),
      simp_n_offset = length(simpson_mean),
      simp_sd_offset = sd(simpson_mean),
      simp_se_offset = simp_sd_offset / sqrt(simp_n_offset),
      func_mean_offset = mean(functional_mean),
      func_n_offset = length(functional_mean),
      func_sd_offset = sd(functional_mean),
      func_se_offset = func_sd_offset / sqrt(func_n_offset))
  
  #write_csv(prot_offset, "Statistical_analysis/prot_offset.csv") 
  }

prot_offset = read_csv("Statistical_analysis/prot_offset.csv")

prot_offset_plot = ggplot(prot_offset, aes(y=mean_offset, x=(prot_offset$Indices),color=(prot_offset$Indices)))+ #color=(prot_offset$Indices) 
  geom_line(aes())+
  geom_point(aes(), lwd=1)+
  geom_errorbar(aes(ymax=mean_offset+se_offset, ymin=mean_offset-se_offset),width=0.1)+
  labs(title="", y="Mean Protection Offset (± SE)", x="",color="")+
  scale_y_continuous(limits = c(0, 110), breaks = c(0,10,20,30,40,50,60,70,80,90,100,110), labels=c("0","10","20","30","40","50","60","70","80","90","100","110"))+
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank())

ggsave(file="prot_offset_plot.pdf", path="plots", prot_offset_plot, width=7, height=4)

prot_offset2 = prot_offset %>%
  filter(Indices != "Abundance")

prot_offset_plot2 = ggplot(prot_offset2, aes(y=mean_offset, x=(prot_offset2$Indices), color=(prot_offset2$Indices)))+  
  geom_line(aes())+
  geom_point(aes()), lwd=1)+
  geom_errorbar(aes(ymax=mean_offset+se_offset, ymin=mean_offset-se_offset),width=0.1)+
  labs(title="", y="Mean Offset (± SE)", x="",color="")+
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank())

```

```{r percent difference}

all_matrices_data = read_csv("diversity_data.csv")

matrices_ntmr = all_matrices_data %>% 
    group_by(PROT) %>% #add subregion later 
    summarize(
      abundance_mean = mean(abundance_sum),
      #abundance_min = min(abundance_sum),
      #abundance_max = max(abundance_sum),
      biomass_mean = mean(biomass_sum),
      #biomass_min = min(biomass_sum),
      #biomass_max = max(biomass_sum),
      evenness_mean = mean(evenness),
      #evenness_min = min(evenness),
      #evenness_max = max(evenness),
      richness_mean = mean(richness),
      #richness_min = min(richness),
      #richness_max = max(richness),
      shannon_mean = mean(shannon),
      #shannon_min = min(shannon),
      #shannon_max = max(shannon),
      simpson_mean = mean(simpson),
      #simpson_min = min(simpson),
      #simpson_max = max(simpson),
      shannon_mean = mean(shannon),
      func.div_mean = mean(func.div)) %>%
      #func.div_min = min(func.div),
      #func.div_max = max(func.div) %>%
  gather("INDICES", "MEAN", 2:8) %>%
  spread(PROT,MEAN) %>%
  mutate(DIFF= (`1`-`0`),
         PERC= (1-(`0`/`1`))*100) 

#no-take marine zones have 18% more individuals, 45% greater biomass, 1% more even, 8% more species, 6% greater shannon and simpson, 2% greater functional 

matrices_ntmr = all_matrices_data %>% 
    #group_by(YEAR) %>% #add subregion later 
    summarize(
      abundance_mean = mean(abundance_sum),
      #abundance_min = min(abundance_sum),
      #abundance_max = max(abundance_sum),
      biomass_mean = mean(biomass_sum),
      #biomass_min = min(biomass_sum),
      #biomass_max = max(biomass_sum),
      evenness_mean = mean(evenness),
      #evenness_min = min(evenness),
      #evenness_max = max(evenness),
      richness_mean = mean(richness),
      #richness_min = min(richness),
      #richness_max = max(richness),
      shannon_mean = mean(shannon),
      #shannon_min = min(shannon),
      #shannon_max = max(shannon),
      simpson_mean = mean(simpson),
      #simpson_min = min(simpson),
      #simpson_max = max(simpson),
      func.div_mean = mean(func.div))
      #func.div_min = min(func.div),
      #func.div_max = max(func.div) 

#(1-(1.857934/8.132598))*100 Simpson diversity is on average across strata and years 77% greater than functional diversity 

#(1-(8.132598/36.82521))*100 Richness is on average across strata and years 78% greater than Simpson diversity (SR was 5 times greater than Simp)

#(1-(13.17177/36.82521))*100 Richness is on average across strata and years 64% greater than Shannon diversity (SR is 3 ties greater than Shannon)

#(1-(1.857934/36.82521))*100 Richness is on average across strata and years 94% greater than Functional diversity or 20 (19.82052) times greater 

```

# GAM and Partial Deviances 

Build GAM model with temporal, spatial, habitat and management variables 

$y_i = \alpha + f_1(X_1i) + f_2(X_2i) + g_1(X_3i) + g_2(X_4i) + \epsilon_i$
$y_i = \alpha + f_1 (YEAR)+ f_2(PROT) + g_1(LONG, LAT)* YEAR + g_2(STRAT_GROUPED) + \epsilon_i$

$y_i$ is the calculated diversity for station i (response variable)
$\alpha$ is the intercept that scales the model prediction to the appropriate level of the response
$f_1 (X_1i)$ is a smoother
$g_1 (X_1i)$ is nonparametric smoother for covariates strata
$\epsilon_i$ the residual error

Temporal variables:
- YEAR: Year (categorical factor)

Spatial variables:
- latitude and longitude (continuous covariate)

Habitat variables: 
- strata (categorical factor)
- bottom depth (continuous covariate)

Management variable:
- PROT: No take marine reserve  (categorical factor)

Conitinuous covariates: modeled using non-parametric smoothing 
- thin plate regression splines with shrinkage terms (Ciannelli et al., 2008)

Categorical factors: models parametrically to determine their mean effect sizes (Zurr et al., 2009)

Fit GAM to each index separately. 

- To assess the explanatory power of each variable calculate the partial deviances by sequentially removing suites of predictors from the full gam model corresponding to indicators of space, time, environment, or management. 

- Repeat this for all possible permutations 

- Average the deviances for all models in which the predictor appeared and calculate the standard error 

- the partial deviances are the proportion of total explained deviance of the model uniquely explained by space, time, environment or management, accounting for the other predictors in the model. 

Modified from [https://stat.ethz.ch/pipermail/r-help/2011-November/295324.html]

- look into mixed effect model GAMM 
- ran GAMM with each combination of variables, weight of AIC

```{r richness GAM}

if(!file.exists("richness_prop.deviance_rds","richness_model_summary_rds")){
  
  all_matrices_data = read_csv("diversity_data.csv") 
  
  gam_data = all_matrices_data %>%
    select(YEAR, PRIMARY_SAMPLE_UNIT, LON_DEGREES, LAT_DEGREES, DEPTH, STRAT_GROUPED, PROT, abundance_sum, biomass_sum, evenness, richness, shannon, simpson, func.div)

#as.data.frame(data)

  richness.partial.deviance.list = for(j in names(gam_data[,11])) { 
  
    #Build full model and null model based on (transformed) response variable
    if(j=="richness") {
      fullmod = mgcv::gam(formula(paste(j,"~YEAR+STRAT_GROUPED+PROT+s(LON_DEGREES,LAT_DEGREES,by=YEAR, bs='ts')+s(DEPTH, bs='ts')")), family=poisson, data=gam_data)
      nullmod = mgcv::gam(formula(paste(j,"~1")), family=poisson, data=gam_data)
    } 
  }
  
  #Set up empty vectors for deviances
  time.dev=c(); space.dev=c(); env.dev=c(); mngt.dev=c()

#Calculate partial deviances by sequentially removing suites of predictors from the full model for all possible permutations (24). 

  #time deviances 
    
  ###Sequence 1: time->space->mangement->environment 

   time.dev[1]= #(deviance(-time)-deviance(full))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)) - #-TIME 
       deviance(fullmod))/
       deviance(nullmod)
   #Warning message: In gam.fit3(x = args$X, y = args$y, sp = lsp, Eb = args$Eb, UrS = args$UrS,  :Algorithm did not converge
    
    space.dev[1] = #(deviance(-time-space)-deviance(-time))/deviance(null) 
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp))) /
       deviance(nullmod)
    
    mngt.dev[1]= #(deviance(-time-space-mngt)-deviance(-time)/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT, sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
       deviance(nullmod) 
    
    env.dev[1]= #(deviance(null)-deviance(-time,-space,-mngt))/deviance(null) 
      (deviance(nullmod)-
      deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT,sp=fullmod$sp[2])))/ 
      deviance(nullmod)

    ###Sequence 2: time->space->environment->mangement
    
    time.dev[2]= #(deviance(-time)-deviance(full))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    space.dev[2]= #(deviance(-time-space)-deviance(-time))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
       deviance(nullmod)
    
    env.dev[2]= #(deviance(-time-space-env)-deviance(-time))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')))-
       deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
       deviance(nullmod)
    
    mngt.dev[2]= #(deviance(null)-deviance(-time-space-env))/deviance(null)
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts'))))/
       deviance(nullmod)

    ###sequence 3: time->management->environment->space  
    
    time.dev[3]= 
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    mngt.dev[3]=
      (deviance(update(fullmod,.~.-YEAR-PROT, sp=fullmod$sp))-
       deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
       deviance(nullmod)

    env.dev[3]=
      (deviance(update(fullmod,.~.-YEAR-PROT-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
       deviance(nullmod)
    
    space.dev[3]=
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-YEAR-PROT-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    ###sequence 4: time->management->space->environment  
    
    time.dev[4]=
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    mngt.dev[4]= #(deviance(-time-mngt)-deviance(-time))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-PROT, sp=fullmod$sp))-
       deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
       deviance(nullmod)

    space.dev[4]= #(deviance(-time-mngt-space))
      (deviance(update(fullmod,.~.-YEAR-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
       deviance(nullmod)
    
    env.dev[4]= #deviance(null)-deviance(-time-mngt-space)/deviance(null)
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-YEAR-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2])))/
       deviance(nullmod)

    ###Sequence 5: time->environment->space->management
    
    time.dev[5]=
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    env.dev[5]= #-time, -envt
      (deviance(update(fullmod,.~.-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'), sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
       deviance(nullmod)

    space.dev[5]= #-time, -envt, -space
      (deviance(update(fullmod,.~.-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
       deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
       deviance(nullmod)
  
    mngt.dev[5]=
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-YEAR-PROT-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
       deviance(nullmod)
    
    ###Sequence 6: time->environment->management->space
    
    time.dev[6]=
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    env.dev[6]= #-time, -env
      (deviance(update(fullmod,.~.-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
       deviance(nullmod)
    
    mngt.dev[6]= #-time, -env, -mngt
      (deviance(update(fullmod,.~.-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT, sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
       deviance(nullmod)
  
    space.dev[6]= #-time, -envt, -mngt
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT, sp=fullmod$sp[1])))/
       deviance(nullmod)

#SPACE
    
    ###Sequence 7: space->time->management->environment
    space.dev[7]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    time.dev[7]= #-space, -time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR, sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
    mngt.dev[7]= #-space, -time, -prot 
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-PROT,sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
    env.dev[7]= #-space, -time, -prot
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-PROT,sp=fullmod$sp[2])))/
       deviance(nullmod)

    ###Sequence 8: space->time->environment->management
    
    space.dev[8]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    time.dev[8]= #-space, -time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR,sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
    
    env.dev[8]= #-space, -time, -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts')))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
    mngt.dev[8]= #-space, -time, -env
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'))))/
       deviance(nullmod)    
    
    ###Sequence 9: space->environment->mangement->time
    
    space.dev[9]=
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(fullmod))/ 
       deviance(nullmod)
    
     env.dev[9]= #-space, -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))) /
       deviance(nullmod)
    
    mngt.dev[9]= #-space, -env, -prot
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2])))/
       deviance(nullmod)
    
     time.dev[9]= #-space, -env, -prot
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT)))/
       deviance(nullmod)
     
    ###Sequence 10: space->environment->time->mangement 
    
     space.dev[10]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2]))-
       deviance(fullmod))/ 
       deviance(nullmod)
    
     env.dev[10]= #-space -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
     time.dev[10]= #-space -env -time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2])))/
       deviance(nullmod)
    
     mngt.dev[10]=
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR)))/
       deviance(nullmod)
     
    ###Sequence 11: space->mangement->time->environment 
    space.dev[11]=
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(fullmod))/
       deviance(nullmod)
    
     mngt.dev[11]=
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT,sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
     time.dev[11]= #-space,-prot,-time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-YEAR,sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
     env.dev[11]=
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-YEAR),sp=fullmod$sp[2]))/
       deviance(nullmod)
     
    ###Sequence 12: space->mangement->environment->time
     
    space.dev[12]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2]))-
       deviance(fullmod))/
       deviance(nullmod)
    
     mngt.dev[12]= #-space -prot
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT,sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
    env.dev[12]= #-space -prot -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-STRAT_GROUPED-s(DEPTH,bs='ts')))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
     time.dev[12]= #-space -prot -env
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-STRAT_GROUPED-s(DEPTH,bs='ts'))))/
       deviance(nullmod)

#ENVIRONMENT

    ###Sequence 13: environment->time->space->management 
    
     env.dev[13]= #-env
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    time.dev[13]= #-env, -time
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR,sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    space.dev[13]= #-env, -time, -space 
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
      deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    mngt.dev[13]= #-env, -time, -space 
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
       deviance(nullmod)
    
    ###Sequence 14: environment->time->management->space
    
    env.dev[14]= #-env
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    time.dev[14]= #-env, -time
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR, sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    mngt.dev[14]=  #-env -time -prot
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR-PROT, sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    space.dev[14]= #-env -time -prot
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR-PROT,sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    ###Sequence 15: environment->space->management->time
    
    env.dev[15]= #-env
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    space.dev[15]= #-env -space
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
      deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    mngt.dev[15]= #-env -space -prot
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT))-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    time.dev[15]= #-env -space -prot
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT)))/
       deviance(nullmod)
    
    #Sequence 16: environment->space->time->management
    
    env.dev[16]= #-env
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    space.dev[16]= #-env -space
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    time.dev[16]= #-env -space -time
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR))-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    mngt.dev[16]=
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR)))/        deviance(nullmod)
    
    #Sequence 17: environment->management->space->time
    env.dev[17]= #-env
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    mngt.dev[17]= #-env -prot
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT,sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    space.dev[17]=  #-env -prot -space
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    time.dev[17]= #-env -prot -space
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
       deviance(nullmod)
    
    ###Sequence 18: environment->management->time->space
    
    env.dev[18]= #-env
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    mngt.dev[18]= #-env -prot
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT,sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    time.dev[18]= #-env -prot -time 
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT-YEAR,sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    space.dev[18]= #-env -prot -time 
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT-YEAR,sp=fullmod$sp[1])))/
       deviance(nullmod)

# MANAGEMENT 

    #Sequence 19: management->environment->time->space
    mngt.dev[19]= #-prot
      (deviance(update(fullmod,.~.-PROT,sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    env.dev[19]= #-prot -env
      (deviance(update(fullmod,.~.-PROT-STRAT_GROUPED-s(DEPTH,bs='ts'), sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
       deviance(nullmod)
    
    time.dev[19]= #-prot -env -time
      (deviance(update(fullmod,.~.-PROT-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR, sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    space.dev[19]= #-prot -env -time
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-PROT-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR,sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    #Sequence 20: management->environment->space->time
    
    mngt.dev[20]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    env.dev[20]= #-prot -env 
      (deviance(update(fullmod,.~.-PROT-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    space.dev[20]=  #-prot -env -space
      (deviance(update(fullmod,.~.-PROT-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    time.dev[20]= #-prot -env -space
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-PROT-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
       deviance(nullmod)
    
    #Sequence 21: management->space->time->environment
    mngt.dev[21]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    space.dev[21]= #-prot, -space
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
       deviance(nullmod)
    
    time.dev[21]= #-prot, -space -time
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR, sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    env.dev[21]= #-prot, -space -time
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR, sp=fullmod$sp[2])))/
       deviance(nullmod)
    
    #Sequence 22: management->space->environment->time
    
    mngt.dev[22]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    space.dev[22]= #-prot -space
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    env.dev[22]= #-prot -space -env
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    time.dev[22]= #-prot -space -env
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts'))))/
       deviance(nullmod)
    
    #Sequence 23: management->time->space->environment
    
    mngt.dev[23]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    time.dev[23]= #-prot -space
      (deviance(update(fullmod,.~.-PROT-YEAR,sp=fullmod$sp))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    env.dev[23]= #-prot -time -env
      (deviance(update(fullmod,.~.-PROT-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
       deviance(nullmod)
    
    space.dev[23]= #-prot -time -env
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-PROT-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'), sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    #Squence 24: management->time->environment->space
   
     mngt.dev[24]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
     time.dev[24]= #-prot -time
      (deviance(update(fullmod,.~.-PROT-YEAR, sp=fullmod$sp))-
       deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
       deviance(nullmod)
    
    env.dev[24]= #-prot -time -env
      (deviance(update(fullmod,.~.-PROT-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'), sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
       deviance(nullmod)
    
    space.dev[24]=  #-prot -time -env
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-PROT-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)

#Average the deviances for all models in which a predictor appeared and calculate a standard error. The partial deviances are therefore the proportion of total explained deviance of the model uniquely explained by space, time, environment or management. 
    
  #Bind results into data.frame
  richness_prop.deviance=data.frame(
    diversity=paste(j),
    predictor=c("All","Space","Time","Habitat Structure","No-Take Zones"),
    rich_partial_deviance=c(summary(fullmod)$dev.expl,mean(space.dev),mean(time.dev),mean(env.dev),mean(mngt.dev)),
    rich_partial_deviance_SE=c(0,std.error(space.dev),std.error(time.dev),std.error(env.dev),std.error(mngt.dev)))
  
  richness_model_summary = summary(fullmod)
  
  saveRDS(richness_prop.deviance, "richness_prop.deviance_rds")
  saveRDS(richness_model_summary, "richness_model_summary_rds")
  
  }else{
  richness_prop.deviance = read_rds("richness_prop.deviance_rds")
  richness_model_summary = read_rds("richness_model_summary_rds")
  }

richness_prop.deviance$Predictor=car::recode(richness_prop.deviance$Predictor, "'All'='All';'Time'='Time';'Space'='Space';'Habitat'='Habitat Structure';'Management'='No-Take Zones'")
  
```

```{r abun GAM}

if(!file.exists("abun_prop.deviance_rds","abun_model_summary_rds")){
  
  gam_data = all_matrices_data %>%
    select(YEAR, PRIMARY_SAMPLE_UNIT, LON_DEGREES, LAT_DEGREES, DEPTH, STRAT_GROUPED, PROT, abundance_sum, biomass_sum, evenness, richness, simpson, shannon, func.div)
  
  abun_partial.deviance.list = for(j in names(gam_data[,8])) { 
    
    #Build full model and null model based on (transformed) response variable
    fullmod = gam(formula(paste("log(",j,")~YEAR+STRAT_GROUPED+PROT+s(LON_DEGREES,LAT_DEGREES, by=YEAR, bs='ts')+s(DEPTH, bs='ts')")), data=gam_data)
    nullmod = gam(formula(paste("log(",j,")~1")), data=gam_data)
    
    #Set up empty vectors for deviances
    time.dev=c(); space.dev=c(); env.dev=c(); mngt.dev=c()
    
    #Calculate partial deviances by sequentially removing suites of predictors from the full model for all possible permutations (24). 
    
    #time deviances 
    
    ###Sequence 1: time->space->mangement->environment 
    
    time.dev[1]= #(deviance(-time)-deviance(full))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)) - #-TIME 
         deviance(fullmod))/
      deviance(nullmod)
    
    space.dev[1] = #(deviance(-time-space)-deviance(-time))/deviance(null) 
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp))) /
      deviance(nullmod)
    
    mngt.dev[1]= #(deviance(-time-space-mngt)-deviance(-time)/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT, sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
      deviance(nullmod) 
    
    env.dev[1]= #(deviance(null)-deviance(-time,-space,-mngt))/deviance(null) 
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT,sp=fullmod$sp[2])))/ 
      deviance(nullmod)
    
    ###Sequence 2: time->space->environment->mangement
    
    time.dev[2]= #(deviance(-time)-deviance(full))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    space.dev[2]= #(deviance(-time-space)-deviance(-time))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
      deviance(nullmod)
    
    env.dev[2]= #(deviance(-time-space-env)-deviance(-time))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')))-
         deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
      deviance(nullmod)
    
    mngt.dev[2]= #(deviance(null)-deviance(-time-space-env))/deviance(null)
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts'))))/
      deviance(nullmod)
    
    ###sequence 3: time->management->environment->space  
    
    time.dev[3]= 
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    mngt.dev[3]=
      (deviance(update(fullmod,.~.-YEAR-PROT, sp=fullmod$sp))-
         deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
      deviance(nullmod)
    
    env.dev[3]=
      (deviance(update(fullmod,.~.-YEAR-PROT-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
      deviance(nullmod)
    
    space.dev[3]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-YEAR-PROT-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    ###sequence 4: time->management->space->environment  
    
    time.dev[4]=
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    mngt.dev[4]= #(deviance(-time-mngt)-deviance(-time))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-PROT, sp=fullmod$sp))-
         deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
      deviance(nullmod)
    
    space.dev[4]= #(deviance(-time-mngt-space))
      (deviance(update(fullmod,.~.-YEAR-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
      deviance(nullmod)
    
    env.dev[4]= #deviance(null)-deviance(-time-mngt-space)/deviance(null)
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-YEAR-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    ###Sequence 5: time->environment->space->management
    
    time.dev[5]=
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    env.dev[5]= #-time, -envt
      (deviance(update(fullmod,.~.-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'), sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
      deviance(nullmod)
    
    space.dev[5]= #-time, -envt, -space
      (deviance(update(fullmod,.~.-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
         deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
      deviance(nullmod)
    
    mngt.dev[5]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-YEAR-PROT-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
      deviance(nullmod)
    
    ###Sequence 6: time->environment->management->space
    
    time.dev[6]=
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    env.dev[6]= #-time, -env
      (deviance(update(fullmod,.~.-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
      deviance(nullmod)
    
    mngt.dev[6]= #-time, -env, -mngt
      (deviance(update(fullmod,.~.-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT, sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
      deviance(nullmod)
    
    space.dev[6]= #-time, -envt, -mngt
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT, sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    #SPACE
    
    ###Sequence 7: space->time->management->environment
    space.dev[7]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    time.dev[7]= #-space, -time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR, sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    mngt.dev[7]= #-space, -time, -prot 
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-PROT,sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    env.dev[7]= #-space, -time, -prot
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-PROT,sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    ###Sequence 8: space->time->environment->management
    
    space.dev[8]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    time.dev[8]= #-space, -time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR,sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    env.dev[8]= #-space, -time, -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts')))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    mngt.dev[8]= #-space, -time, -env
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'))))/
      deviance(nullmod)    
    
    ###Sequence 9: space->environment->mangement->time
    
    space.dev[9]=
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(fullmod))/ 
      deviance(nullmod)
    
    env.dev[9]= #-space, -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))) /
      deviance(nullmod)
    
    mngt.dev[9]= #-space, -env, -prot
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    time.dev[9]= #-space, -env, -prot
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT)))/
      deviance(nullmod)
    
    ###Sequence 10: space->environment->time->mangement 
    
    space.dev[10]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2]))-
         deviance(fullmod))/ 
      deviance(nullmod)
    
    env.dev[10]= #-space -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    time.dev[10]= #-space -env -time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    mngt.dev[10]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR)))/
      deviance(nullmod)
    
    ###Sequence 11: space->mangement->time->environment 
    space.dev[11]=
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    mngt.dev[11]=
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT,sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    time.dev[11]= #-space,-prot,-time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-YEAR,sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    env.dev[11]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-YEAR),sp=fullmod$sp[2]))/
      deviance(nullmod)
    
    ###Sequence 12: space->mangement->environment->time
    
    space.dev[12]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    mngt.dev[12]= #-space -prot
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT,sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    env.dev[12]= #-space -prot -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-STRAT_GROUPED-s(DEPTH,bs='ts')))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    time.dev[12]= #-space -prot -env
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-STRAT_GROUPED-s(DEPTH,bs='ts'))))/
      deviance(nullmod)
    
    #ENVIRONMENT
    
    ###Sequence 13: environment->time->space->management 
    
    env.dev[13]= #-env
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    time.dev[13]= #-env, -time
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR,sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    space.dev[13]= #-env, -time, -space 
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    mngt.dev[13]= #-env, -time, -space 
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
      deviance(nullmod)
    
    ###Sequence 14: environment->time->management->space
    
    env.dev[14]= #-env
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    time.dev[14]= #-env, -time
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR, sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    mngt.dev[14]=  #-env -time -prot
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR-PROT, sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    space.dev[14]= #-env -time -prot
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR-PROT,sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    ###Sequence 15: environment->space->management->time
    
    env.dev[15]= #-env
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    space.dev[15]= #-env -space
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    mngt.dev[15]= #-env -space -prot
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT))-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    time.dev[15]= #-env -space -prot
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT)))/
      deviance(nullmod)
    
    #Sequence 16: environment->space->time->management
    
    env.dev[16]= #-env
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    space.dev[16]= #-env -space
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    time.dev[16]= #-env -space -time
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR))-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    mngt.dev[16]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR)))/        deviance(nullmod)
    
    #Sequence 17: environment->management->space->time
    env.dev[17]= #-env
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    mngt.dev[17]= #-env -prot
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT,sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    space.dev[17]=  #-env -prot -space
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    time.dev[17]= #-env -prot -space
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
      deviance(nullmod)
    
    ###Sequence 18: environment->management->time->space
    
    env.dev[18]= #-env
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    mngt.dev[18]= #-env -prot
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT,sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    time.dev[18]= #-env -prot -time 
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT-YEAR,sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    space.dev[18]= #-env -prot -time 
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT-YEAR,sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    # MANAGEMENT 
    
    #Sequence 19: management->environment->time->space
    mngt.dev[19]= #-prot
      (deviance(update(fullmod,.~.-PROT,sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    env.dev[19]= #-prot -env
      (deviance(update(fullmod,.~.-PROT-STRAT_GROUPED-s(DEPTH,bs='ts'), sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
      deviance(nullmod)
    
    time.dev[19]= #-prot -env -time
      (deviance(update(fullmod,.~.-PROT-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR, sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
      deviance(nullmod)
    
    space.dev[19]= #-prot -env -time
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-PROT-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR,sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    #Sequence 20: management->environment->space->time
    
    mngt.dev[20]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    env.dev[20]= #-prot -env 
      (deviance(update(fullmod,.~.-PROT-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
      deviance(nullmod)
    
    space.dev[20]=  #-prot -env -space
      (deviance(update(fullmod,.~.-PROT-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
         deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
      deviance(nullmod)
    
    time.dev[20]= #-prot -env -space
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-PROT-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
      deviance(nullmod)
    
    #Sequence 21: management->space->time->environment
    mngt.dev[21]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    space.dev[21]= #-prot, -space
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
      deviance(nullmod)
    
    time.dev[21]= #-prot, -space -time
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR, sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
      deviance(nullmod)
    
    env.dev[21]= #-prot, -space -time
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR, sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    #Sequence 22: management->space->environment->time
    
    mngt.dev[22]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    space.dev[22]= #-prot -space
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
      deviance(nullmod)
    
    env.dev[22]= #-prot -space -env
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')))-
         deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
      deviance(nullmod)
    
    time.dev[22]= #-prot -space -env
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts'))))/
      deviance(nullmod)
    
    #Sequence 23: management->time->space->environment
    
    mngt.dev[23]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    time.dev[23]= #-prot -space
      (deviance(update(fullmod,.~.-PROT-YEAR,sp=fullmod$sp))-
         deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
      deviance(nullmod)
    
    env.dev[23]= #-prot -time -env
      (deviance(update(fullmod,.~.-PROT-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
      deviance(nullmod)
    
    space.dev[23]= #-prot -time -env
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-PROT-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'), sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    #Squence 24: management->time->environment->space
    
    mngt.dev[24]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    time.dev[24]= #-prot -time
      (deviance(update(fullmod,.~.-PROT-YEAR, sp=fullmod$sp))-
         deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
      deviance(nullmod)
    
    env.dev[24]= #-prot -time -env
      (deviance(update(fullmod,.~.-PROT-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'), sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
      deviance(nullmod)
    
    space.dev[24]=  #-prot -time -env
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-PROT-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
  }
  #Average the deviances for all models in which a predictor appeared and calculate a standard error. The partial deviances are therefore the proportion of total explained deviance of the model uniquely explained by space, time, environment or management. 
  
  #Bind results into data.frame
  abun_prop.deviance=data.frame(
    Diversity=paste(j),
    Predictor=c("All","Space","Time","Habitat Structure","No-Take Zones"),
    abun_partial_deviance=c(summary(fullmod)$dev.expl,mean(space.dev),mean(time.dev),mean(env.dev),mean(mngt.dev)),
    abun_partial_deviance.SE=c(0,std.error(space.dev),std.error(time.dev),std.error(env.dev),std.error(mngt.dev)))
  
  abun_model_summary = summary(fullmod)
  
  saveRDS(abun_prop.deviance, "abun_prop.deviance_rds")
  saveRDS(abun_model_summary, "abun_model_summary_rds")
  
}else{
  abun_prop.deviance = read_rds("abun_prop.deviance_rds")
  abun_model_summary = read_rds("abun_model_summary_rds")
}

```

```{r biomass GAM}

if(!file.exists("bio_prop.deviance_rds", "bio_model_summary_rds")){
  
  gam_data = all_matrices_data %>%
    select(YEAR, PRIMARY_SAMPLE_UNIT, LON_DEGREES, LAT_DEGREES, DEPTH, STRAT_GROUPED, PROT, abundance_sum, biomass_sum, evenness, richness, simpson, shannon, func.div)
  
  bio_partial.deviance.list = for(j in names(gam_data[,9])) { 
    
    #Build full model and null model based on (transformed) response variable
    fullmod = gam(formula(paste("log(",j,")~YEAR+STRAT_GROUPED+PROT+s(LON_DEGREES,LAT_DEGREES, by=YEAR, bs='ts')+s(DEPTH, bs='ts')")), data=gam_data)
    nullmod = gam(formula(paste("log(",j,")~1")), data=gam_data)
    
    #Set up empty vectors for deviances
    time.dev=c(); space.dev=c(); env.dev=c(); mngt.dev=c()
    
    #Calculate partial deviances by sequentially removing suites of predictors from the full model for all possible permutations (24). 
    
    #time deviances 
    
    ###Sequence 1: time->space->mangement->environment 
    
    time.dev[1]= #(deviance(-time)-deviance(full))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)) - #-TIME 
         deviance(fullmod))/
      deviance(nullmod)
    
    space.dev[1] = #(deviance(-time-space)-deviance(-time))/deviance(null) 
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp))) /
      deviance(nullmod)
    
    mngt.dev[1]= #(deviance(-time-space-mngt)-deviance(-time)/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT, sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
      deviance(nullmod) 
    
    env.dev[1]= #(deviance(null)-deviance(-time,-space,-mngt))/deviance(null) 
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT,sp=fullmod$sp[2])))/ 
      deviance(nullmod)
    
    ###Sequence 2: time->space->environment->mangement
    
    time.dev[2]= #(deviance(-time)-deviance(full))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    space.dev[2]= #(deviance(-time-space)-deviance(-time))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
      deviance(nullmod)
    
    env.dev[2]= #(deviance(-time-space-env)-deviance(-time))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')))-
         deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
      deviance(nullmod)
    
    mngt.dev[2]= #(deviance(null)-deviance(-time-space-env))/deviance(null)
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts'))))/
      deviance(nullmod)
    
    ###sequence 3: time->management->environment->space  
    
    time.dev[3]= 
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    mngt.dev[3]=
      (deviance(update(fullmod,.~.-YEAR-PROT, sp=fullmod$sp))-
         deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
      deviance(nullmod)
    
    env.dev[3]=
      (deviance(update(fullmod,.~.-YEAR-PROT-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
      deviance(nullmod)
    
    space.dev[3]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-YEAR-PROT-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    ###sequence 4: time->management->space->environment  
    
    time.dev[4]=
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    mngt.dev[4]= #(deviance(-time-mngt)-deviance(-time))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-PROT, sp=fullmod$sp))-
         deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
      deviance(nullmod)
    
    space.dev[4]= #(deviance(-time-mngt-space))
      (deviance(update(fullmod,.~.-YEAR-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
      deviance(nullmod)
    
    env.dev[4]= #deviance(null)-deviance(-time-mngt-space)/deviance(null)
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-YEAR-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    ###Sequence 5: time->environment->space->management
    
    time.dev[5]=
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    env.dev[5]= #-time, -envt
      (deviance(update(fullmod,.~.-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'), sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
      deviance(nullmod)
    
    space.dev[5]= #-time, -envt, -space
      (deviance(update(fullmod,.~.-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
         deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
      deviance(nullmod)
    
    mngt.dev[5]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-YEAR-PROT-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
      deviance(nullmod)
    
    ###Sequence 6: time->environment->management->space
    
    time.dev[6]=
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    env.dev[6]= #-time, -env
      (deviance(update(fullmod,.~.-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
      deviance(nullmod)
    
    mngt.dev[6]= #-time, -env, -mngt
      (deviance(update(fullmod,.~.-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT, sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
      deviance(nullmod)
    
    space.dev[6]= #-time, -envt, -mngt
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT, sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    #SPACE
    
    ###Sequence 7: space->time->management->environment
    space.dev[7]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    time.dev[7]= #-space, -time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR, sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    mngt.dev[7]= #-space, -time, -prot 
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-PROT,sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    env.dev[7]= #-space, -time, -prot
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-PROT,sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    ###Sequence 8: space->time->environment->management
    
    space.dev[8]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    time.dev[8]= #-space, -time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR,sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    env.dev[8]= #-space, -time, -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts')))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    mngt.dev[8]= #-space, -time, -env
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'))))/
      deviance(nullmod)    
    
    ###Sequence 9: space->environment->mangement->time
    
    space.dev[9]=
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(fullmod))/ 
      deviance(nullmod)
    
    env.dev[9]= #-space, -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))) /
      deviance(nullmod)
    
    mngt.dev[9]= #-space, -env, -prot
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    time.dev[9]= #-space, -env, -prot
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT)))/
      deviance(nullmod)
    
    ###Sequence 10: space->environment->time->mangement 
    
    space.dev[10]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2]))-
         deviance(fullmod))/ 
      deviance(nullmod)
    
    env.dev[10]= #-space -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    time.dev[10]= #-space -env -time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    mngt.dev[10]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR)))/
      deviance(nullmod)
    
    ###Sequence 11: space->mangement->time->environment 
    space.dev[11]=
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    mngt.dev[11]=
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT,sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    time.dev[11]= #-space,-prot,-time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-YEAR,sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    env.dev[11]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-YEAR),sp=fullmod$sp[2]))/
      deviance(nullmod)
    
    ###Sequence 12: space->mangement->environment->time
    
    space.dev[12]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    mngt.dev[12]= #-space -prot
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT,sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    env.dev[12]= #-space -prot -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-STRAT_GROUPED-s(DEPTH,bs='ts')))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    time.dev[12]= #-space -prot -env
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-STRAT_GROUPED-s(DEPTH,bs='ts'))))/
      deviance(nullmod)
    
    #ENVIRONMENT
    
    ###Sequence 13: environment->time->space->management 
    
    env.dev[13]= #-env
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    time.dev[13]= #-env, -time
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR,sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    space.dev[13]= #-env, -time, -space 
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    mngt.dev[13]= #-env, -time, -space 
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
      deviance(nullmod)
    
    ###Sequence 14: environment->time->management->space
    
    env.dev[14]= #-env
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    time.dev[14]= #-env, -time
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR, sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    mngt.dev[14]=  #-env -time -prot
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR-PROT, sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    space.dev[14]= #-env -time -prot
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR-PROT,sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    ###Sequence 15: environment->space->management->time
    
    env.dev[15]= #-env
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    space.dev[15]= #-env -space
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    mngt.dev[15]= #-env -space -prot
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT))-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    time.dev[15]= #-env -space -prot
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT)))/
      deviance(nullmod)
    
    #Sequence 16: environment->space->time->management
    
    env.dev[16]= #-env
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    space.dev[16]= #-env -space
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    time.dev[16]= #-env -space -time
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR))-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    mngt.dev[16]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR)))/        deviance(nullmod)
    
    #Sequence 17: environment->management->space->time
    env.dev[17]= #-env
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    mngt.dev[17]= #-env -prot
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT,sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    space.dev[17]=  #-env -prot -space
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    time.dev[17]= #-env -prot -space
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
      deviance(nullmod)
    
    ###Sequence 18: environment->management->time->space
    
    env.dev[18]= #-env
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    mngt.dev[18]= #-env -prot
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT,sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    time.dev[18]= #-env -prot -time 
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT-YEAR,sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    space.dev[18]= #-env -prot -time 
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT-YEAR,sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    # MANAGEMENT 
    
    #Sequence 19: management->environment->time->space
    mngt.dev[19]= #-prot
      (deviance(update(fullmod,.~.-PROT,sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    env.dev[19]= #-prot -env
      (deviance(update(fullmod,.~.-PROT-STRAT_GROUPED-s(DEPTH,bs='ts'), sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
      deviance(nullmod)
    
    time.dev[19]= #-prot -env -time
      (deviance(update(fullmod,.~.-PROT-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR, sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
      deviance(nullmod)
    
    space.dev[19]= #-prot -env -time
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-PROT-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR,sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    #Sequence 20: management->environment->space->time
    
    mngt.dev[20]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    env.dev[20]= #-prot -env 
      (deviance(update(fullmod,.~.-PROT-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
      deviance(nullmod)
    
    space.dev[20]=  #-prot -env -space
      (deviance(update(fullmod,.~.-PROT-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
         deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
      deviance(nullmod)
    
    time.dev[20]= #-prot -env -space
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-PROT-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
      deviance(nullmod)
    
    #Sequence 21: management->space->time->environment
    mngt.dev[21]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    space.dev[21]= #-prot, -space
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
      deviance(nullmod)
    
    time.dev[21]= #-prot, -space -time
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR, sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
      deviance(nullmod)
    
    env.dev[21]= #-prot, -space -time
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR, sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    #Sequence 22: management->space->environment->time
    
    mngt.dev[22]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    space.dev[22]= #-prot -space
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
      deviance(nullmod)
    
    env.dev[22]= #-prot -space -env
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')))-
         deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
      deviance(nullmod)
    
    time.dev[22]= #-prot -space -env
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts'))))/
      deviance(nullmod)
    
    #Sequence 23: management->time->space->environment
    
    mngt.dev[23]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    time.dev[23]= #-prot -space
      (deviance(update(fullmod,.~.-PROT-YEAR,sp=fullmod$sp))-
         deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
      deviance(nullmod)
    
    env.dev[23]= #-prot -time -env
      (deviance(update(fullmod,.~.-PROT-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
      deviance(nullmod)
    
    space.dev[23]= #-prot -time -env
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-PROT-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'), sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    #Squence 24: management->time->environment->space
    
    mngt.dev[24]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    time.dev[24]= #-prot -time
      (deviance(update(fullmod,.~.-PROT-YEAR, sp=fullmod$sp))-
         deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
      deviance(nullmod)
    
    env.dev[24]= #-prot -time -env
      (deviance(update(fullmod,.~.-PROT-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'), sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
      deviance(nullmod)
    
    space.dev[24]=  #-prot -time -env
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-PROT-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
  }
  #Average the deviances for all models in which a predictor appeared and calculate a standard error. The partial deviances are therefore the proportion of total explained deviance of the model uniquely explained by space, time, environment or management. 
  
  #Bind results into data.frame
  bio_prop.deviance=data.frame(
    Diversity=paste(j),
    Predictor=c("All","Space","Time","Habitat Structure","No-Take Zones"),
    bio_partial_deviance=c(summary(fullmod)$dev.expl,mean(space.dev),mean(time.dev),mean(env.dev),mean(mngt.dev)),
    bio_partial_deviance.SE=c(0,std.error(space.dev),std.error(time.dev),std.error(env.dev),std.error(mngt.dev)))
  
  bio_model_summary = summary(fullmod)
  
  saveRDS(bio_prop.deviance, "bio_prop.deviance_rds")
  saveRDS(bio_model_summary, "bio_model_summary_rds")
} else{
  bio_prop.deviance = read_rds("bio_prop.deviance_rds")
  bio_model_summary = read_rds("bio_model_summary_rds")
}
  
```

```{r evenness GAM}

if(!file.exists("even_prop.deviance_rds","even_model_summary_rds")){

  gam_data = all_matrices_data %>%
    select(YEAR, PRIMARY_SAMPLE_UNIT, LON_DEGREES, LAT_DEGREES, DEPTH, STRAT_GROUPED, PROT, abundance_sum, biomass_sum, evenness, richness, simpson, shannon, func.div)
  
  even_partial_deviance_list = for(j in names(gam_data[,10])) { 
    
    #Build full model and null model based on (transformed) response variable
      fullmod = gam(formula(paste("asin(sqrt(",j,"))~YEAR+STRAT_GROUPED+PROT+s(LON_DEGREES,LAT_DEGREES,by=YEAR, bs='ts')+s(DEPTH, bs='ts')")), data=gam_data)
      nullmod = gam(formula(paste("asin(sqrt(",j,"))~1")), data=gam_data)
      
  
  #Set up empty vectors for deviances
  time.dev=c(); space.dev=c(); env.dev=c(); mngt.dev=c()

#Calculate partial deviances by sequentially removing suites of predictors from the full model for all possible permutations (24). 

  #time deviances 
    
  ###Sequence 1: time->space->mangement->environment 

   time.dev[1]= #(deviance(-time)-deviance(full))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)) - #-TIME 
       deviance(fullmod))/
       deviance(nullmod)
    
    space.dev[1] = #(deviance(-time-space)-deviance(-time))/deviance(null) 
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp))) /
       deviance(nullmod)
    
    mngt.dev[1]= #(deviance(-time-space-mngt)-deviance(-time)/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT, sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
       deviance(nullmod) 
    
    env.dev[1]= #(deviance(null)-deviance(-time,-space,-mngt))/deviance(null) 
      (deviance(nullmod)-
      deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT,sp=fullmod$sp[2])))/ 
      deviance(nullmod)

    ###Sequence 2: time->space->environment->mangement
    
    time.dev[2]= #(deviance(-time)-deviance(full))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    space.dev[2]= #(deviance(-time-space)-deviance(-time))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
       deviance(nullmod)
    
    env.dev[2]= #(deviance(-time-space-env)-deviance(-time))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')))-
       deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
       deviance(nullmod)
    
    mngt.dev[2]= #(deviance(null)-deviance(-time-space-env))/deviance(null)
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts'))))/
       deviance(nullmod)

    ###sequence 3: time->management->environment->space  
    
    time.dev[3]= 
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    mngt.dev[3]=
      (deviance(update(fullmod,.~.-YEAR-PROT, sp=fullmod$sp))-
       deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
       deviance(nullmod)

    env.dev[3]=
      (deviance(update(fullmod,.~.-YEAR-PROT-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
       deviance(nullmod)
    
    space.dev[3]=
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-YEAR-PROT-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    ###sequence 4: time->management->space->environment  
    
    time.dev[4]=
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    mngt.dev[4]= #(deviance(-time-mngt)-deviance(-time))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-PROT, sp=fullmod$sp))-
       deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
       deviance(nullmod)

    space.dev[4]= #(deviance(-time-mngt-space))
      (deviance(update(fullmod,.~.-YEAR-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
       deviance(nullmod)
    
    env.dev[4]= #deviance(null)-deviance(-time-mngt-space)/deviance(null)
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-YEAR-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2])))/
       deviance(nullmod)

    ###Sequence 5: time->environment->space->management
    
    time.dev[5]=
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    env.dev[5]= #-time, -envt
      (deviance(update(fullmod,.~.-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'), sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
       deviance(nullmod)

    space.dev[5]= #-time, -envt, -space
      (deviance(update(fullmod,.~.-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
       deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
       deviance(nullmod)
  
    mngt.dev[5]=
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-YEAR-PROT-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
       deviance(nullmod)
    
    ###Sequence 6: time->environment->management->space
    
    time.dev[6]=
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    env.dev[6]= #-time, -env
      (deviance(update(fullmod,.~.-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
       deviance(nullmod)
    
    mngt.dev[6]= #-time, -env, -mngt
      (deviance(update(fullmod,.~.-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT, sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
       deviance(nullmod)
  
    space.dev[6]= #-time, -envt, -mngt
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT, sp=fullmod$sp[1])))/
       deviance(nullmod)

#SPACE
    
    ###Sequence 7: space->time->management->environment
    space.dev[7]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    time.dev[7]= #-space, -time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR, sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
    mngt.dev[7]= #-space, -time, -prot 
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-PROT,sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
    env.dev[7]= #-space, -time, -prot
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-PROT,sp=fullmod$sp[2])))/
       deviance(nullmod)

    ###Sequence 8: space->time->environment->management
    
    space.dev[8]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    time.dev[8]= #-space, -time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR,sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
    env.dev[8]= #-space, -time, -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts')))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
    mngt.dev[8]= #-space, -time, -env
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'))))/
       deviance(nullmod)    
    
    ###Sequence 9: space->environment->mangement->time
    
    space.dev[9]=
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(fullmod))/ 
       deviance(nullmod)
    
     env.dev[9]= #-space, -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))) /
       deviance(nullmod)
    
    mngt.dev[9]= #-space, -env, -prot
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2])))/
       deviance(nullmod)
    
     time.dev[9]= #-space, -env, -prot
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT)))/
       deviance(nullmod)
     
    ###Sequence 10: space->environment->time->mangement 
    
     space.dev[10]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2]))-
       deviance(fullmod))/ 
       deviance(nullmod)
    
     env.dev[10]= #-space -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
     time.dev[10]= #-space -env -time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2])))/
       deviance(nullmod)
    
     mngt.dev[10]=
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR)))/
       deviance(nullmod)
     
    ###Sequence 11: space->mangement->time->environment 
    space.dev[11]=
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(fullmod))/
       deviance(nullmod)
    
     mngt.dev[11]=
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT,sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
     time.dev[11]= #-space,-prot,-time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-YEAR,sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
     env.dev[11]=
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-YEAR),sp=fullmod$sp[2]))/
       deviance(nullmod)
     
    ###Sequence 12: space->mangement->environment->time
     
    space.dev[12]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2]))-
       deviance(fullmod))/
       deviance(nullmod)
    
     mngt.dev[12]= #-space -prot
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT,sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
    env.dev[12]= #-space -prot -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-STRAT_GROUPED-s(DEPTH,bs='ts')))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
     time.dev[12]= #-space -prot -env
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-STRAT_GROUPED-s(DEPTH,bs='ts'))))/
       deviance(nullmod)

#ENVIRONMENT

    ###Sequence 13: environment->time->space->management 
    
     env.dev[13]= #-env
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    time.dev[13]= #-env, -time
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR,sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    space.dev[13]= #-env, -time, -space 
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
      deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    mngt.dev[13]= #-env, -time, -space 
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
       deviance(nullmod)
    
    ###Sequence 14: environment->time->management->space
    
    env.dev[14]= #-env
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    time.dev[14]= #-env, -time
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR, sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    mngt.dev[14]=  #-env -time -prot
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR-PROT, sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    space.dev[14]= #-env -time -prot
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR-PROT,sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    ###Sequence 15: environment->space->management->time
    
    env.dev[15]= #-env
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    space.dev[15]= #-env -space
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
      deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    mngt.dev[15]= #-env -space -prot
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT))-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    time.dev[15]= #-env -space -prot
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT)))/
       deviance(nullmod)
    
    #Sequence 16: environment->space->time->management
    
    env.dev[16]= #-env
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    space.dev[16]= #-env -space
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    time.dev[16]= #-env -space -time
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR))-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    mngt.dev[16]=
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR)))/        deviance(nullmod)
    
    #Sequence 17: environment->management->space->time
    env.dev[17]= #-env
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    mngt.dev[17]= #-env -prot
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT,sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    space.dev[17]=  #-env -prot -space
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    time.dev[17]= #-env -prot -space
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
       deviance(nullmod)
    
    ###Sequence 18: environment->management->time->space
    
    env.dev[18]= #-env
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    mngt.dev[18]= #-env -prot
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT,sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    time.dev[18]= #-env -prot -time 
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT-YEAR,sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    space.dev[18]= #-env -prot -time 
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT-YEAR,sp=fullmod$sp[1])))/
       deviance(nullmod)

# MANAGEMENT 

    #Sequence 19: management->environment->time->space
    mngt.dev[19]= #-prot
      (deviance(update(fullmod,.~.-PROT,sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    env.dev[19]= #-prot -env
      (deviance(update(fullmod,.~.-PROT-STRAT_GROUPED-s(DEPTH,bs='ts'), sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
       deviance(nullmod)
    
    time.dev[19]= #-prot -env -time
      (deviance(update(fullmod,.~.-PROT-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR, sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    space.dev[19]= #-prot -env -time
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-PROT-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR,sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    #Sequence 20: management->environment->space->time
    
    mngt.dev[20]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    env.dev[20]= #-prot -env 
      (deviance(update(fullmod,.~.-PROT-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    space.dev[20]=  #-prot -env -space
      (deviance(update(fullmod,.~.-PROT-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    time.dev[20]= #-prot -env -space
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-PROT-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
       deviance(nullmod)
    
    #Sequence 21: management->space->time->environment
    mngt.dev[21]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    space.dev[21]= #-prot, -space
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
       deviance(nullmod)
    
    time.dev[21]= #-prot, -space -time
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR, sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    env.dev[21]= #-prot, -space -time
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR, sp=fullmod$sp[2])))/
       deviance(nullmod)
    
    #Sequence 22: management->space->environment->time
    
    mngt.dev[22]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    space.dev[22]= #-prot -space
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    env.dev[22]= #-prot -space -env
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    time.dev[22]= #-prot -space -env
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts'))))/
       deviance(nullmod)
    
    #Sequence 23: management->time->space->environment
    
    mngt.dev[23]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    time.dev[23]= #-prot -space
      (deviance(update(fullmod,.~.-PROT-YEAR,sp=fullmod$sp))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    env.dev[23]= #-prot -time -env
      (deviance(update(fullmod,.~.-PROT-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
       deviance(nullmod)
    
    space.dev[23]= #-prot -time -env
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-PROT-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'), sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    #Squence 24: management->time->environment->space
   
     mngt.dev[24]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
     time.dev[24]= #-prot -time
      (deviance(update(fullmod,.~.-PROT-YEAR, sp=fullmod$sp))-
       deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
       deviance(nullmod)
    
    env.dev[24]= #-prot -time -env
      (deviance(update(fullmod,.~.-PROT-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'), sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
       deviance(nullmod)
    
    space.dev[24]=  #-prot -time -env
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-PROT-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
}

#Average the deviances for all models in which a predictor appeared and calculate a standard error. The partial deviances are therefore the proportion of total explained deviance of the model uniquely explained by space, time, environment or management. 
    
  #Bind results into data.frame
  even_prop.deviance=data.frame(
    diversity=paste(j),
    predictor=c("All","Space","Time","Habitat Structure","No-Take Zones"),
    even_partial_deviance=c(summary(fullmod)$dev.expl,mean(space.dev),mean(time.dev),mean(env.dev),mean(mngt.dev)),
    even_partial_deviance_SE=c(0,std.error(space.dev),std.error(time.dev),std.error(env.dev),std.error(mngt.dev)))
  
  even_model_summary = summary(fullmod)
  
  saveRDS(even_prop.deviance, "even_prop.deviance_rds")
  saveRDS(even_model_summary, "even_model_summary_rds")

  }else{
    even_prop.deviance = read_rds("even_prop.deviance_rds")
    even_model_summary = read_rds("even_model_summary_rds")
}
  
```

```{r shannon GAM}

if(!file.exists("shan_prop.deviance_rds","shan_model_summary_rds")){
  
gam_data = all_matrices_data %>%
  select(YEAR, PRIMARY_SAMPLE_UNIT, LON_DEGREES, LAT_DEGREES, DEPTH, STRAT_GROUPED, PROT, abundance_sum, biomass_sum, evenness, richness, shannon, simpson, func.div)

shan_partial_deviance_list = for(j in names(gam_data[,12])) { 
  
    #Build full model and null model based on (transformed) response variable
      fullmod = gam(formula(paste(j,"~YEAR+STRAT_GROUPED+PROT+s(LON_DEGREES,LAT_DEGREES,by=YEAR, bs='ts')+s(DEPTH, bs='ts')")), family=poisson, data=gam_data)
      nullmod = gam(formula(paste(j,"~1")), family=poisson, data=gam_data)
       
  #Set up empty vectors for deviances
  time.dev=c(); space.dev=c(); env.dev=c(); mngt.dev=c()

#Calculate partial deviances by sequentially removing suites of predictors from the full model for all possible permutations (24). 

  #time deviances 
    
  ###Sequence 1: time->space->mangement->environment 

   time.dev[1]= #(deviance(-time)-deviance(full))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)) - #-TIME 
       deviance(fullmod))/
       deviance(nullmod)
    
    space.dev[1] = #(deviance(-time-space)-deviance(-time))/deviance(null) 
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp))) /
       deviance(nullmod)
    
    mngt.dev[1]= #(deviance(-time-space-mngt)-deviance(-time)/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT, sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
       deviance(nullmod) 
    
    env.dev[1]= #(deviance(null)-deviance(-time,-space,-mngt))/deviance(null) 
      (deviance(nullmod)-
      deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT,sp=fullmod$sp[2])))/ 
      deviance(nullmod)

    ###Sequence 2: time->space->environment->mangement
    
    time.dev[2]= #(deviance(-time)-deviance(full))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    space.dev[2]= #(deviance(-time-space)-deviance(-time))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
       deviance(nullmod)
    
    env.dev[2]= #(deviance(-time-space-env)-deviance(-time))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')))-
       deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
       deviance(nullmod)
    
    mngt.dev[2]= #(deviance(null)-deviance(-time-space-env))/deviance(null)
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts'))))/
       deviance(nullmod)

    ###sequence 3: time->management->environment->space  
    
    time.dev[3]= 
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    mngt.dev[3]=
      (deviance(update(fullmod,.~.-YEAR-PROT, sp=fullmod$sp))-
       deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
       deviance(nullmod)

    env.dev[3]=
      (deviance(update(fullmod,.~.-YEAR-PROT-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
       deviance(nullmod)
    
    space.dev[3]=
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-YEAR-PROT-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    ###sequence 4: time->management->space->environment  
    
    time.dev[4]=
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    mngt.dev[4]= #(deviance(-time-mngt)-deviance(-time))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-PROT, sp=fullmod$sp))-
       deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
       deviance(nullmod)

    space.dev[4]= #(deviance(-time-mngt-space))
      (deviance(update(fullmod,.~.-YEAR-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
       deviance(nullmod)
    
    env.dev[4]= #deviance(null)-deviance(-time-mngt-space)/deviance(null)
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-YEAR-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2])))/
       deviance(nullmod)

    ###Sequence 5: time->environment->space->management
    
    time.dev[5]=
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    env.dev[5]= #-time, -envt
      (deviance(update(fullmod,.~.-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'), sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
       deviance(nullmod)

    space.dev[5]= #-time, -envt, -space
      (deviance(update(fullmod,.~.-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
       deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
       deviance(nullmod)
  
    mngt.dev[5]=
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-YEAR-PROT-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
       deviance(nullmod)
    
    ###Sequence 6: time->environment->management->space
    
    time.dev[6]=
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    env.dev[6]= #-time, -env
      (deviance(update(fullmod,.~.-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
       deviance(nullmod)
    
    mngt.dev[6]= #-time, -env, -mngt
      (deviance(update(fullmod,.~.-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT, sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
       deviance(nullmod)
  
    space.dev[6]= #-time, -envt, -mngt
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT, sp=fullmod$sp[1])))/
       deviance(nullmod)

#SPACE
    
    ###Sequence 7: space->time->management->environment
    space.dev[7]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    time.dev[7]= #-space, -time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR, sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
    mngt.dev[7]= #-space, -time, -prot 
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-PROT,sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
    env.dev[7]= #-space, -time, -prot
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-PROT,sp=fullmod$sp[2])))/
       deviance(nullmod)

    ###Sequence 8: space->time->environment->management
    
    space.dev[8]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    time.dev[8]= #-space, -time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR,sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
    env.dev[8]= #-space, -time, -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts')))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
    mngt.dev[8]= #-space, -time, -env
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'))))/
       deviance(nullmod)    
    
    ###Sequence 9: space->environment->mangement->time
    
    space.dev[9]=
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(fullmod))/ 
       deviance(nullmod)
    
     env.dev[9]= #-space, -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))) /
       deviance(nullmod)
    
    mngt.dev[9]= #-space, -env, -prot
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2])))/
       deviance(nullmod)
    
     time.dev[9]= #-space, -env, -prot
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT)))/
       deviance(nullmod)
     
    ###Sequence 10: space->environment->time->mangement 
    
     space.dev[10]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2]))-
       deviance(fullmod))/ 
       deviance(nullmod)
    
     env.dev[10]= #-space -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
     time.dev[10]= #-space -env -time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2])))/
       deviance(nullmod)
    
     mngt.dev[10]=
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR)))/
       deviance(nullmod)
     
    ###Sequence 11: space->mangement->time->environment 
    space.dev[11]=
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(fullmod))/
       deviance(nullmod)
    
     mngt.dev[11]=
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT,sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
     time.dev[11]= #-space,-prot,-time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-YEAR,sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
     env.dev[11]=
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-YEAR),sp=fullmod$sp[2]))/
       deviance(nullmod)
     
    ###Sequence 12: space->mangement->environment->time
     
    space.dev[12]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2]))-
       deviance(fullmod))/
       deviance(nullmod)
    
     mngt.dev[12]= #-space -prot
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT,sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
    env.dev[12]= #-space -prot -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-STRAT_GROUPED-s(DEPTH,bs='ts')))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
     time.dev[12]= #-space -prot -env
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-STRAT_GROUPED-s(DEPTH,bs='ts'))))/
       deviance(nullmod)

#ENVIRONMENT

    ###Sequence 13: environment->time->space->management 
    
     env.dev[13]= #-env
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    time.dev[13]= #-env, -time
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR,sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    space.dev[13]= #-env, -time, -space 
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
      deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    mngt.dev[13]= #-env, -time, -space 
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
       deviance(nullmod)
    
    ###Sequence 14: environment->time->management->space
    
    env.dev[14]= #-env
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    time.dev[14]= #-env, -time
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR, sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    mngt.dev[14]=  #-env -time -prot
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR-PROT, sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    space.dev[14]= #-env -time -prot
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR-PROT,sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    ###Sequence 15: environment->space->management->time
    
    env.dev[15]= #-env
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    space.dev[15]= #-env -space
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
      deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    mngt.dev[15]= #-env -space -prot
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT))-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    time.dev[15]= #-env -space -prot
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT)))/
       deviance(nullmod)
    
    #Sequence 16: environment->space->time->management
    
    env.dev[16]= #-env
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    space.dev[16]= #-env -space
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    time.dev[16]= #-env -space -time
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR))-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    mngt.dev[16]=
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR)))/        deviance(nullmod)
    
    #Sequence 17: environment->management->space->time
    env.dev[17]= #-env
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    mngt.dev[17]= #-env -prot
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT,sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    space.dev[17]=  #-env -prot -space
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    time.dev[17]= #-env -prot -space
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
       deviance(nullmod)
    
    ###Sequence 18: environment->management->time->space
    
    env.dev[18]= #-env
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    mngt.dev[18]= #-env -prot
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT,sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    time.dev[18]= #-env -prot -time 
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT-YEAR,sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    space.dev[18]= #-env -prot -time 
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT-YEAR,sp=fullmod$sp[1])))/
       deviance(nullmod)

# MANAGEMENT 

    #Sequence 19: management->environment->time->space
    mngt.dev[19]= #-prot
      (deviance(update(fullmod,.~.-PROT,sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    env.dev[19]= #-prot -env
      (deviance(update(fullmod,.~.-PROT-STRAT_GROUPED-s(DEPTH,bs='ts'), sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
       deviance(nullmod)
    
    time.dev[19]= #-prot -env -time
      (deviance(update(fullmod,.~.-PROT-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR, sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    space.dev[19]= #-prot -env -time
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-PROT-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR,sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    #Sequence 20: management->environment->space->time
    
    mngt.dev[20]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    env.dev[20]= #-prot -env 
      (deviance(update(fullmod,.~.-PROT-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    space.dev[20]=  #-prot -env -space
      (deviance(update(fullmod,.~.-PROT-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    time.dev[20]= #-prot -env -space
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-PROT-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
       deviance(nullmod)
    
    #Sequence 21: management->space->time->environment
    mngt.dev[21]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    space.dev[21]= #-prot, -space
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
       deviance(nullmod)
    
    time.dev[21]= #-prot, -space -time
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR, sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    env.dev[21]= #-prot, -space -time
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR, sp=fullmod$sp[2])))/
       deviance(nullmod)
    
    #Sequence 22: management->space->environment->time
    
    mngt.dev[22]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    space.dev[22]= #-prot -space
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    env.dev[22]= #-prot -space -env
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    time.dev[22]= #-prot -space -env
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts'))))/
       deviance(nullmod)
    
    #Sequence 23: management->time->space->environment
    
    mngt.dev[23]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    time.dev[23]= #-prot -space
      (deviance(update(fullmod,.~.-PROT-YEAR,sp=fullmod$sp))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    env.dev[23]= #-prot -time -env
      (deviance(update(fullmod,.~.-PROT-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
       deviance(nullmod)
    
    space.dev[23]= #-prot -time -env
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-PROT-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'), sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    #Squence 24: management->time->environment->space
   
     mngt.dev[24]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
     time.dev[24]= #-prot -time
      (deviance(update(fullmod,.~.-PROT-YEAR, sp=fullmod$sp))-
       deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
       deviance(nullmod)
    
    env.dev[24]= #-prot -time -env
      (deviance(update(fullmod,.~.-PROT-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'), sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
       deviance(nullmod)
    
    space.dev[24]=  #-prot -time -env
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-PROT-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
}

#Average the deviances for all models in which a predictor appeared and calculate a standard error. The partial deviances are therefore the proportion of total explained deviance of the model uniquely explained by space, time, environment or management. 
    
  #Bind results into data.frame
  shan_prop.deviance=data.frame(
    diversity=paste(j),
    predictor=c("All","Space","Time","Habitat Structure","No-Take Zones"),
    shan_partial_deviance=c(summary(fullmod)$dev.expl,mean(space.dev),mean(time.dev),mean(env.dev),mean(mngt.dev)),
    shan_partial_deviance_SE=c(0,std.error(space.dev),std.error(time.dev),std.error(env.dev),std.error(mngt.dev)))
  
  shan_model_summary = summary(fullmod)
  
  saveRDS(shan_prop.deviance, "shan_prop.deviance_rds")
  saveRDS(shan_model_summary, "shan_model_summary_rds")
  
}else{
  shan_prop.deviance = read_rds("shan_prop.deviance_rds")
  shan_model_summary = read_rds("shan_model_summary_rds")   
}
  
```

```{r simpson GAM}

if(!file.exists("simp_prop.deviance_rds","simp_model_summary_rds")){
  
  gam_data = all_matrices_data %>%
    select(YEAR, PRIMARY_SAMPLE_UNIT, LON_DEGREES, LAT_DEGREES, DEPTH, STRAT_GROUPED, PROT, abundance_sum, biomass_sum, evenness, richness, simpson, shannon, func.div)
  
  simp_partial_deviance_list = for(j in names(gam_data[,12])) { 
    
    #Build full model and null model based on (transformed) response variable
      fullmod = gam(formula(paste(j,"~YEAR+STRAT_GROUPED+PROT+s(LON_DEGREES,LAT_DEGREES,by=YEAR, bs='ts')+s(DEPTH, bs='ts')")), family=poisson, data=gam_data)
      nullmod = gam(formula(paste(j,"~1")), family=poisson, data=gam_data)
    
    #Set up empty vectors for deviances
    time.dev=c(); space.dev=c(); env.dev=c(); mngt.dev=c()
    
    #Calculate partial deviances by sequentially removing suites of predictors from the full model for all possible permutations (24). 
    
    #time deviances 
    
    ###Sequence 1: time->space->mangement->environment 
    
    time.dev[1]= #(deviance(-time)-deviance(full))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)) - #-TIME 
         deviance(fullmod))/
      deviance(nullmod)
    
    space.dev[1] = #(deviance(-time-space)-deviance(-time))/deviance(null) 
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp))) /
      deviance(nullmod)
    
    mngt.dev[1]= #(deviance(-time-space-mngt)-deviance(-time)/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT, sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
      deviance(nullmod) 
    
    env.dev[1]= #(deviance(null)-deviance(-time,-space,-mngt))/deviance(null) 
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT,sp=fullmod$sp[2])))/ 
      deviance(nullmod)
    
    ###Sequence 2: time->space->environment->mangement
    
    time.dev[2]= #(deviance(-time)-deviance(full))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    space.dev[2]= #(deviance(-time-space)-deviance(-time))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
      deviance(nullmod)
    
    env.dev[2]= #(deviance(-time-space-env)-deviance(-time))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')))-
         deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
      deviance(nullmod)
    
    mngt.dev[2]= #(deviance(null)-deviance(-time-space-env))/deviance(null)
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts'))))/
      deviance(nullmod)
    
    ###sequence 3: time->management->environment->space  
    
    time.dev[3]= 
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    mngt.dev[3]=
      (deviance(update(fullmod,.~.-YEAR-PROT, sp=fullmod$sp))-
         deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
      deviance(nullmod)
    
    env.dev[3]=
      (deviance(update(fullmod,.~.-YEAR-PROT-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
      deviance(nullmod)
    
    space.dev[3]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-YEAR-PROT-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    ###sequence 4: time->management->space->environment  
    
    time.dev[4]=
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    mngt.dev[4]= #(deviance(-time-mngt)-deviance(-time))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-PROT, sp=fullmod$sp))-
         deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
      deviance(nullmod)
    
    space.dev[4]= #(deviance(-time-mngt-space))
      (deviance(update(fullmod,.~.-YEAR-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
      deviance(nullmod)
    
    env.dev[4]= #deviance(null)-deviance(-time-mngt-space)/deviance(null)
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-YEAR-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    ###Sequence 5: time->environment->space->management
    
    time.dev[5]=
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    env.dev[5]= #-time, -envt
      (deviance(update(fullmod,.~.-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'), sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
      deviance(nullmod)
    
    space.dev[5]= #-time, -envt, -space
      (deviance(update(fullmod,.~.-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
         deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
      deviance(nullmod)
    
    mngt.dev[5]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-YEAR-PROT-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
      deviance(nullmod)
    
    ###Sequence 6: time->environment->management->space
    
    time.dev[6]=
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    env.dev[6]= #-time, -env
      (deviance(update(fullmod,.~.-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
      deviance(nullmod)
    
    mngt.dev[6]= #-time, -env, -mngt
      (deviance(update(fullmod,.~.-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT, sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
      deviance(nullmod)
    
    space.dev[6]= #-time, -envt, -mngt
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT, sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    #SPACE
    
    ###Sequence 7: space->time->management->environment
    space.dev[7]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    time.dev[7]= #-space, -time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR, sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    mngt.dev[7]= #-space, -time, -prot 
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-PROT,sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    env.dev[7]= #-space, -time, -prot
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-PROT,sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    ###Sequence 8: space->time->environment->management
    
    space.dev[8]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    time.dev[8]= #-space, -time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR,sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    env.dev[8]= #-space, -time, -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts')))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    mngt.dev[8]= #-space, -time, -env
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'))))/
      deviance(nullmod)    
    
    ###Sequence 9: space->environment->mangement->time
    
    space.dev[9]=
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(fullmod))/ 
      deviance(nullmod)
    
    env.dev[9]= #-space, -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))) /
      deviance(nullmod)
    
    mngt.dev[9]= #-space, -env, -prot
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    time.dev[9]= #-space, -env, -prot
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT)))/
      deviance(nullmod)
    
    ###Sequence 10: space->environment->time->mangement 
    
    space.dev[10]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2]))-
         deviance(fullmod))/ 
      deviance(nullmod)
    
    env.dev[10]= #-space -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    time.dev[10]= #-space -env -time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    mngt.dev[10]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR)))/
      deviance(nullmod)
    
    ###Sequence 11: space->mangement->time->environment 
    space.dev[11]=
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    mngt.dev[11]=
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT,sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    time.dev[11]= #-space,-prot,-time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-YEAR,sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    env.dev[11]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-YEAR),sp=fullmod$sp[2]))/
      deviance(nullmod)
    
    ###Sequence 12: space->mangement->environment->time
    
    space.dev[12]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    mngt.dev[12]= #-space -prot
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT,sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    env.dev[12]= #-space -prot -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-STRAT_GROUPED-s(DEPTH,bs='ts')))-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    time.dev[12]= #-space -prot -env
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-STRAT_GROUPED-s(DEPTH,bs='ts'))))/
      deviance(nullmod)
    
    #ENVIRONMENT
    
    ###Sequence 13: environment->time->space->management 
    
    env.dev[13]= #-env
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    time.dev[13]= #-env, -time
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR,sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    space.dev[13]= #-env, -time, -space 
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    mngt.dev[13]= #-env, -time, -space 
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
      deviance(nullmod)
    
    ###Sequence 14: environment->time->management->space
    
    env.dev[14]= #-env
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    time.dev[14]= #-env, -time
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR, sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    mngt.dev[14]=  #-env -time -prot
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR-PROT, sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    space.dev[14]= #-env -time -prot
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR-PROT,sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    ###Sequence 15: environment->space->management->time
    
    env.dev[15]= #-env
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    space.dev[15]= #-env -space
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    mngt.dev[15]= #-env -space -prot
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT))-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    time.dev[15]= #-env -space -prot
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT)))/
      deviance(nullmod)
    
    #Sequence 16: environment->space->time->management
    
    env.dev[16]= #-env
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    space.dev[16]= #-env -space
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    time.dev[16]= #-env -space -time
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR))-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    mngt.dev[16]=
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR)))/        deviance(nullmod)
    
    #Sequence 17: environment->management->space->time
    env.dev[17]= #-env
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    mngt.dev[17]= #-env -prot
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT,sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    space.dev[17]=  #-env -prot -space
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    time.dev[17]= #-env -prot -space
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
      deviance(nullmod)
    
    ###Sequence 18: environment->management->time->space
    
    env.dev[18]= #-env
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(fullmod))/
      deviance(nullmod)
    
    mngt.dev[18]= #-env -prot
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT,sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    time.dev[18]= #-env -prot -time 
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT-YEAR,sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    space.dev[18]= #-env -prot -time 
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT-YEAR,sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    # MANAGEMENT 
    
    #Sequence 19: management->environment->time->space
    mngt.dev[19]= #-prot
      (deviance(update(fullmod,.~.-PROT,sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    env.dev[19]= #-prot -env
      (deviance(update(fullmod,.~.-PROT-STRAT_GROUPED-s(DEPTH,bs='ts'), sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
      deviance(nullmod)
    
    time.dev[19]= #-prot -env -time
      (deviance(update(fullmod,.~.-PROT-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR, sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
      deviance(nullmod)
    
    space.dev[19]= #-prot -env -time
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-PROT-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR,sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    #Sequence 20: management->environment->space->time
    
    mngt.dev[20]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    env.dev[20]= #-prot -env 
      (deviance(update(fullmod,.~.-PROT-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
      deviance(nullmod)
    
    space.dev[20]=  #-prot -env -space
      (deviance(update(fullmod,.~.-PROT-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
         deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
      deviance(nullmod)
    
    time.dev[20]= #-prot -env -space
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-PROT-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
      deviance(nullmod)
    
    #Sequence 21: management->space->time->environment
    mngt.dev[21]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    space.dev[21]= #-prot, -space
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
      deviance(nullmod)
    
    time.dev[21]= #-prot, -space -time
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR, sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
      deviance(nullmod)
    
    env.dev[21]= #-prot, -space -time
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR, sp=fullmod$sp[2])))/
      deviance(nullmod)
    
    #Sequence 22: management->space->environment->time
    
    mngt.dev[22]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    space.dev[22]= #-prot -space
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
         deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
      deviance(nullmod)
    
    env.dev[22]= #-prot -space -env
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')))-
         deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
      deviance(nullmod)
    
    time.dev[22]= #-prot -space -env
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts'))))/
      deviance(nullmod)
    
    #Sequence 23: management->time->space->environment
    
    mngt.dev[23]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    time.dev[23]= #-prot -space
      (deviance(update(fullmod,.~.-PROT-YEAR,sp=fullmod$sp))-
         deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
      deviance(nullmod)
    
    env.dev[23]= #-prot -time -env
      (deviance(update(fullmod,.~.-PROT-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
      deviance(nullmod)
    
    space.dev[23]= #-prot -time -env
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-PROT-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'), sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    #Squence 24: management->time->environment->space
    
    mngt.dev[24]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
         deviance(fullmod))/
      deviance(nullmod)
    
    time.dev[24]= #-prot -time
      (deviance(update(fullmod,.~.-PROT-YEAR, sp=fullmod$sp))-
         deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
      deviance(nullmod)
    
    env.dev[24]= #-prot -time -env
      (deviance(update(fullmod,.~.-PROT-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'), sp=fullmod$sp[1]))-
         deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
      deviance(nullmod)
    
    space.dev[24]=  #-prot -time -env
      (deviance(nullmod)-
         deviance(update(fullmod,.~.-PROT-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
  }
  
  #Average the deviances for all models in which a predictor appeared and calculate a standard error. The partial deviances are therefore the proportion of total explained deviance of the model uniquely explained by space, time, environment or management. 
  
  #Bind results into data.frame
  simp_prop.deviance=data.frame(
    diversity=paste(j),
    predictor=c("All","Space","Time","Habitat Structure","No-Take Zones"),
    simp_partial_deviance=c(summary(fullmod)$dev.expl,mean(space.dev),mean(time.dev),mean(env.dev),mean(mngt.dev)),
    simp_partial_deviance_SE=c(0,std.error(space.dev),std.error(time.dev),std.error(env.dev),std.error(mngt.dev)))
  
  simp_model_summary = summary(fullmod)
  
  saveRDS(simp_prop.deviance,"simp_prop.deviance_rds")
  saveRDS(simp_model_summary, "simp_model_summary_rds")
  
} else{
  simp_prop.deviance = read_rds("simp_prop.deviance_rds")
  simp_model_summary = read_rds("simp_model_summary_rds")
}
  
```

```{r functional GAM}

if(!file.exists("func_prop.deviance","func_model_summary_rds")){
  
gam_data = all_matrices_data %>%
  select(YEAR, PRIMARY_SAMPLE_UNIT, LON_DEGREES, LAT_DEGREES, DEPTH, STRAT_GROUPED, PROT, abundance_sum, biomass_sum, evenness, richness, simpson, shannon, func.div)

func_partial_deviance_list = for(j in names(gam_data[,14])) { 
  
    #Build full model and null model based on (transformed) response variable
      fullmod = gam(formula(paste(j,"~YEAR+STRAT_GROUPED+PROT+s(LON_DEGREES,LAT_DEGREES,by=YEAR, bs='ts')+s(DEPTH, bs='ts')")), family=poisson, data=gam_data)
      nullmod = gam(formula(paste(j,"~1")), family=poisson, data=gam_data)
  
  #Set up empty vectors for deviances
  time.dev=c(); space.dev=c(); env.dev=c(); mngt.dev=c()

#Calculate partial deviances by sequentially removing suites of predictors from the full model for all possible permutations (24). 

  #time deviances 
    
  ###Sequence 1: time->space->mangement->environment 

   time.dev[1]= #(deviance(-time)-deviance(full))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)) - #-TIME 
       deviance(fullmod))/
       deviance(nullmod)
    
    space.dev[1] = #(deviance(-time-space)-deviance(-time))/deviance(null) 
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp))) /
       deviance(nullmod)
    
    mngt.dev[1]= #(deviance(-time-space-mngt)-deviance(-time)/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT, sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
       deviance(nullmod) 
    
    env.dev[1]= #(deviance(null)-deviance(-time,-space,-mngt))/deviance(null) 
      (deviance(nullmod)-
      deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT,sp=fullmod$sp[2])))/ 
      deviance(nullmod)

    ###Sequence 2: time->space->environment->mangement
    
    time.dev[2]= #(deviance(-time)-deviance(full))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    space.dev[2]= #(deviance(-time-space)-deviance(-time))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
       deviance(nullmod)
    
    env.dev[2]= #(deviance(-time-space-env)-deviance(-time))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')))-
       deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
       deviance(nullmod)
    
    mngt.dev[2]= #(deviance(null)-deviance(-time-space-env))/deviance(null)
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts'))))/
       deviance(nullmod)

    ###sequence 3: time->management->environment->space  
    
    time.dev[3]= 
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    mngt.dev[3]=
      (deviance(update(fullmod,.~.-YEAR-PROT, sp=fullmod$sp))-
       deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
       deviance(nullmod)

    env.dev[3]=
      (deviance(update(fullmod,.~.-YEAR-PROT-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
       deviance(nullmod)
    
    space.dev[3]=
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-YEAR-PROT-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    ###sequence 4: time->management->space->environment  
    
    time.dev[4]=
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    mngt.dev[4]= #(deviance(-time-mngt)-deviance(-time))/deviance(null)
      (deviance(update(fullmod,.~.-YEAR-PROT, sp=fullmod$sp))-
       deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
       deviance(nullmod)

    space.dev[4]= #(deviance(-time-mngt-space))
      (deviance(update(fullmod,.~.-YEAR-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
       deviance(nullmod)
    
    env.dev[4]= #deviance(null)-deviance(-time-mngt-space)/deviance(null)
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-YEAR-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2])))/
       deviance(nullmod)

    ###Sequence 5: time->environment->space->management
    
    time.dev[5]=
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    env.dev[5]= #-time, -envt
      (deviance(update(fullmod,.~.-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'), sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
       deviance(nullmod)

    space.dev[5]= #-time, -envt, -space
      (deviance(update(fullmod,.~.-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
       deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp)))/
       deviance(nullmod)
  
    mngt.dev[5]=
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-YEAR-PROT-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
       deviance(nullmod)
    
    ###Sequence 6: time->environment->management->space
    
    time.dev[6]=
      (deviance(update(fullmod,.~.-YEAR, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    env.dev[6]= #-time, -env
      (deviance(update(fullmod,.~.-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
       deviance(nullmod)
    
    mngt.dev[6]= #-time, -env, -mngt
      (deviance(update(fullmod,.~.-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT, sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-YEAR,sp=fullmod$sp)))/
       deviance(nullmod)
  
    space.dev[6]= #-time, -envt, -mngt
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT, sp=fullmod$sp[1])))/
       deviance(nullmod)

#SPACE
    
    ###Sequence 7: space->time->management->environment
    space.dev[7]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    time.dev[7]= #-space, -time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR, sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
    mngt.dev[7]= #-space, -time, -prot 
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-PROT,sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
    env.dev[7]= #-space, -time, -prot
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-PROT,sp=fullmod$sp[2])))/
       deviance(nullmod)

    ###Sequence 8: space->time->environment->management
    
    space.dev[8]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    time.dev[8]= #-space, -time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR,sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
    env.dev[8]= #-space, -time, -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts')))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
    mngt.dev[8]= #-space, -time, -env
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'))))/
       deviance(nullmod)    
    
    ###Sequence 9: space->environment->mangement->time
    
    space.dev[9]=
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(fullmod))/ 
       deviance(nullmod)
    
     env.dev[9]= #-space, -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))) /
       deviance(nullmod)
    
    mngt.dev[9]= #-space, -env, -prot
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2])))/
       deviance(nullmod)
    
     time.dev[9]= #-space, -env, -prot
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT)))/
       deviance(nullmod)
     
    ###Sequence 10: space->environment->time->mangement 
    
     space.dev[10]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2]))-
       deviance(fullmod))/ 
       deviance(nullmod)
    
     env.dev[10]= #-space -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
     time.dev[10]= #-space -env -time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2])))/
       deviance(nullmod)
    
     mngt.dev[10]=
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR)))/
       deviance(nullmod)
     
    ###Sequence 11: space->mangement->time->environment 
    space.dev[11]=
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(fullmod))/
       deviance(nullmod)
    
     mngt.dev[11]=
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT,sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
     time.dev[11]= #-space,-prot,-time
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-YEAR,sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
     env.dev[11]=
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-YEAR),sp=fullmod$sp[2]))/
       deviance(nullmod)
     
    ###Sequence 12: space->mangement->environment->time
     
    space.dev[12]= #-space
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'), sp=fullmod$sp[2]))-
       deviance(fullmod))/
       deviance(nullmod)
    
     mngt.dev[12]= #-space -prot
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT,sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
    env.dev[12]= #-space -prot -env
      (deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-STRAT_GROUPED-s(DEPTH,bs='ts')))-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2])))/
       deviance(nullmod)
    
     time.dev[12]= #-space -prot -env
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT-STRAT_GROUPED-s(DEPTH,bs='ts'))))/
       deviance(nullmod)

#ENVIRONMENT

    ###Sequence 13: environment->time->space->management 
    
     env.dev[13]= #-env
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    time.dev[13]= #-env, -time
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR,sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    space.dev[13]= #-env, -time, -space 
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
      deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    mngt.dev[13]= #-env, -time, -space 
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
       deviance(nullmod)
    
    ###Sequence 14: environment->time->management->space
    
    env.dev[14]= #-env
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    time.dev[14]= #-env, -time
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR, sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    mngt.dev[14]=  #-env -time -prot
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR-PROT, sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    space.dev[14]= #-env -time -prot
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR-PROT,sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    ###Sequence 15: environment->space->management->time
    
    env.dev[15]= #-env
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    space.dev[15]= #-env -space
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
      deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
      deviance(nullmod)
    
    mngt.dev[15]= #-env -space -prot
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT))-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    time.dev[15]= #-env -space -prot
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-PROT)))/
       deviance(nullmod)
    
    #Sequence 16: environment->space->time->management
    
    env.dev[16]= #-env
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    space.dev[16]= #-env -space
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    time.dev[16]= #-env -space -time
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR))-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    mngt.dev[16]=
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR)))/        deviance(nullmod)
    
    #Sequence 17: environment->management->space->time
    env.dev[17]= #-env
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    mngt.dev[17]= #-env -prot
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT,sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    space.dev[17]=  #-env -prot -space
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    time.dev[17]= #-env -prot -space
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
       deviance(nullmod)
    
    ###Sequence 18: environment->management->time->space
    
    env.dev[18]= #-env
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(fullmod))/
       deviance(nullmod)
    
    mngt.dev[18]= #-env -prot
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT,sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    time.dev[18]= #-env -prot -time 
      (deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT-YEAR,sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    space.dev[18]= #-env -prot -time 
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-STRAT_GROUPED-s(DEPTH,bs='ts')-PROT-YEAR,sp=fullmod$sp[1])))/
       deviance(nullmod)

# MANAGEMENT 

    #Sequence 19: management->environment->time->space
    mngt.dev[19]= #-prot
      (deviance(update(fullmod,.~.-PROT,sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    env.dev[19]= #-prot -env
      (deviance(update(fullmod,.~.-PROT-STRAT_GROUPED-s(DEPTH,bs='ts'), sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
       deviance(nullmod)
    
    time.dev[19]= #-prot -env -time
      (deviance(update(fullmod,.~.-PROT-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR, sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    space.dev[19]= #-prot -env -time
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-PROT-STRAT_GROUPED-s(DEPTH,bs='ts')-YEAR,sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    #Sequence 20: management->environment->space->time
    
    mngt.dev[20]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    env.dev[20]= #-prot -env 
      (deviance(update(fullmod,.~.-PROT-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    space.dev[20]=  #-prot -env -space
      (deviance(update(fullmod,.~.-PROT-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    time.dev[20]= #-prot -env -space
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-PROT-STRAT_GROUPED-s(DEPTH,bs='ts')-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'))))/
       deviance(nullmod)
    
    #Sequence 21: management->space->time->environment
    mngt.dev[21]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    space.dev[21]= #-prot, -space
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
       deviance(nullmod)
    
    time.dev[21]= #-prot, -space -time
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR, sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    env.dev[21]= #-prot, -space -time
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-YEAR, sp=fullmod$sp[2])))/
       deviance(nullmod)
    
    #Sequence 22: management->space->environment->time
    
    mngt.dev[22]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    space.dev[22]= #-prot -space
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts'),sp=fullmod$sp[2]))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    env.dev[22]= #-prot -space -env
      (deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts')))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    time.dev[22]= #-prot -space -env
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-PROT-s(LON_DEGREES,LAT_DEGREES,by=YEAR,bs='ts')-STRAT_GROUPED-s(DEPTH,bs='ts'))))/
       deviance(nullmod)
    
    #Sequence 23: management->time->space->environment
    
    mngt.dev[23]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
    time.dev[23]= #-prot -space
      (deviance(update(fullmod,.~.-PROT-YEAR,sp=fullmod$sp))-
       deviance(update(fullmod,.~.-PROT,sp=fullmod$sp)))/
       deviance(nullmod)
    
    env.dev[23]= #-prot -time -env
      (deviance(update(fullmod,.~.-PROT-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
       deviance(nullmod)
    
    space.dev[23]= #-prot -time -env
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-PROT-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'), sp=fullmod$sp[1])))/
       deviance(nullmod)
    
    #Squence 24: management->time->environment->space
   
     mngt.dev[24]= #-prot
      (deviance(update(fullmod,.~.-PROT, sp=fullmod$sp))-
       deviance(fullmod))/
       deviance(nullmod)
    
     time.dev[24]= #-prot -time
      (deviance(update(fullmod,.~.-PROT-YEAR, sp=fullmod$sp))-
       deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
       deviance(nullmod)
    
    env.dev[24]= #-prot -time -env
      (deviance(update(fullmod,.~.-PROT-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'), sp=fullmod$sp[1]))-
       deviance(update(fullmod,.~.-PROT, sp=fullmod$sp)))/
       deviance(nullmod)
    
    space.dev[24]=  #-prot -time -env
      (deviance(nullmod)-
       deviance(update(fullmod,.~.-PROT-YEAR-STRAT_GROUPED-s(DEPTH,bs='ts'),sp=fullmod$sp[1])))/
       deviance(nullmod)
}

#Average the deviances for all models in which a predictor appeared and calculate a standard error. The partial deviances are therefore the proportion of total explained deviance of the model uniquely explained by space, time, environment or management. 
    
  #Bind results into data.frame
  func_prop.deviance=data.frame(
    diversity=paste(j),
    predictor=c("All","Space","Time","Habitat Structure","No-Take Zones"),
    func_partial_deviance=c(summary(fullmod)$dev.expl,mean(space.dev),mean(time.dev),mean(env.dev),mean(mngt.dev)),
    func_partial_deviance_SE=c(0,std.error(space.dev),std.error(time.dev),std.error(env.dev),std.error(mngt.dev)))
  
  func_model_summary = summary(fullmod)
  
  saveRDS(func_prop.deviance, "func_prop.deviance_rds")
  saveRDS(func_model_summary, "func_model_summary_rds")
}else{
  func_prop.deviance = read_rds("func_prop.deviance_rds")
  func_model_summary = read_rds("func_model_summary_rds")
}
```

```{r bind gam}

setnames(abun_prop.deviance, old=c("Diversity", "Predictor","abun_partial_deviance","abun_partial_deviance.SE"), new=c("Diversity", "Predictor","Partial_Deviance","Partial_Deviance_SE"))

setnames(bio_prop.deviance, old=c("Diversity", "Predictor", "bio_partial_deviance","bio_partial_deviance.SE"), new=c("Diversity", "Predictor","Partial_Deviance","Partial_Deviance_SE"))
 
setnames(even_prop.deviance, old=c("diversity", "predictor", "even_partial_deviance","even_partial_deviance_SE"), new=c("Diversity", "Predictor","Partial_Deviance","Partial_Deviance_SE"))

setnames(richness_prop.deviance, old=c("diversity","predictor","rich_partial_deviance", "rich_partial_deviance_SE"), new=c("Diversity", "Predictor", "Partial_Deviance", "Partial_Deviance_SE"))

setnames(simp_prop.deviance, old=c("diversity","predictor","simp_partial_deviance", "simp_partial_deviance_SE"), new=c("Diversity", "Predictor", "Partial_Deviance", "Partial_Deviance_SE"))

setnames(shan_prop.deviance, old=c("diversity","predictor","shan_partial_deviance", "shan_partial_deviance_SE"), new=c("Diversity", "Predictor", "Partial_Deviance", "Partial_Deviance_SE"))

setnames(func_prop.deviance, old=c("diversity","predictor","func_partial_deviance", "func_partial_deviance_SE"), new=c("Diversity", "Predictor", "Partial_Deviance", "Partial_Deviance_SE"))

partial_deviance_list = rbind(abun_prop.deviance, bio_prop.deviance, even_prop.deviance, richness_prop.deviance, simp_prop.deviance, shan_prop.deviance, func_prop.deviance)

partial_deviance_list = partial_deviance_list %>%
    mutate(Percent_Partial_Deviance = Partial_Deviance*100)

partial_deviance_list$Diversity = car::recode(partial_deviance_list$Diversity, "'abundance_sum'='Abundance'; 'biomass_sum'='Biomass'; 'evenness'='Evenness'; 'richness'='Richness'; 'shannon'='Shannon'; 'simpson'='Simpson';  'func.div'='Functional'")

write_csv(partial_deviance_list, "partial_deviance_list.csv")

partial_deviance_list = read_csv("GAM/partial_deviance_list.csv")

partial_deviance =partial_deviance_list%>%
  select(Diversity,Predictor,Percent_Partial_Deviance)%>%
  spread(Predictor,Percent_Partial_Deviance)

write.csv(partial_deviance, "GAM/partial_deviance_table.csv")

```

```{r deviance barplot}

partial_deviance_list = read_csv("partial_deviance_list.csv")

#partial_deviance_data=subset(partial_deviance_list, Predictor!="All")

diversity_order = c("Abundance", "Biomass", "Evenness","Richness","Shannon", "Simpson", "Functional")

partial_deviance_data= partial_deviance_list %>%
  filter(Predictor != "All") %>%
  mutate(Diversity = factor(Diversity, levels=diversity_order)) 
         
partial_deviance_explained = ggplot(partial_deviance_data,aes(x= Diversity, y= Partial_Deviance*100, fill=Predictor))+
    geom_bar(position="dodge", color="black", stat = "identity")+
    geom_errorbar(aes(max=(Partial_Deviance+Partial_Deviance_SE)*100,
                      min=(Partial_Deviance-Partial_Deviance_SE)*100),
                  width=0.3,size=0.6, position=position_dodge(width=0.9))+
    labs(x="", y="Total Percent \nDeviance Explained")+
    #scale_fill_manual(values=c("grey50","grey80","white"))+
    theme_bw(base_size=18)+
    theme(
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      legend.position="bottom",
      axis.text = element_text(color="black"),
      legend.title=element_blank())

ggsave(file="partial_deviance_explained.pdf", partial_deviance_explained, width=8, height=4, path="plots")

```

#Recalculated Rao's Q with 7 traits 

- Removed each trait from the full matrix and re-calculated Rao's Q 

FD - Maxlength 
```{r FD - Maxlength, eval = F}
knitr::opts_chunk$set(echo = TRUE)

if (!file.exists("func_dist_maxlength_rds")){
 
  trait_matrix = read_csv('species_trait_matrix.csv')
  
  trait_matrix_ml = trait_matrix %>%
    as.tibble() %>%
    mutate(
      SPECIES_CD = toupper(as.character(SPECIES_CD))) %>% 
    arrange(SPECIES_CD)%>% 
    select(SPECIES_CD, Trophic_level, Trophic_group, Water_column, Diel_activity, Substrate_type, Complexity, Gregariousness) %>% #348*9
    group_by(
      SPECIES_CD, Trophic_level, Trophic_group, Water_column, Diel_activity, Substrate_type, Complexity, Gregariousness) %>%
    ungroup() %>%
    mutate(
      # ordinal traits
      Complexity = ordered(Complexity, levels=c("Low","Medium","High")),
      Gregariousness = ordered(Gregariousness, levels=c("1","2","3"))) %>%
    as.data.frame()
  
  #Set species names as row.names and remove extra columns
  rownames(trait_matrix_ml)=trait_matrix_ml$SPECIES_CD 
  
  #Calculate Gower distances. Variables have equal weight. 
  traits.dist.ml = gowdis(trait_matrix_ml, ord="podani")
  
  #Use clustering method to produce ultrametric dendrogram because values of Rao's Q can be maximized when fewer than the max number of functional types are present unless distances are ultramtetric 
  
  #to account for sensitivity in clustering use multiple algorithms  (Mouchet et al., 2008) 
  tree_methods = c("single","complete","average","mcquitty","ward.D") #average is best clustering method 
  trees=lapply(tree_methods,  function(i) hclust(traits.dist.ml, method=i))
 
  #convert trees to ultrametric
  trees.ultra= lapply(trees,function(i) cl_ultrametric(as.hclust(i)))
  
  #Build the consensus tree (Mouchet et al 2008 Oikos)  
  ensemble.trees=cl_ensemble(list=trees) #list of clusterings 
  class(ensemble.trees)
  consensus.tree=cl_consensus(ensemble.trees) #synthesizes the information in the elements of a cluster ensemble into a single clustering 
  par(mar=c(1,1,1,1))
  plot(consensus.tree, horiz=T)
  
  #Calculate dissimilarity values for each tree using 2-norm (Merigot et al 2010 Ecology) to determine which tree best preserves orignial distances 
  #spectral norm (2-norm) of the differences of the ultrametrics
  all.trees=c(trees.ultra,consensus.tree[1])
  names(all.trees)=c(tree_methods,"consensus")
  (trees.dissim=lapply(all.trees,function(i) cl_dissimilarity(i,traits.dist.ml,method="spectral"))) 
  #Cross-dissimilarities using spectral ultrametric distance:
  #Single = 61.99564
  #complete = 103.5836
  #average = 17.10799
  #mcquitty = 27.91702
  #ward.D = 2862.438
  #consensus =  1061.012
  
  #Identify best tree and isolate
  trees.dissim2=do.call(rbind,trees.dissim)
  min.tree=which.min(trees.dissim2) #average 
  names(all.trees)[min.tree]
  func.dist.ml=all.trees[names(all.trees)==names(all.trees)[min.tree]][[1]]
  
  #Confirm lowest 2-norm value,  spectral norm (2-norm) of the differences if the ultrametrics
  cl_dissimilarity(func.dist.ml,traits.dist.ml,method="spectral") #Cross-dissimilarities using spectral ultrametric distance:  17.10799
  
  #Scale by the max value so that all values are between 0-1
  func.dist.ml=func.dist.ml/max(func.dist.ml)
  
  saveRDS(func.dist.ml,"func_dist_maxlength_rds")
} else { #read data 
  func.dist.ml = read_rds("func_dist_maxlength_rds")
} 

#Phylogenetic tree with 348 tips and 347 internal nodes. 
func.dist.phy.maxlength = as.phylo(as.hclust(func.dist.maxlength))

#Write newick tree
write.tree(func.dist.phy.maxlength, "functional_dendrogram_maxlength.nwk")
#write.nexus(func.dist.phy, "functional_diversity/functional_dendrogram.nex") 

```

FD- Trophic level 
```{r FD - Trophic level, eval = F}
knitr::opts_chunk$set(echo = TRUE)

if (!file.exists("func_dist_maxlength_rds")){
 
  trait_matrix_tl = trait_matrix %>%
    as.tibble() %>%
    mutate(
      SPECIES_CD = toupper(as.character(SPECIES_CD))) %>% 
    arrange(SPECIES_CD)%>% 
    select(SPECIES_CD, Maxlength, Trophic_group, Water_column, Diel_activity, Substrate_type, Complexity, Gregariousness) %>% #348*9
    group_by(
      SPECIES_CD, Maxlength,Trophic_group, Water_column, Diel_activity, Substrate_type, Complexity, Gregariousness) %>%
    #summarize(n = n()) %>%
    #select(-n) %>%
    ungroup() %>%
    mutate(
      # ordinal traits
      Complexity = ordered(Complexity, levels=c("Low","Medium","High")),
      Gregariousness = ordered(Gregariousness, levels=c("1","2","3"))) %>%
    as.data.frame()
  
  #Set species names as row.names and remove extra columns
  rownames(trait_matrix_tl)=trait_matrix_tl$SPECIES_CD 
  
  #Calculate Gower distances. Variables have equal weight. 
  traits.dist.tl = gowdis(trait_matrix_tl, ord="podani")
  
  #Use clustering method to produce ultrametric dendrogram because values of Rao's Q can be maximized when fewer than the max number of functional types are present unless distances are ultramtetric 
  
  #to account for sensitivity in clustering use multiple algorithms  (Mouchet et al., 2008) 
  tree_methods = c("single","complete","average","mcquitty","ward.D") #average is best clustering method 
  trees=lapply(tree_methods,  function(i) hclust(traits.dist.tl, method=i))
  #par(mfrow=c(3,2))
  #for(i in 1:length(trees)) {plot(trees[[i]])} #plots the 5 different kinds of trees 
  
  #convert trees to ultrametric
  trees.ultra= lapply(trees,function(i) cl_ultrametric(as.hclust(i)))
  
  #Plot each tree
  #par(mfrow=c(3,2))
  #for (i in 1:length(trees.ultra)) {plot(trees.ultra[[i]])} #plots the 5 different kinds of trees 
  
  #Build the consensus tree (Mouchet et al 2008 Oikos)  
  ensemble.trees=cl_ensemble(list=trees) #list of clusterings 
  class(ensemble.trees)
  consensus.tree=cl_consensus(ensemble.trees) #synthesizes the information in the elements of a cluster ensemble into a single clustering 
  #par(mar=c(1,1,1,1))
  #plot(consensus.tree, horiz=T)
  
  #Calculate dissimilarity values for each tree using 2-norm (Merigot et al 2010 Ecology) to determine which tree best preserves orignial distances 
  #spectral norm (2-norm) of the differences of the ultrametrics
  all.trees=c(trees.ultra,consensus.tree[1])
  names(all.trees)=c(tree_methods,"consensus")
  (trees.dissim=lapply(all.trees,function(i) cl_dissimilarity(i,traits.dist.tl,method="spectral"))) 
  #Cross-dissimilarities using spectral ultrametric distance:

  #Identify best tree and isolate
  trees.dissim2=do.call(rbind,trees.dissim)
  min.tree=which.min(trees.dissim2) #average 
  names(all.trees)[min.tree]
  func.dist.tl=all.trees[names(all.trees)==names(all.trees)[min.tree]][[1]]
  
  #Confirm lowest 2-norm value,  spectral norm (2-norm) of the differences if the ultrametrics 
  cl_dissimilarity(func.dist.tl,traits.dist.tl,method="spectral") #Cross-dissimilarities using spectral ultrametric distance
  
  #Scale by the max value so that all values are between 0-1
  func.dist.tl=func.dist.tl/max(func.dist.tl)
  
  saveRDS(func.dist.tl, "func_dist_tl_rds")
  
} else { #read data 
  func.dist.tl = read_rds("func_dist_tl_rds")
} 

#Phylogenetic tree with 348 tips and 347 internal nodes. 
#func.dist.phy.tl = as.phylo(as.hclust(func.dist.tl))

```

FD - Trophic Group 

```{r FD - Trophic Group, eval = F}
knitr::opts_chunk$set(echo = TRUE)

if (!file.exists("functional_diversity/func_dist_maxlength_rds")){

  trait_matrix_tg = trait_matrix %>%
    as.tibble() %>%
    mutate(
      SPECIES_CD = toupper(as.character(SPECIES_CD))) %>% 
    arrange(SPECIES_CD)%>% 
    select(SPECIES_CD, Maxlength, Trophic_level, Water_column, Diel_activity, Substrate_type, Complexity, Gregariousness) %>% #348*9
    group_by(
      SPECIES_CD, Maxlength, Trophic_level, Water_column, Diel_activity, Substrate_type, Complexity, Gregariousness) %>%
    #summarize(n = n()) %>%
    #select(-n) %>%
    ungroup() %>%
    mutate(
      # ordinal traits
      Complexity = ordered(Complexity, levels=c("Low","Medium","High")),
      Gregariousness = ordered(Gregariousness, levels=c("1","2","3"))) %>%
    as.data.frame()
  
  #Set species names as row.names and remove extra columns
  rownames(trait_matrix_tg)=trait_matrix_tg$SPECIES_CD 
  
  #Calculate Gower distances. Variables have equal weight. 
  traits.dist.tg = gowdis(trait_matrix_tg, ord="podani")
  
  #Use clustering method to produce ultrametric dendrogram because values of Rao's Q can be maximized when fewer than the max number of functional types are present unless distances are ultramtetric 
  
  #to account for sensitivity in clustering use multiple algorithms  (Mouchet et al., 2008) 
  tree_methods = c("single","complete","average","mcquitty","ward.D") #average is best clustering method 
  trees=lapply(tree_methods,  function(i) hclust(traits.dist.tg, method=i))
  #par(mfrow=c(3,2))
  #for(i in 1:length(trees)) {plot(trees[[i]])} #plots the 5 different kinds of trees 
  
  #convert trees to ultrametric
  trees.ultra= lapply(trees,function(i) cl_ultrametric(as.hclust(i)))
  
  #Plot each tree
  #par(mfrow=c(3,2))
  #for (i in 1:length(trees.ultra)) {plot(trees.ultra[[i]])} #plots the 5 different kinds of trees 
  
  #Build the consensus tree (Mouchet et al 2008 Oikos)  
  ensemble.trees=cl_ensemble(list=trees) #list of clusterings 
  class(ensemble.trees)
  consensus.tree=cl_consensus(ensemble.trees) #synthesizes the information in the elements of a cluster ensemble into a single clustering 

  #Calculate dissimilarity values for each tree using 2-norm (Merigot et al 2010 Ecology) to determine which tree best preserves orignial distances 
  #spectral norm (2-norm) of the differences of the ultrametrics
  all.trees=c(trees.ultra,consensus.tree[1])
  names(all.trees)=c(tree_methods,"consensus")
  (trees.dissim=lapply(all.trees,function(i) cl_dissimilarity(i,traits.dist.tg,method="spectral"))) 
  
  #Identify best tree and isolate
  trees.dissim2=do.call(rbind,trees.dissim)
  min.tree=which.min(trees.dissim2) #average 
  names(all.trees)[min.tree]
  func.dist.tg=all.trees[names(all.trees)==names(all.trees)[min.tree]][[1]]
  
  #Confirm lowest 2-norm value,  spectral norm (2-norm) of the differences if the ultrametrics 
  cl_dissimilarity(func.dist.tg,traits.dist.tg,method="spectral") #Cross-dissimilarities using spectral ultrametric distance:  13.80478
  
  #Scale by the max value so that all values are between 0-1
  func.dist.tg=func.dist.tg/max(func.dist.tg)
  
  saveRDS(func.dist.tg, "func_dist_tg_rds")
} else { #read data 
  func.dist.tg = read_rds("func_dist_tg_rds")
} 

#Phylogenetic tree with 348 tips and 347 internal nodes. 
#func.dist.phy.tg = as.phylo(as.hclust(func.dist.tg))
#Write newick tree
#write.tree(func.dist.phy.tg, "functional_dendrogram_tg.nwk")

```

FD - Water column

```{r FD - Water column, eval = F}
knitr::opts_chunk$set(echo = TRUE)

if (!file.exists("func_dist_wc_rds")){
 
  trait_matrix_wc = trait_matrix %>%
    as.tibble() %>%
    mutate(
      SPECIES_CD = toupper(as.character(SPECIES_CD))) %>% 
    arrange(SPECIES_CD)%>% 
    select(SPECIES_CD, Maxlength, Trophic_level, Trophic_group, Diel_activity, Substrate_type, Complexity, Gregariousness) %>% #348*9
    group_by(
      SPECIES_CD, Maxlength, Trophic_level, Trophic_group, Diel_activity, Substrate_type, Complexity, Gregariousness) %>%
    #summarize(n = n()) %>%
    #select(-n) %>%
    ungroup() %>%
    mutate(
      # ordinal traits
      Complexity = ordered(Complexity, levels=c("Low","Medium","High")),
      Gregariousness = ordered(Gregariousness, levels=c("1","2","3"))) %>%
    as.data.frame()
  
  #Set species names as row.names and remove extra columns
  rownames(trait_matrix_wc)=trait_matrix_wc$SPECIES_CD 
  
  #Calculate Gower distances. Variables have equal weight. 
  traits.dist.wc = gowdis(trait_matrix_wc, ord="podani")
  
  #to account for sensitivity in clustering use multiple algorithms  (Mouchet et al., 2008) 
  tree_methods = c("single","complete","average","mcquitty","ward.D") #average is best clustering method 
  trees=lapply(tree_methods,  function(i) hclust(traits.dist.wc, method=i))
  
  #convert trees to ultrametric
  trees.ultra= lapply(trees,function(i) cl_ultrametric(as.hclust(i)))
  
  #Build the consensus tree (Mouchet et al 2008 Oikos)  
  ensemble.trees=cl_ensemble(list=trees) #list of clusterings 
  class(ensemble.trees)
  consensus.tree=cl_consensus(ensemble.trees) #synthesizes the information in the elements of a cluster ensemble into a single clustering 

  #Calculate dissimilarity values for each tree using 2-norm (Merigot et al 2010 Ecology) to determine which tree best preserves orignial distances 
  #spectral norm (2-norm) of the differences of the ultrametrics
  all.trees=c(trees.ultra,consensus.tree[1])
  names(all.trees)=c(tree_methods,"consensus")
  (trees.dissim=lapply(all.trees,function(i) cl_dissimilarity(i,traits.dist.wc,method="spectral"))) 
  
  #Identify best tree and isolate
  trees.dissim2=do.call(rbind,trees.dissim)
  min.tree=which.min(trees.dissim2) #average 
  names(all.trees)[min.tree]
  func.dist.wc=all.trees[names(all.trees)==names(all.trees)[min.tree]][[1]]
  
  #Confirm lowest 2-norm value,  spectral norm (2-norm) of the differences if the ultrametrics
  cl_dissimilarity(func.dist.wc,traits.dist.wc,method="spectral") #Cross-dissimilarities using spectral ultrametric distance:  
  
  #Scale by the max value so that all values are between 0-1
  func.dist.wc=func.dist.wc/max(func.dist.wc)
  
  saveRDS(func.dist.wc, "func_dist_wc_rds")
} else { #read data 
  func.dist.wc = read_rds("func_dist_maxlength_rds")
} 

```

FD - Diel activity

```{r FD - Diel activity, eval = F}
knitr::opts_chunk$set(echo = TRUE)

if (!file.exists("func_dist_da_rds")){

  trait_matrix_da = trait_matrix %>%
    as.tibble() %>%
    mutate(
      SPECIES_CD = toupper(as.character(SPECIES_CD))) %>% 
    arrange(SPECIES_CD)%>% 
    select(SPECIES_CD, Maxlength, Trophic_level, Trophic_group, Water_column, Substrate_type, Complexity, Gregariousness) %>% #348*9
    group_by(
      SPECIES_CD, Maxlength, Trophic_level, Trophic_group, Water_column, Substrate_type, Complexity, Gregariousness) %>%
    #summarize(n = n()) %>%
    #select(-n) %>%
    ungroup() %>%
    mutate(
      # ordinal traits
      Complexity = ordered(Complexity, levels=c("Low","Medium","High")),
      Gregariousness = ordered(Gregariousness, levels=c("1","2","3"))) %>%
    as.data.frame()
  
  #Set species names as row.names and remove extra columns
  rownames(trait_matrix_da)=trait_matrix_da$SPECIES_CD 
  
  #Calculate Gower distances. Variables have equal weight. 
  traits.dist.da = gowdis(trait_matrix_da, ord="podani")
  
  #Use clustering method to produce ultrametric dendrogram because values of Rao's Q can be maximized when fewer than the max number of functional types are present unless distances are ultramtetric 
  
  #to account for sensitivity in clustering use multiple algorithms  (Mouchet et al., 2008) 
  tree_methods = c("single","complete","average","mcquitty","ward.D") #average is best clustering method 
  trees=lapply(tree_methods,  function(i) hclust(traits.dist.da, method=i))

  #convert trees to ultrametric
  trees.ultra= lapply(trees,function(i) cl_ultrametric(as.hclust(i)))
  
  #Build the consensus tree (Mouchet et al 2008 Oikos)  
  ensemble.trees=cl_ensemble(list=trees) #list of clusterings 
  class(ensemble.trees)
  consensus.tree=cl_consensus(ensemble.trees) #synthesizes the information in the elements of a cluster ensemble into a single clustering 

  #Calculate dissimilarity values for each tree using 2-norm (Merigot et al 2010 Ecology) to determine which tree best preserves orignial distances 
  #spectral norm (2-norm) of the differences of the ultrametrics
  all.trees=c(trees.ultra,consensus.tree[1])
  names(all.trees)=c(tree_methods,"consensus")
  (trees.dissim=lapply(all.trees,function(i) cl_dissimilarity(i,traits.dist.da,method="spectral"))) 

  #Identify best tree and isolate
  trees.dissim2=do.call(rbind,trees.dissim)
  min.tree=which.min(trees.dissim2) #average 
  names(all.trees)[min.tree]
  func.dist.da=all.trees[names(all.trees)==names(all.trees)[min.tree]][[1]]
  
  #Confirm lowest 2-norm value,  spectral norm (2-norm) of the differences if the ultrametrics 
  cl_dissimilarity(func.dist.da,traits.dist.da,method="spectral") #Cross-dissimilarities using spectral ultrametric distance:  
  
  #Scale by the max value so that all values are between 0-1
  func.dist.da=func.dist.da/max(func.dist.da)
  
  saveRDS(func.dist.da, "func_dist_da_rds")
} else { #read data 
  func.dist.da = read_rds("func_dist_da_rds")
} 

```

FD - Substrate type

```{r FD - Substrate type, eval = F}
knitr::opts_chunk$set(echo = TRUE)

if (!file.exists("func_dist_st_rds")){
 
  trait_matrix_st = trait_matrix %>%
    as.tibble() %>%
    mutate(
      SPECIES_CD = toupper(as.character(SPECIES_CD))) %>% 
    arrange(SPECIES_CD)%>% 
    select(SPECIES_CD, Maxlength, Trophic_level, Trophic_group, Water_column, Diel_activity, Complexity, Gregariousness) %>% #348*9
    group_by(
      SPECIES_CD, Maxlength, Trophic_level, Trophic_group, Water_column, Diel_activity, Complexity, Gregariousness) %>%
    #summarize(n = n()) %>%
    #select(-n) %>%
    ungroup() %>%
    mutate(
      # ordinal traits
      Complexity = ordered(Complexity, levels=c("Low","Medium","High")),
      Gregariousness = ordered(Gregariousness, levels=c("1","2","3"))) %>%
    as.data.frame()
  
  #Set species names as row.names and remove extra columns
  rownames(trait_matrix_st)=trait_matrix_st$SPECIES_CD 
  
  #Calculate Gower distances. Variables have equal weight. 
  traits.dist.st = gowdis(trait_matrix_st, ord="podani")
  
  #Use clustering method to produce ultrametric dendrogram because values of Rao's Q can be maximized when fewer than the max number of functional types are present unless distances are ultramtetric 
  
  #to account for sensitivity in clustering use multiple algorithms  (Mouchet et al., 2008) 
  tree_methods = c("single","complete","average","mcquitty","ward.D") #average is best clustering method 
  trees=lapply(tree_methods,  function(i) hclust(traits.dist.st, method=i))

  #convert trees to ultrametric
  trees.ultra= lapply(trees,function(i) cl_ultrametric(as.hclust(i)))

  #Build the consensus tree (Mouchet et al 2008 Oikos)  
  ensemble.trees=cl_ensemble(list=trees) #list of clusterings 
  consensus.tree=cl_consensus(ensemble.trees) #synthesizes the information in the elements of a cluster ensemble into a single clustering 
  #par(mar=c(1,1,1,1))
  #plot(consensus.tree, horiz=T)
  
  #Calculate dissimilarity values for each tree using 2-norm (Merigot et al 2010 Ecology) to determine which tree best preserves orignial distances 
  #spectral norm (2-norm) of the differences of the ultrametrics
  all.trees=c(trees.ultra,consensus.tree[1])
  names(all.trees)=c(tree_methods,"consensus")
  (trees.dissim=lapply(all.trees,function(i) cl_dissimilarity(i,traits.dist.st,method="spectral"))) 

  #Identify best tree and isolate
  trees.dissim2=do.call(rbind,trees.dissim)
  min.tree=which.min(trees.dissim2) #average 
  names(all.trees)[min.tree]
  func.dist.st=all.trees[names(all.trees)==names(all.trees)[min.tree]][[1]]
  
  #Confirm lowest 2-norm value,  spectral norm (2-norm) of the differences if the ultrametrics
  cl_dissimilarity(func.dist.st,traits.dist.da,method="spectral") 
  
  #Scale by the max value so that all values are between 0-1
  func.dist.st=func.dist.st/max(func.dist.st)
  
  saveRDS(func.dist.st, "func_dist_st_rds")
} else { #read data 
  func.dist.st = read_rds("func_dist_st_rds")
} 

```

FD - Complexity

```{r FD - Complexity, eval = F}
knitr::opts_chunk$set(echo = TRUE)

if (!file.exists("func_dist_comp_rds")){
  
  trait_matrix_comp = trait_matrix %>%
    as.tibble() %>%
    mutate(
      SPECIES_CD = toupper(as.character(SPECIES_CD))) %>% 
    arrange(SPECIES_CD)%>% 
    select(SPECIES_CD, Maxlength, Trophic_level, Trophic_group, Water_column, Diel_activity, Substrate_type, Gregariousness) %>% #348*9
    group_by(
      SPECIES_CD, Maxlength, Trophic_level, Trophic_group, Water_column, Diel_activity, Substrate_type, Gregariousness) %>%
    #summarize(n = n()) %>%
    #select(-n) %>%
    ungroup() %>%
    mutate(
      # ordinal traits
      Gregariousness = ordered(Gregariousness, levels=c("1","2","3"))) %>%
    as.data.frame()
  
  #Set species names as row.names and remove extra columns
  rownames(trait_matrix_comp)=trait_matrix_comp$SPECIES_CD 
  
  #Calculate Gower distances. Variables have equal weight. 
  traits.dist.comp = gowdis(trait_matrix_comp, ord="podani")
  
  #Use clustering method to produce ultrametric dendrogram because values of Rao's Q can be maximized when fewer than the max number of functional types are present unless distances are ultramtetric 
  
  #to account for sensitivity in clustering use multiple algorithms  (Mouchet et al., 2008) 
  tree_methods = c("single","complete","average","mcquitty","ward.D") #average is best clustering method 
  trees=lapply(tree_methods,  function(i) hclust(traits.dist.comp, method=i))

  #convert trees to ultrametric
  trees.ultra= lapply(trees,function(i) cl_ultrametric(as.hclust(i)))
  
  #Build the consensus tree (Mouchet et al 2008 Oikos)  
  ensemble.trees=cl_ensemble(list=trees) #list of clusterings 
  class(ensemble.trees)
  consensus.tree=cl_consensus(ensemble.trees) #synthesizes the information in the elements of a cluster ensemble into a single clustering 

  #Calculate dissimilarity values for each tree using 2-norm (Merigot et al 2010 Ecology) to determine which tree best preserves orignial distances 
  #spectral norm (2-norm) of the differences of the ultrametrics
  all.trees=c(trees.ultra,consensus.tree[1])
  names(all.trees)=c(tree_methods,"consensus")
  (trees.dissim=lapply(all.trees,function(i) cl_dissimilarity(i,traits.dist.comp,method="spectral"))) 

  #Identify best tree and isolate
  trees.dissim2=do.call(rbind,trees.dissim)
  min.tree=which.min(trees.dissim2) #average 
  names(all.trees)[min.tree]
  func.dist.comp=all.trees[names(all.trees)==names(all.trees)[min.tree]][[1]]
  
  #Confirm lowest 2-norm value,  spectral norm (2-norm) of the differences if the ultrametrics 
  cl_dissimilarity(func.dist.comp,traits.dist.comp,method="spectral") 
  
  #Scale by the max value so that all values are between 0-1
  func.dist.comp=func.dist.comp/max(func.dist.comp)
  
  saveRDS(func.dist.comp, "func_dist_comp_rds")
} else { #read data 
  func.dist.comp = read_rds("func_dist_comp_rds")
} 

```

FD - Gregariousness

```{r FD - Gregariousness, eval = F}
knitr::opts_chunk$set(echo = TRUE)

if (!file.exists("func_dist_greg_rds")){
 
  trait_matrix_greg = trait_matrix %>%
    as.tibble() %>%
    mutate(
      SPECIES_CD = toupper(as.character(SPECIES_CD))) %>% 
    arrange(SPECIES_CD)%>% 
    select(SPECIES_CD, Maxlength, Trophic_level, Trophic_group, Water_column, Diel_activity, Substrate_type, Complexity) %>% #348*9
    group_by(
      SPECIES_CD, Maxlength, Trophic_level, Trophic_group, Water_column, Diel_activity,Substrate_type, Complexity) %>%
    #summarize(n = n()) %>%
    #select(-n) %>%
    ungroup() %>%
    mutate(
      # ordinal traits
      Complexity = ordered(Complexity, levels=c("Low","Medium","High"))) %>%
    as.data.frame()
  
  #Set species names as row.names and remove extra columns
  rownames(trait_matrix_greg)=trait_matrix_greg$SPECIES_CD 
  
  #Calculate Gower distances. Variables have equal weight. 
  traits.dist.greg = gowdis(trait_matrix_greg, ord="podani")
  
  #Use clustering method to produce ultrametric dendrogram because values of Rao's Q can be maximized when fewer than the max number of functional types are present unless distances are ultramtetric 
  
  #to account for sensitivity in clustering use multiple algorithms  (Mouchet et al., 2008) 
  tree_methods = c("single","complete","average","mcquitty","ward.D") #average is best clustering method 
  trees=lapply(tree_methods,  function(i) hclust(traits.dist.greg, method=i))

  #convert trees to ultrametric
  trees.ultra= lapply(trees,function(i) cl_ultrametric(as.hclust(i)))
  
  #Build the consensus tree (Mouchet et al 2008 Oikos)  
  ensemble.trees=cl_ensemble(list=trees) #list of clusterings 
  consensus.tree=cl_consensus(ensemble.trees) #synthesizes the information in the elements of a cluster ensemble into a single clustering 

  #Calculate dissimilarity values for each tree using 2-norm (Merigot et al 2010 Ecology) to determine which tree best preserves orignial distances 
  #spectral norm (2-norm) of the differences of the ultrametrics
  all.trees=c(trees.ultra,consensus.tree[1])
  names(all.trees)=c(tree_methods,"consensus")
  (trees.dissim=lapply(all.trees,function(i) cl_dissimilarity(i,traits.dist.greg,method="spectral"))) 

  #Identify best tree and isolate
  trees.dissim2=do.call(rbind,trees.dissim)
  min.tree=which.min(trees.dissim2) #average 
  names(all.trees)[min.tree]
  func.dist.greg=all.trees[names(all.trees)==names(all.trees)[min.tree]][[1]]
  
  #Confirm lowest 2-norm value,  spectral norm (2-norm) of the differences if the ultrametrics
  cl_dissimilarity(func.dist.greg,traits.dist.greg,method="spectral") #Cross-dissimilarities using spectral ultrametric distance:  17.47219
  
  #Scale by the max value so that all values are between 0-1
  func.dist.greg=func.dist.greg/max(func.dist.greg)
  
  saveRDS(func.dist.greg, "func_dist_greg_rds")
} else { #read data 
  func.dist.greg = read_rds("func_dist_greg_rds")
} 

```

Rao's Q 

```{r Rao Q}

if(!file.exists("raoQ_list.csv")){
  
  func.dist = read_rds("functional_distance_rds")
  func.dist.ml = read_rds("functional_diversity/func_dist_maxlength_rds")
  func.dist.tl = read_rds("functional_diversity/func_dist_tl_rds")
  func.dist.tg = read_rds("functional_diversity/func_dist_tg_rds")
  func.dist.wc = read_rds("functional_diversity/func_dist_wc_rds")
  func.dist.da = read_rds("functional_diversity/func_dist_da_rds")
  func.dist.st = read_rds("functional_diversity/func_dist_st_rds")
  func.dist.comp = read_rds("functional_diversity/func_dist_comp_rds")
  func.dist.greg = read_rds("functional_diversity/func_dist_greg_rds")
  
  #read in trait matrix 
  traits = read.csv('species_trait_matrix.csv')
  #Set rownames on traits and remove other info
  rownames(traits) <- traits$SPECIES_CD
  traits <- traits[, -c(1:4)]
  #Convert rownames to all caps
  rownames(traits) <- toupper(rownames(traits))
  
  sample_data = read_rds("sample_data_rds")
  #remove PSU-'s with 1 species [2006,602U INPR] [2016,  1010U, INPR] AND removed 2001 PSU 222U HRRF abundance 5X greater than normal (50,114 species)
    sample_data = sample_data[!(sample_data$YEAR == "2006" & 
                                sample_data$PRIMARY_SAMPLE_UNIT == "602U" | #only 1 species
                                sample_data$YEAR == "2016" & 
                                sample_data$PRIMARY_SAMPLE_UNIT == "1010U"| #only 1 species 
                                sample_data$YEAR == "2002" &
                                sample_data$PRIMARY_SAMPLE_UNIT =="472U"  | #one large school sp.
                                sample_data$YEAR == "2003" &
                                sample_data$PRIMARY_SAMPLE_UNIT =="119U"  | #one large school sp. 
                                sample_data$YEAR == "2004" &
                                sample_data$PRIMARY_SAMPLE_UNIT =="403U"  | #one large school sp.
                                sample_data$YEAR == "2001" & 
                                sample_data$PRIMARY_SAMPLE_UNIT =="222U"),]
  #dim(sample_data) 5235   22

  #remove species not identified in species level and protected status all
  psu_fk_abun_no_spp = psu_fk_abun %>%
    filter(!stringr::str_detect(SPECIES_CD, 'SPE\\.$')) %>%
    filter(stringr::str_detect(protected_status, 'all')) 
    #dim(psu_fk_abun_no_spp) #1,689,982      10
  
  #remove PSU-'s with 1 species [2006,602U INPR] [2016,  1010U, INPR] AND removed 2001 PSU 222U HRRF abundance 5X greater than normal (50,114 species)
  psu_abun_sum = psu_fk_abun_no_spp[!(
    psu_fk_abun_no_spp$YEAR == "2006" & psu_fk_abun_no_spp$PRIMARY_SAMPLE_UNIT == "602U" |
      psu_fk_abun_no_spp$YEAR == "2002" & psu_fk_abun_no_spp$PRIMARY_SAMPLE_UNIT == "472U" |
      psu_fk_abun_no_spp$YEAR == "2004" & psu_fk_abun_no_spp$PRIMARY_SAMPLE_UNIT =="403U"  |
      psu_fk_abun_no_spp$YEAR == "2016" & psu_fk_abun_no_spp$PRIMARY_SAMPLE_UNIT == "1010U" |
      psu_fk_abun_no_spp$YEAR == "2003" & psu_fk_abun_no_spp$PRIMARY_SAMPLE_UNIT == "119U" |
      psu_fk_abun_no_spp$YEAR == "2001" & psu_fk_abun_no_spp$PRIMARY_SAMPLE_UNIT == "222U"),] 
  #dim(psu_abun_sum) # 1688053x10

  abund = psu_abun_sum %>% 
    select(YEAR, PRIMARY_SAMPLE_UNIT, PROT, SPECIES_CD, abundance)
  #1,689,070 * 6
  
  # Cast abundance longways (species as columns)
  abundmat <- spread(abund, SPECIES_CD, abundance, fill = 0)
  #dim(abundmat) #5235  351
  
  # What is up with these species not being in the trait matrix??
  checkthese <- colnames(abundmat)[!colnames(abundmat) %in% rownames(traits)]
  
  # Subset species whose names only appear in traits
  abundmat <- abundmat[colnames(abundmat) %in% rownames(traits)] 
  #dim(abundmat) #5,235    108
  
  # Drop communities with no species (roughly 500 sites)
  abundmat <- abundmat[!rowSums(abundmat) == 0,] 
  #dim(abundmat) #5,235x108
  abundmat <- abundmat[!rowSums(abundmat) == 1,]
  #dim(abundmat) #5,235x108
  
  #Calculate relative values for community matrix
  rel.mat=abundmat/apply(abundmat,1,sum)
  
  #Ensure that all evenness calculations are not >1 (bug)
  func.div=1/(1-apply(rel.mat,1,function(x) t(x) %*% as.matrix(func.dist) %*% x))
  func.div.ml=1/(1-apply(rel.mat,1,function(x) t(x) %*% as.matrix(func.dist.ml) %*% x))
  func.div.tl=1/(1-apply(rel.mat,1,function(x) t(x) %*% as.matrix(func.dist.tl) %*% x))
  func.div.tg=1/(1-apply(rel.mat,1,function(x) t(x) %*% as.matrix(func.dist.tg) %*% x))
  func.div.wc=1/(1-apply(rel.mat,1,function(x) t(x) %*% as.matrix(func.dist.wc) %*% x))
  func.div.da=1/(1-apply(rel.mat,1,function(x) t(x) %*% as.matrix(func.dist.da) %*% x))
  func.div.st=1/(1-apply(rel.mat,1,function(x) t(x) %*% as.matrix(func.dist.st) %*% x))
  func.div.comp=1/(1-apply(rel.mat,1,function(x) t(x) %*% as.matrix(func.dist.comp) %*% x))
  func.div.greg=1/(1-apply(rel.mat,1,function(x) t(x) %*% as.matrix(func.dist.greg) %*% x))
  
  #Bind all to the original dataframe (need to remove psu with 1 species detected)
  raoQ_list = cbind(sample_data,func.div,func.div.ml,func.div.tl,func.div.tg,func.div.wc,func.div.da,func.div.st,func.div.comp,func.div.greg)
  
  raoQ_list = raoQ_list %>%
    select(PRIMARY_SAMPLE_UNIT, YEAR, STRAT, PROT,func.div,func.div,func.div.ml,func.div.tl,func.div.tg,func.div.wc,func.div.da,func.div.st,func.div.comp,func.div.greg) %>%
    group_by(YEAR,PRIMARY_SAMPLE_UNIT)
  
  write_csv(raoQ_list,"raoQ_list.csv")
  
} {else
  raoQ_list = read_csv("raoQ_list.csv")
}

```

Contributions of each trait to functional diversity. 
- traits that contributed more to FD, when dropped from the matrix, will have a lower R^2 values. 

```{r FD linear regression}

raoQ_list = read_csv("raoQ_list.csv")

# minus max length 
linear_ml = lm(func.div.ml~func.div, data = raoQ_list)
summary(linear_ml)
#R-squared:  0.996 
#p-value: < 2.2e-16

# minus trophic level 
linear_tl = lm(func.div.tl~func.div, data = raoQ_list)
summary(linear_tl)
#R-squared:  0.9323

# minus trophic group 
linear_tg = lm(func.div.tg~func.div, data = raoQ_list)
summary(linear_tg)
#R-squared:  0.8359

# minus water column position 
linear_wc = lm(func.div.wc~func.div, data = raoQ_list)
summary(linear_wc)
#R-squared: 0.7641

# minus substrate type 
linear_st = lm(func.div.st~func.div, data = raoQ_list)
summary(linear_st)
#R-squared: 0.9206

# minus diel activity 
linear_da = lm(func.div.da~func.div, data = raoQ_list)
summary(linear_da)
#R-squared: 0.6491 

# minus habitat complexity 
linear_hc = lm(func.div.comp~func.div, data = raoQ_list)
summary(linear_hc)
#R-squared: 0.9995

# minus gregariousness 
linear_greg = lm(func.div.greg~func.div, data = raoQ_list)
summary(linear_greg)
#R-squared: 0.8919 

```

```{r numbers}

all_matrices_data = read_csv("diversity_data.csv") #5235 x 18 

hrrf_samples = all_matrices_data %>%
  filter(STRAT_GROUPED == "HIGH_RELIEF")
length(hrrf_samples$PRIMARY_SAMPLE_UNIT) #733 samples
#(733/5235)*100 = 14% sampling events in HRRF strata

hrrf_prot_samples = all_matrices_data %>%
  filter(PROT != "0")%>% #1,392
  filter(STRAT_GROUPED == "HIGH_RELIEF")
length(hrrf_prot_samples$PRIMARY_SAMPLE_UNIT) #430 samples
#(430/1392)*100 = 31% of protected samples in HRRF

linear_samples = all_matrices_data %>%
  filter(STRAT_GROUPED == "LINEAR_REEF")
length(linear_samples$PRIMARY_SAMPLE_UNIT) #3033 samples
#(3033/5235)*100 = 58% sampling events in Linear reef strata

linear_prot_samples = all_matrices_data %>%
  filter(PROT != "0")%>% #1,392
  filter(STRAT_GROUPED == "LINEAR_REEF")
length(linear_prot_samples$PRIMARY_SAMPLE_UNIT) #713 samples
#(713/1392)*100 = 51% protected samples in linear reef 

patch_samples = all_matrices_data %>%
  filter(STRAT_GROUPED == "PATCH_REEF")
length(patch_samples$PRIMARY_SAMPLE_UNIT) #1469 samples
#(1469/5235)*100 = 28% sampling events in patch reef strata

patch_prot_samples = all_matrices_data %>%
  filter(PROT != "0")%>% #1,392
  filter(STRAT_GROUPED == "PATCH_REEF")
length(patch_prot_samples$PRIMARY_SAMPLE_UNIT) #249 samples
#(249/1392)*100 = 18% protected samples in patch reef 

trait_matrix = read_csv('species_trait_matrix.csv')

hrrf_species = trait_matrix %>%
  #filter(Complexity == "High") #5
  #filter(Complexity == "Medium") #68
  #filter(Complexity == "Low") #35
length(hrrf_species$SPECIES_CD) 

#68% of species prefer medium-high habitat complexity 

species_abundance = read_csv("percent_species_abundance.csv")

spabundance = species_abundance%>% #108 
  select(-X1)%>% 
  filter(percent < 1) #86 species with less than 1% abundance 
  #filter(percent < 2) #95 species with less than 2% abundance 
  #filter(percent <3) #100 species with less than 3% abundace 

#Bicolor Damselfish,Bluehead, Masked Goby, Tomtate
#12.44+11.62+10.27+6.27 = 40.6%
#Four species of reef fish account for 41% of abundance data across years

#... + White Grunt, Striped Parrotfish, Slippery Dick, Yellowtail Snapper,
#12.44+11.62+10.27+6.27+4.83+4.45+3.66+3.20 = 57%
#Six species of reef fish account for 57% of abundance data across years

#... + Redband Parrotfish, French Grunt 
#12.44+11.62+10.27+6.27+4.83+4.45+3.66+3.20+2.67+2.54 = 62%
#Ten species of reef fish account for 62% of abundance data across years

neon_goby = species_abundance %>%
  filter(Common_name == "Neon Goby") #abundance 0.23%

```